<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.553">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>KAIST MFE, 2025 Spring - 코스피200 변동성 조정 위클리 양매도 전략</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./장외파생1.html" rel="next">
<link href="./사례1.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./사례1.html">사례로 보는 금융공학(’25 봄)</a></li><li class="breadcrumb-item"><a href="./사례_과제.html">코스피200 변동성 조정 위클리 양매도 전략</a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">KAIST MFE, 2025 Spring</a> 
        <div class="sidebar-tools-main">
    <a href="./KAIST-MFE,-2025-Spring.pdf" title="Download PDF" class="quarto-navigation-tool px-1" aria-label="Download PDF"><i class="bi bi-file-pdf"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Welcome!</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">머신러닝2(’25 봄)</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./빅데이터1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">빅데이터와 금융자료 분석 CH1</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./빅데이터_과제.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">빅데이터와 금융자료 분석 기말대체과제</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./빅데이터_팀프로젝트_팀4_보고서.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">빅데이터와 금융자료분석 프로젝트 (Team 4)</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
 <span class="menu-text">알고리즘 거래전략(’25 봄)</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./알고리즘1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">알고리즘 거래전략과 고빈도 금융</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
 <span class="menu-text">사례로 보는 금융공학(’25 봄)</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./사례1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">사례로 보는 금융공학 실무</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./사례_과제.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">코스피200 변동성 조정 위클리 양매도 전략</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">
 <span class="menu-text">장외파생상품 기초 실무(’25 봄)</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./장외파생1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">장외파생상품 기초 실무</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true">
 <span class="menu-text">금융윤리와 사회책임(’25 봄)</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./금융윤리1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">금융윤리와 사회책임</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#개요" id="toc-개요" class="nav-link active" data-scroll-target="#개요">1. 개요</a></li>
  <li><a href="#배경지식" id="toc-배경지식" class="nav-link" data-scroll-target="#배경지식">2. 배경지식</a>
  <ul class="collapse">
  <li><a href="#양매도-short-strangle" id="toc-양매도-short-strangle" class="nav-link" data-scroll-target="#양매도-short-strangle">양매도 (Short strangle)</a></li>
  <li><a href="#코스피200-변동성지수-v-kospi200-index" id="toc-코스피200-변동성지수-v-kospi200-index" class="nav-link" data-scroll-target="#코스피200-변동성지수-v-kospi200-index">코스피200 변동성지수 (V-Kospi200 index)</a></li>
  <li><a href="#코스피200-위클리옵션" id="toc-코스피200-위클리옵션" class="nav-link" data-scroll-target="#코스피200-위클리옵션">코스피200 위클리옵션</a></li>
  </ul></li>
  <li><a href="#전략-소개-및-구현" id="toc-전략-소개-및-구현" class="nav-link" data-scroll-target="#전략-소개-및-구현">3. 전략 소개 및 구현</a>
  <ul class="collapse">
  <li><a href="#전략-개요" id="toc-전략-개요" class="nav-link" data-scroll-target="#전략-개요">전략 개요</a></li>
  <li><a href="#행사가격-범위-설정방법" id="toc-행사가격-범위-설정방법" class="nav-link" data-scroll-target="#행사가격-범위-설정방법">행사가격 범위 설정방법</a></li>
  <li><a href="#포트폴리오-구성-방법" id="toc-포트폴리오-구성-방법" class="nav-link" data-scroll-target="#포트폴리오-구성-방법">포트폴리오 구성 방법</a></li>
  </ul></li>
  <li><a href="#backtesting" id="toc-backtesting" class="nav-link" data-scroll-target="#backtesting">3. Backtesting</a>
  <ul class="collapse">
  <li><a href="#데이터-수집-및-전처리-포트폴리오-구현" id="toc-데이터-수집-및-전처리-포트폴리오-구현" class="nav-link" data-scroll-target="#데이터-수집-및-전처리-포트폴리오-구현">데이터 수집 및 전처리, 포트폴리오 구현</a></li>
  <li><a href="#backtesting-성과" id="toc-backtesting-성과" class="nav-link" data-scroll-target="#backtesting-성과">Backtesting 성과</a></li>
  <li><a href="#한계점" id="toc-한계점" class="nav-link" data-scroll-target="#한계점">한계점</a></li>
  </ul></li>
  <li><a href="#포트폴리오-검증-25.3.13-4.10" id="toc-포트폴리오-검증-25.3.13-4.10" class="nav-link" data-scroll-target="#포트폴리오-검증-25.3.13-4.10">4. 포트폴리오 검증 (’25.3.13 ~ 4.10)</a></li>
  <li><a href="#appendix-python-r-code" id="toc-appendix-python-r-code" class="nav-link" data-scroll-target="#appendix-python-r-code">5. Appendix : Python, R code</a>
  <ul class="collapse">
  <li><a href="#pyhon-code-데이터-수집-및-전처리" id="toc-pyhon-code-데이터-수집-및-전처리" class="nav-link" data-scroll-target="#pyhon-code-데이터-수집-및-전처리">Pyhon code : 데이터 수집 및 전처리</a></li>
  <li><a href="#r-code-1-데이터-가공-backtesting" id="toc-r-code-1-데이터-가공-backtesting" class="nav-link" data-scroll-target="#r-code-1-데이터-가공-backtesting">R code 1 : 데이터 가공, Backtesting</a></li>
  <li><a href="#r-code-2-전략-검증" id="toc-r-code-2-전략-검증" class="nav-link" data-scroll-target="#r-code-2-전략-검증">R code 2 : 전략 검증</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./사례1.html">사례로 보는 금융공학(’25 봄)</a></li><li class="breadcrumb-item"><a href="./사례_과제.html">코스피200 변동성 조정 위클리 양매도 전략</a></li></ol></nav>
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">코스피200 변동성 조정 위클리 양매도 전략</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>25년도 봄학기 금융공학 특수논제 &lt;사례로 보는 금융공학 실무&gt; A조</p>
<p><strong>김경재(20259048) / 강상묵(20259013) / 김형환(20249132) / 어환석(20259248) / 유수형(20259273)</strong></p>
<section id="개요" class="level2">
<h2 class="anchored" data-anchor-id="개요">1. 개요</h2>
<p>본 리포트는 옵션과 변동성지수를 활용한 <strong>변동성 조정 위클리 양매도</strong>전략을 알아보고, <strong>과거 데이터를 통해 구현 및 검증</strong>하기 위해 작성되었습니다. <strong>변동성 조정 위클리 양매도</strong>란 <strong><em>1.변동성 조정</em></strong>, <strong><em>2.주단위 매도</em></strong> 두가지 특징을 통해 <strong>기존 단점을 보완</strong>한 양매도 전략으로, “매주” V-Kospi200를 이용해 행사가격 범위를 결정하고 콜/풋옵션을 매도(양매도)하게 됩니다.</p>
<p>전략 소개에 앞서 필요한 배경지식을 다루고, 전략 소개 및 구현, 백테스팅 및 성과를 차례로 설명하겠습니다.</p>
</section>
<section id="배경지식" class="level2">
<h2 class="anchored" data-anchor-id="배경지식">2. 배경지식</h2>
<section id="양매도-short-strangle" class="level3">
<h3 class="anchored" data-anchor-id="양매도-short-strangle">양매도 (Short strangle)</h3>
<p><strong>양매도란 옵션 거래전략</strong>으로, 일반적으로 <strong>만기일이 같은 외가격(OTM) 콜/풋옵션을 매도</strong>하는 것을 의미합니다.</p>
<p>OTM 옵션을 매도하므로, 만기일에 기초자산의 가격이 풋옵션의 행사가격과 콜옵션의 행사가격 사이라면 권리행사되지 않게 되고 <strong>옵션 프리미엄(매도수익)을 그대로 얻을 수 있게 됩니다.</strong></p>
<p>반면, <strong>양매도는 시장의 변동성이 예상과 달리 큰 경우, 큰 손실이 발생할 수 있다는 단점</strong>도 존재합니다. <strong>수익은 프리미엄으로 한정</strong>되어있으나, 시황 급변에 따른 <strong>옵션 손실에는 제한이 없어</strong> 원금 이상의 손실이 발생할 수도 있기 때문입니다.</p>
<p>즉, 양매도는 높은 확률로 <strong>안정적인 중수익을 보장하나 매우 낮은 확률로 큰 손실이 발생할 수 있는 전략</strong>이며, <strong>향후 시장의 변동성이 크지 않을 것이라 예측될 때 주로 사용</strong>됩니다.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="image/shortstrangle.png" class="quarto-figure quarto-figure-center figure-img" style="width:150mm;height:50mm"></p>
</figure>
</div>
<section id="양매도-전략-예시" class="level4">
<h4 class="anchored" data-anchor-id="양매도-전략-예시">양매도 전략 예시</h4>
<p>국내의 경우 행사가격의 상하단을 등가격(ATM) <span class="math inline">\(\pm\)</span> 5%로 설정한 양매도 ETN이 한 때 큰 인기를 끌었습니다. 대표적인 예시인 <strong>월별 코스피200 OTM 5% 양매도 전략</strong>의 거래방법을 살펴보면, 다음과 같습니다.</p>
<ol type="1">
<li>현재 코스피200지수를 기준으로 ATM+5%의 콜옵션과 ATM-5%의 풋옵션을 매도 (프리미엄 수익 발생)</li>
<li>다음달 만기일이 되면, 옵션은 청산(권리행사시 손실)되고 다시 ATM <span class="math inline">\(\pm\)</span> 5%의 콜,풋옵션을 매도</li>
</ol>
<p>즉, <strong>월단위로 옵션을 교체하게 되며 행사가격의 상하단은 ATM</strong> <span class="math inline">\(\pm\)</span> 5%로 고정한 양매도 전략입니다. 중위험-중수익으로 흥행에 성공한 상품이지만, <strong>아래와 같은 한계점</strong>도 존재합니다.</p>
<ol type="1">
<li>행사가격 범위가 고정되어있어 변동성 확대시 손실 가능성이 커지고, 변동성 축소시 프리미엄 수익이 크게 감소</li>
<li>옵션 교체주기가 1개월로, 그간 지수의 하락이 누적된다면 손실이 과도하게 커질 수 있음 (유동성 리스크)</li>
</ol>
</section>
</section>
<section id="코스피200-변동성지수-v-kospi200-index" class="level3">
<h3 class="anchored" data-anchor-id="코스피200-변동성지수-v-kospi200-index">코스피200 변동성지수 (V-Kospi200 index)</h3>
<p><strong>코스피200 변동성 지수</strong>란 주식 시장의 <strong>변동성을 측정하는 지표</strong>입니다. 코스피200 옵션 가격 기반의 내재변동성을 이용하여 산출되며, 향후 30일간 시장 변동성에 대한 투자자들의 기대를 나타내는 지수입니다.</p>
<section id="주요-특징" class="level4">
<h4 class="anchored" data-anchor-id="주요-특징">주요 특징</h4>
<ul>
<li><strong>시장 심리 반영</strong>: 투자자들의 불안 심리를 반영하며, ’공포 지수(Fear Index)’라고도 불림</li>
<li><strong>옵션 가격 기반</strong>: 코스피200 옵션 가격 기반의 내재변동성을 통해 산출되며, 여기에는 투자자들의 기대가 반영</li>
</ul>
<p><strong><em>그래프1 : 일별 코스피200지수 및 코스피200 변동성지수</em></strong></p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="image/vkospi.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:70.0%"></p>
</figure>
</div>
</section>
</section>
<section id="코스피200-위클리옵션" class="level3">
<h3 class="anchored" data-anchor-id="코스피200-위클리옵션">코스피200 위클리옵션</h3>
<p><strong>코스피200 위클리옵션</strong>이란 코스피200 지수를 기초자산으로 하는 <strong>주간 단위의 옵션 거래 상품</strong>을 말합니다. ’19년 상장되었으며 기존의 월 단위 만기가 도래하는 옵션과는 달리, 매주 월/목요일에 만기가 도래하는 단기 옵션입니다.</p>
<section id="주요-특징-1" class="level4">
<h4 class="anchored" data-anchor-id="주요-특징-1">주요 특징</h4>
<ul>
<li><strong>세밀한 거래 지원</strong>: 매주 월/목요일에 만기가 도래하여 단기적인 시장 변동에 대한 투자 및 위험 관리에 유리</li>
<li><strong>다양한 투자 전략 활용:</strong> 단기적인 시장 예측을 기반으로 다양한 투자 전략을 구사할 수 있습니다.</li>
</ul>
</section>
</section>
</section>
<section id="전략-소개-및-구현" class="level2">
<h2 class="anchored" data-anchor-id="전략-소개-및-구현">3. 전략 소개 및 구현</h2>
<section id="전략-개요" class="level3">
<h3 class="anchored" data-anchor-id="전략-개요">전략 개요</h3>
<p>변동성 조정 위클리 양매도(Volatility Adjusted Weekly Short strangle, VWss) 전략이란, 기존에 널리 활용되던 <strong>월별 OTM 5% 양매도 전략</strong>에 아래 두가지 방법을 결합한 전략을 의미합니다.</p>
<ol type="1">
<li>옵션의 교체주기를 “매월” -&gt; “매주” 단위로 세분화</li>
<li>행사가격의 범위를 고정하는 것이 아니라 매 옵션 매도시점마다 시장 변동성을 고려하여 조정</li>
</ol>
<p>따라서, 기존과 달리 <strong>주단위로 옵션을 교체하며, 행사가격의 범위는 교체시점에 매번 달라지게 됩니다.</strong> 이를 위해 코스피200위클리옵션<strong>을 사용하고, 변동성 지표는</strong> 내재변동성 기반의 V-Kospi200지수를 사용**하여 구현할 계획입니다.</p>
</section>
<section id="행사가격-범위-설정방법" class="level3">
<h3 class="anchored" data-anchor-id="행사가격-범위-설정방법">행사가격 범위 설정방법</h3>
<p>행사가격의 상하단은 <strong>옵션 매도시점의 “전일 V-Kospi200 종가”를 참조하여 설정</strong>할 예정입니다. V-Kospi200는 향후 30일간 코스피200 지수의 변동성을 수치화한 지표로서, 현재시점에서 변동성을 잘 예측할 수 있는 수단이기 때문입니다.</p>
<p>다만, 본 전략에서 옵션 매도포지션의 유지기간은 약 7일이므로 지수 종가(연율)를 주단위 기간에 맞도록 환산하여 행사가격의 상하단을 산출하였습니다.</p>
<p><span class="math display">\[\sigma_{Target}\;=\;\frac{VKospi200_{(T-1)}\times\sqrt{Calendar\;days}}{\sqrt{365}}\]</span></p>
<p><span class="math display">\[Call\;strike\;=\;Kospi200_{(T)}\times (1+\sigma_{Target})\;rounded\;up\;to\;2.5pt\]</span></p>
<p><span class="math display">\[Put\;strike\;=\;Kospi200_{(T)}\times (1-\sigma_{Target})\;rounded\;down\;to\;2.5pt\]</span></p>
<p>이렇게 행사가격을 설정하면 V-Kospi200가 15pt일 때 월환산 변동성이 약 5%(주환산 2.5%)가 됩니다. 즉,</p>
<ul>
<li>시장의 예상 변동성(V-Kospi200)이 연 15% 이상 -&gt; 행사가격 범위를 기존보다 넓게 설정하여 손실 가능성 축소</li>
<li>시장의 예상 변동성이 연 15% 미만 -&gt; 행사가격 범위를 기존보다 좁게 설정하여 프리미엄 수익 극대화</li>
</ul>
<div class="callout callout-style-simple callout-none no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p>본 전략은 위클리옵션을 사용하므로 향후 1주일 변동성이 필요합니다. 따라서, 30일 변동성을 나타내는 V-Kospi200은 만기 mismatch가 있지만, 단기간의 예측치에는 큰 차이가 없고 이외의 대안(e.g.&nbsp;7-day VIX)이 없어 V-Kospi200를 그대로 사용하였습니다.</p>
</div>
</div>
</div>
</section>
<section id="포트폴리오-구성-방법" class="level3">
<h3 class="anchored" data-anchor-id="포트폴리오-구성-방법">포트폴리오 구성 방법</h3>
<p>먼저, 편의를 위해 세금/수수료/호가스프레드 등의 거래비용은 없으며 종가에 원하는 수량만큼 거래할 수 있는 <strong>완전자본시장을 가정</strong>하도록 하겠습니다. 전략 구현을 위한 포트폴리오(투자원금 100억원) 구성 과정은 아래와 같습니다.</p>
<ol type="1">
<li>전일 V-Kospi200 지수를 주단위로 환산하여 예상변동성(<span class="math inline">\(\hat\sigma=(VKospi200\times \sqrt{day})/\sqrt{365}\)</span>) 산출</li>
<li>예상변동성을 당일 Kospi200지수에 적용하여 행사가격 상하단(ATM <span class="math inline">\(\pm\hat\sigma\)</span>을 2.5pt 단위로 올림/내림) 산출</li>
<li>당일 Kospi200지수 및 승수(25만)를 적용, 옵션 매도수량(<span class="math inline">\(Q_{sell}=nominal/(kospi200\times multiplier)\)</span>) 산출</li>
<li>행사가격 상단 콜옵션, 하단 풋옵션 매도 (<span class="math inline">\(Premium=(call price+put price)\times Q_{sell}\times multiplier\)</span>)</li>
<li>원금과 매도수익을 다음주 만기일까지 MMF에 투자 (<span class="math inline">\(Interest=(nominal+Premium)\times MMF \times \frac{day}{365}\)</span>)</li>
<li>다음주 만기일이 되면, 권리행사 손실을 포함하여 최종손익 산출(<span class="math inline">\(Revenue=Premium+Interest-Exercise\)</span>)
<ul>
<li>Kospi200 &gt; 행사가격 상단, 콜옵션에서 손실 발생(<span class="math inline">\(Exercise=(Kospi200-Strike_{call})\times multiplier\)</span>)</li>
<li>Kospi200 &lt; 행사가격 하단, 풋옵션에서 손실 발생(<span class="math inline">\(Exercise=(Strike_{put}-Kospi200)\times multiplier\)</span>)</li>
<li>이외의 경우, 권리행사되지 않아 옵션 포지션 청산(<span class="math inline">\(Exercise=0\)</span>)</li>
</ul></li>
<li>주간 최종손익을 정산(<span class="math inline">\(nominal_{new}=nominal_{old}+Revenue\)</span>)하고, 투자종료시점까지 1. ~ 6. 과정을 반복</li>
</ol>
</section>
</section>
<section id="backtesting" class="level2">
<h2 class="anchored" data-anchor-id="backtesting">3. Backtesting</h2>
<section id="데이터-수집-및-전처리-포트폴리오-구현" class="level3">
<h3 class="anchored" data-anchor-id="데이터-수집-및-전처리-포트폴리오-구현">데이터 수집 및 전처리, 포트폴리오 구현</h3>
<p>과거 5개년(2020~2024) 코스피200 등의 지수/옵션 가격, 금리를 수집하였으며, 출처는 아래와 같습니다.</p>
<pre><code>한국거래소 정보데이터시스템(data.krx.co.kr) : 코스피200 및 V-Kospi200지수
한국거래소 OpenAPI(openapi.krx.co.kr) : 코스피200옵션 및 위클리옵션 종목별 가격
한국은행 경제통계시스템(ecos.bok.or.kr) : 일별 MMF(7일) 금리</code></pre>
<div class="callout callout-style-default callout-note callout-titled" title="한국거래소 OpenAPI를 활용한 데이터 수집 예시">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
한국거래소 OpenAPI를 활용한 데이터 수집 예시
</div>
</div>
<div class="callout-body-container callout-body">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="image/krxopenapi1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:60.0%"></p>
</figure>
</div>
<p>API 호출시 json 데이터를 수집할 수 있으며, 이를 Dataframe(python) 및 tibble(r)로 변환하여 활용하였습니다.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> requests<span class="op">;</span> <span class="im">import</span> json</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>url <span class="op">=</span> <span class="st">'http://data-dbg.krx.co.kr/svc/sample/apis/drv/opt_bydd_trd?basDd=20250312'</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>headers <span class="op">=</span> {<span class="st">'AUTH_KEY'</span>: <span class="st">'74D1B99DFBF345BBA3FB4476510A4BED4C78D13A'</span>}</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>res <span class="op">=</span> requests.get(url<span class="op">=</span>url, headers<span class="op">=</span>headers)<span class="op">;</span> res.text</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>'{"OutBlock_1":[{"BAS_DD":"20250312","PROD_NM":"코스피200 옵션","RGHT_TP_NM":"CALL","ISU_CD":"201W3195","ISU_NM":"코스피200 C 202503 195.0","TDD_CLSPRC":"145.90","CMPPREVDD_PRC":"6.85","TDD_OPNPRC":"144.95","TDD_HGPRC":"146.10","TDD_LWPRC":"144.95","IMP_VOLT":"64.00","NXTDD_BAS_PRC":"145.90","ACC_TRDVOL":"31","ACC_TRDVAL":"1129625000","ACC_OPNINT_QTY":"154"},{"BAS_DD":"20250312","PROD_NM":"코스피200 옵션","RGHT_TP_NM":"CALL","ISU_CD":"201W3197","ISU_NM":"코스피200 C 202503 197.5","TDD_CLSPRC":"-","CMPPREVDD_PRC":"-","TDD_OPNPRC":"-","TDD_HGPRC":"-","TDD_LWPRC":"-","IMP_VOLT":"64.00","NXTDD_BAS_PRC":"143.40","ACC_TRDVOL":"0","ACC_TRDVAL":"0","ACC_OPNINT_QTY":"0"},{"BAS_DD":"20250312","PROD_NM":"코스피200 옵션","RGHT_TP_NM":"CALL","ISU_CD":"201W3200","ISU_NM":"코스피200 C 202503 200.0","TDD_CLSPRC":"140.60","CMPPREVDD_PRC":"5.00","TDD_OPNPRC":"140.00","TDD_HGPRC":"141.15","TDD_LWPRC":"139.95","IMP_VOLT":"64.00","NXTDD_BAS_PRC":"140.60","ACC_TRDVOL":"31","ACC_TRDVAL":"1088750000","ACC_OPNINT_QTY":"290"},{"BAS_DD":"20250312","PROD_NM":"코스피200 옵션","RGHT_TP_NM":"CALL","ISU_CD":"201W3202","ISU_NM":"코스피200 C 202503 202.5","TDD_CLSPRC":"-","CMPPREVDD_PRC":"-","TDD_OPNPRC":"-","TDD_HGPRC":"-","TDD_LWPRC":"-","IMP_VOLT":"64.00","NXTDD_BAS_PRC":"138.40","ACC_TRDVOL":"0","ACC_TRDVAL":"0","ACC_OPNINT_QTY":"0"},{"BAS_DD":"20250312","PROD_NM":"코스피200 옵션","RGHT_TP_NM":"CALL","ISU_CD":"201W3205","ISU_NM":"코스피200 C 202503 205.0","TDD_CLSPRC":"-","CMPPREVDD_PRC":"-","TDD_OPNPRC":"-","TDD_HGPRC":"-","TDD_LWPRC":"-","IMP_VOLT":"64.00","NXTDD_BAS_PRC":"135.90","ACC_TRDVOL":"0","ACC_TRDVAL":"0","ACC_OPNINT_QTY":"0"},{"BAS_DD":"20250312","PROD_NM":"코스피200 옵션","RGHT_TP_NM":"CALL","ISU_CD":"201W3207","ISU_NM":"코스피200 C 202503 207.5","TDD_CLSPRC":"-","CMPPREVDD_PRC":"-","TDD_OPNPRC":"-","TDD_HGPRC":"-","TDD_LWPRC":"-","IMP_VOLT":"64.00","NXTDD_BAS_PRC":"133.40","ACC_TRDVOL":"0","ACC_TRDVAL":"0","ACC_OPNINT_QTY":"0"},{"BAS_DD":"20250312","PROD_NM":"코스피200 옵션","RGHT_TP_NM":"CALL","ISU_CD":"201W3210","ISU_NM":"코스피200 C 202503 210.0","TDD_CLSPRC":"130.60","CMPPREVDD_PRC":"5.60","TDD_OPNPRC":"130.60","TDD_HGPRC":"130.60","TDD_LWPRC":"130.60","IMP_VOLT":"64.00","NXTDD_BAS_PRC":"130.60","ACC_TRDVOL":"1","ACC_TRDVAL":"32650000","ACC_OPNINT_QTY":"20"},{"BAS_DD":"20250312","PROD_NM":"코스피200 옵션","RGHT_TP_NM":"CALL","ISU_CD":"201W3212","ISU_NM":"코스피200 C 202503 212.5","TDD_CLSPRC":"-","CMPPREVDD_PRC":"-","TDD_OPNPRC":"-","TDD_HGPRC":"-","TDD_LWPRC":"-","IMP_VOLT":"62.47","NXTDD_BAS_PRC":"128.40","ACC_TRDVOL":"0","ACC_TRDVAL":"0","ACC_OPNINT_QTY":"0"},{"BAS_DD":"20250312","PROD_NM":"코스피200 옵션","RGHT_TP_NM":"CALL","ISU_CD":"201W3215","ISU_NM":"코스피200 C 202503 215.0","TDD_CLSPRC":"-","CMPPREVDD_PRC":"-","TDD_OPNPRC":"-","TDD_HGPRC":"-","TDD_LWPRC":"-","IMP_VOLT":"60.94","NXTDD_BAS_PRC":"125.90","ACC_TRDVOL":"0","ACC_TRDVAL":"0","ACC_OPNINT_QTY":"59"},{"BAS_DD":"20250312","PROD_NM":"코스피200 옵션","RGHT_TP_NM":"CALL","ISU_CD":"201W3217","ISU_NM":"코스피200 C 202503 217.5","TDD_CLSPRC":"-","CMPPREVDD_PRC":"-","TDD_OPNPRC":"-","TDD_HGPRC":"-","TDD_LWPRC":"-","IMP_VOLT":"59.42","NXTDD_BAS_PRC":"123.40","ACC_TRDVOL":"0","ACC_TRDVAL":"0","ACC_OPNINT_QTY":"0"}]}'</code></pre>
</div>
</div>
</div>
</div>
<p>수집한 데이터는 <strong>R을 이용하여 전처리</strong>하였으며, 두개의 데이터셋으로 요약하였습니다.</p>
<ol type="1">
<li><strong>포트폴리오 기본 정보</strong> : 옵션 만기일(매주), 옵션 보유일, MMF금리, Kospi200, 전일 V-K200, 거래대상옵션 정보</li>
</ol>
<div class="cell">
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<colgroup>
<col style="width: 10%">
<col style="width: 12%">
<col style="width: 10%">
<col style="width: 8%">
<col style="width: 10%">
<col style="width: 12%">
<col style="width: 7%">
<col style="width: 13%">
<col style="width: 13%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: right;">BAS_DD</th>
<th style="text-align: right;">VOL</th>
<th style="text-align: right;">DIFF_DAY</th>
<th style="text-align: right;">MMF</th>
<th style="text-align: right;">KOSPI200</th>
<th style="text-align: right;">LAG_VK200</th>
<th style="text-align: right;">PRIOR</th>
<th style="text-align: right;">TARGET_C_K</th>
<th style="text-align: right;">TARGET_P_K</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">20241219</td>
<td style="text-align: right;">0.0248719</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">0.0334</td>
<td style="text-align: right;">322.38</td>
<td style="text-align: right;">17.96</td>
<td style="text-align: right;">24124</td>
<td style="text-align: right;">332.5</td>
<td style="text-align: right;">312.5</td>
</tr>
<tr class="even">
<td style="text-align: right;">20241212</td>
<td style="text-align: right;">0.0285279</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">0.0335</td>
<td style="text-align: right;">329.04</td>
<td style="text-align: right;">20.60</td>
<td style="text-align: right;">24123</td>
<td style="text-align: right;">340.0</td>
<td style="text-align: right;">317.5</td>
</tr>
<tr class="odd">
<td style="text-align: right;">20241205</td>
<td style="text-align: right;">0.0295527</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">0.0341</td>
<td style="text-align: right;">323.87</td>
<td style="text-align: right;">21.34</td>
<td style="text-align: right;">24122</td>
<td style="text-align: right;">335.0</td>
<td style="text-align: right;">312.5</td>
</tr>
<tr class="even">
<td style="text-align: right;">20241128</td>
<td style="text-align: right;">0.0252043</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">0.0340</td>
<td style="text-align: right;">331.45</td>
<td style="text-align: right;">18.20</td>
<td style="text-align: right;">24121</td>
<td style="text-align: right;">340.0</td>
<td style="text-align: right;">322.5</td>
</tr>
<tr class="odd">
<td style="text-align: right;">20241121</td>
<td style="text-align: right;">0.0276001</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">0.0344</td>
<td style="text-align: right;">329.49</td>
<td style="text-align: right;">19.93</td>
<td style="text-align: right;">24114</td>
<td style="text-align: right;">340.0</td>
<td style="text-align: right;">320.0</td>
</tr>
<tr class="even">
<td style="text-align: right;">20241114</td>
<td style="text-align: right;">0.0344274</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">0.0340</td>
<td style="text-align: right;">317.70</td>
<td style="text-align: right;">24.86</td>
<td style="text-align: right;">24113</td>
<td style="text-align: right;">330.0</td>
<td style="text-align: right;">305.0</td>
</tr>
</tbody>
</table>
</div>
</div>
<ol start="2" type="1">
<li><strong>거래대상옵션 정보</strong> : 포트폴리오 기본 정보에 대응되는 거래대상옵션의 종가, 거래량(0인 경우 제외)</li>
</ol>
<div class="cell">
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<colgroup>
<col style="width: 10%">
<col style="width: 19%">
<col style="width: 19%">
<col style="width: 25%">
<col style="width: 25%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: right;">BAS_DD</th>
<th style="text-align: right;">PRICE_TARGET_C_K</th>
<th style="text-align: right;">PRICE_TARGET_P_K</th>
<th style="text-align: right;">ACC_TRDVOL_TARGET_C_K</th>
<th style="text-align: right;">ACC_TRDVOL_TARGET_P_K</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">20241219</td>
<td style="text-align: right;">0.29</td>
<td style="text-align: right;">0.74</td>
<td style="text-align: right;">343</td>
<td style="text-align: right;">137</td>
</tr>
<tr class="even">
<td style="text-align: right;">20241212</td>
<td style="text-align: right;">0.42</td>
<td style="text-align: right;">0.78</td>
<td style="text-align: right;">190</td>
<td style="text-align: right;">196</td>
</tr>
<tr class="odd">
<td style="text-align: right;">20241205</td>
<td style="text-align: right;">0.44</td>
<td style="text-align: right;">0.91</td>
<td style="text-align: right;">65452</td>
<td style="text-align: right;">51417</td>
</tr>
<tr class="even">
<td style="text-align: right;">20241128</td>
<td style="text-align: right;">0.34</td>
<td style="text-align: right;">0.43</td>
<td style="text-align: right;">288</td>
<td style="text-align: right;">201</td>
</tr>
<tr class="odd">
<td style="text-align: right;">20241121</td>
<td style="text-align: right;">0.37</td>
<td style="text-align: right;">0.53</td>
<td style="text-align: right;">115</td>
<td style="text-align: right;">201</td>
</tr>
<tr class="even">
<td style="text-align: right;">20241114</td>
<td style="text-align: right;">0.43</td>
<td style="text-align: right;">0.74</td>
<td style="text-align: right;">329</td>
<td style="text-align: right;">165</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>이를 통해 매도수량, 프리미엄, 이자수익, 권리행사손실 등을 산출하여 <strong>포트폴리오를 구현</strong>하였습니다.</p>
<div class="cell">
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<colgroup>
<col style="width: 11%">
<col style="width: 12%">
<col style="width: 11%">
<col style="width: 11%">
<col style="width: 11%">
<col style="width: 12%">
<col style="width: 14%">
<col style="width: 14%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: right;">BAS_DD</th>
<th style="text-align: right;">VOL</th>
<th style="text-align: right;">SELL_AMT</th>
<th style="text-align: right;">PREMIUM</th>
<th style="text-align: right;">INTEREST</th>
<th style="text-align: right;">EXERCISE</th>
<th style="text-align: right;">REVENUE</th>
<th style="text-align: right;">RATE</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">20200102</td>
<td style="text-align: right;">0.0203434</td>
<td style="text-align: right;">137.7648</td>
<td style="text-align: right;">29963837</td>
<td style="text-align: right;">2789154</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">32752991</td>
<td style="text-align: right;">0.0032753</td>
</tr>
<tr class="even">
<td style="text-align: right;">20200109</td>
<td style="text-align: right;">0.0221160</td>
<td style="text-align: right;">135.8650</td>
<td style="text-align: right;">20040080</td>
<td style="text-align: right;">2844044</td>
<td style="text-align: right;">9510547</td>
<td style="text-align: right;">13373578</td>
<td style="text-align: right;">0.0013374</td>
</tr>
<tr class="odd">
<td style="text-align: right;">20200116</td>
<td style="text-align: right;">0.0185154</td>
<td style="text-align: right;">132.1091</td>
<td style="text-align: right;">18825550</td>
<td style="text-align: right;">2824485</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">21650035</td>
<td style="text-align: right;">0.0021650</td>
</tr>
<tr class="even">
<td style="text-align: right;">20200123</td>
<td style="text-align: right;">0.0197895</td>
<td style="text-align: right;">132.3058</td>
<td style="text-align: right;">23815037</td>
<td style="text-align: right;">2787444</td>
<td style="text-align: right;">219296795</td>
<td style="text-align: right;">-192694314</td>
<td style="text-align: right;">-0.0192694</td>
</tr>
<tr class="odd">
<td style="text-align: right;">20200130</td>
<td style="text-align: right;">0.0235286</td>
<td style="text-align: right;">138.7107</td>
<td style="text-align: right;">45080972</td>
<td style="text-align: right;">2793358</td>
<td style="text-align: right;">109234664</td>
<td style="text-align: right;">-61360333</td>
<td style="text-align: right;">-0.0061360</td>
</tr>
<tr class="even">
<td style="text-align: right;">20200206</td>
<td style="text-align: right;">0.0252458</td>
<td style="text-align: right;">133.0451</td>
<td style="text-align: right;">46565774</td>
<td style="text-align: right;">2774504</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">49340278</td>
<td style="text-align: right;">0.0049340</td>
</tr>
</tbody>
</table>
</div>
</div>
<div style="page-break-after: always;"></div>
<div class="callout callout-style-default callout-important callout-titled" title="변동성 조정 방법에 따른 행사가격 범위 추이(과거 5년)">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
변동성 조정 방법에 따른 행사가격 범위 추이(과거 5년)
</div>
</div>
<div class="callout-body-container callout-body">
<p>V-Kospi200과 연동한 행사가격의 범위는 지난 5년간 <strong>1.6% ~ 8.7%까지 광범위하게 형성</strong>되었습니다.</p>
<p>코스피200이 급등락하는 경우 범위가 넓게 형성되고 보합장에서는 좁게 형성되는 추이를 확인할 수 있으며, 이를 월환산(<span class="math inline">\(\times\sqrt{4}\)</span>)하여 기존 5%와 비교하면 <strong>지수의 상황에 따라 유동적으로 조절되고 있음</strong>을 의미합니다.</p>
<p><br>
</p>
<p><strong><em>그래프2 : 월평균 코스피200지수(적색) 및 행사가격 범위(청색)</em></strong></p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="사례_과제_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
<div style="page-break-after: always;"></div>
</section>
<section id="backtesting-성과" class="level3">
<h3 class="anchored" data-anchor-id="backtesting-성과">Backtesting 성과</h3>
<p><strong>지난 5년간(2020~2024) VW양매도와 코스피200지수 / OTM 5% 양매도를 비교</strong>해보았습니다.</p>
<p><strong><em>표1 : 연도별 변동성 조정 위클리 양매도 포트폴리오 및 코스피200지수 성과</em></strong></p>
<div class="cell">
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<colgroup>
<col style="width: 6%">
<col style="width: 9%">
<col style="width: 15%">
<col style="width: 11%">
<col style="width: 12%">
<col style="width: 6%">
<col style="width: 11%">
<col style="width: 9%">
<col style="width: 16%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">YEAR</th>
<th style="text-align: right;">Expiry</th>
<th style="text-align: right;">NoExercise</th>
<th style="text-align: right;">Premium</th>
<th style="text-align: right;">Interest</th>
<th style="text-align: right;">Loss</th>
<th style="text-align: right;">Revenue</th>
<th style="text-align: right;">Return</th>
<th style="text-align: right;">Return_K200</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">2020</td>
<td style="text-align: right;">50</td>
<td style="text-align: right;">0.74</td>
<td style="text-align: right;">4385</td>
<td style="text-align: right;">184</td>
<td style="text-align: right;">5338</td>
<td style="text-align: right;">-769</td>
<td style="text-align: right;">-0.04</td>
<td style="text-align: right;">0.33</td>
</tr>
<tr class="even">
<td style="text-align: left;">2021</td>
<td style="text-align: right;">47</td>
<td style="text-align: right;">0.91</td>
<td style="text-align: right;">2974</td>
<td style="text-align: right;">142</td>
<td style="text-align: right;">728</td>
<td style="text-align: right;">2387</td>
<td style="text-align: right;">0.12</td>
<td style="text-align: right;">0.01</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2022</td>
<td style="text-align: right;">52</td>
<td style="text-align: right;">0.79</td>
<td style="text-align: right;">3304</td>
<td style="text-align: right;">421</td>
<td style="text-align: right;">4152</td>
<td style="text-align: right;">-427</td>
<td style="text-align: right;">-0.03</td>
<td style="text-align: right;">-0.26</td>
</tr>
<tr class="even">
<td style="text-align: left;">2023</td>
<td style="text-align: right;">52</td>
<td style="text-align: right;">0.81</td>
<td style="text-align: right;">2456</td>
<td style="text-align: right;">732</td>
<td style="text-align: right;">1758</td>
<td style="text-align: right;">1430</td>
<td style="text-align: right;">0.08</td>
<td style="text-align: right;">0.23</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2024</td>
<td style="text-align: right;">49</td>
<td style="text-align: right;">0.80</td>
<td style="text-align: right;">3697</td>
<td style="text-align: right;">719</td>
<td style="text-align: right;">3454</td>
<td style="text-align: right;">962</td>
<td style="text-align: right;">0.05</td>
<td style="text-align: right;">-0.11</td>
</tr>
</tbody>
</table>
</div>
</div>
<p><strong><em>표2 : 연도별 일반 양매도 포트폴리오 및 코스피200지수 성과</em></strong></p>
<div class="cell">
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<colgroup>
<col style="width: 6%">
<col style="width: 9%">
<col style="width: 15%">
<col style="width: 10%">
<col style="width: 12%">
<col style="width: 8%">
<col style="width: 10%">
<col style="width: 9%">
<col style="width: 16%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">YEAR</th>
<th style="text-align: right;">Expiry</th>
<th style="text-align: right;">NoExercise</th>
<th style="text-align: right;">Premium</th>
<th style="text-align: right;">Interest</th>
<th style="text-align: right;">Loss</th>
<th style="text-align: right;">Revenue</th>
<th style="text-align: right;">Return</th>
<th style="text-align: right;">Return_K200</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">2020</td>
<td style="text-align: right;">12</td>
<td style="text-align: right;">0.58</td>
<td style="text-align: right;">16507</td>
<td style="text-align: right;">847</td>
<td style="text-align: right;">37851</td>
<td style="text-align: right;">-20497</td>
<td style="text-align: right;">-0.23</td>
<td style="text-align: right;">0.33</td>
</tr>
<tr class="even">
<td style="text-align: left;">2021</td>
<td style="text-align: right;">12</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">9887</td>
<td style="text-align: right;">605</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">10492</td>
<td style="text-align: right;">0.13</td>
<td style="text-align: right;">0.01</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2022</td>
<td style="text-align: right;">12</td>
<td style="text-align: right;">0.50</td>
<td style="text-align: right;">10207</td>
<td style="text-align: right;">1819</td>
<td style="text-align: right;">15098</td>
<td style="text-align: right;">-3071</td>
<td style="text-align: right;">-0.04</td>
<td style="text-align: right;">-0.26</td>
</tr>
<tr class="even">
<td style="text-align: left;">2023</td>
<td style="text-align: right;">12</td>
<td style="text-align: right;">0.83</td>
<td style="text-align: right;">4591</td>
<td style="text-align: right;">3176</td>
<td style="text-align: right;">884</td>
<td style="text-align: right;">6883</td>
<td style="text-align: right;">0.09</td>
<td style="text-align: right;">0.23</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2024</td>
<td style="text-align: right;">12</td>
<td style="text-align: right;">0.75</td>
<td style="text-align: right;">9850</td>
<td style="text-align: right;">3072</td>
<td style="text-align: right;">9589</td>
<td style="text-align: right;">3333</td>
<td style="text-align: right;">0.04</td>
<td style="text-align: right;">-0.11</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="callout callout-style-simple callout-none no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p><strong>YEAR</strong> : 산출대상 연도 / <strong>Expiry</strong> : 옵션만기 횟수 (프리미엄 수익 발생 횟수)</p>
<p><strong>NoExercise</strong> : 옵션만기일에 행사되지 않은 비율 (손실이 발생하지 않은 거래일 비율)</p>
<p><strong>Premium</strong> : 평균 옵션 프리미엄 수익 (만원) / <strong>Interest</strong> : 원금 및 프리미엄에서 발생한 평균 이자수익 (만원)</p>
<p><strong>Loss</strong> : 옵션권리행사로 인한 평균 손실 (미행사 포함) / <strong>Revenue</strong> : 평균 이익 (Premium + Interest - Loss)</p>
<p><strong>Return</strong> : 포트폴리오의 연환산 수익률 / <strong>Return_K200</strong> : 코스피200지수의 연환산 수익률</p>
</div>
</div>
</div>
<p><strong>변동성 조정 위클리 양매도 포트폴리오</strong>의 주요 성과는 다음과 같습니다.</p>
<ol type="1">
<li>옵션 매도주기 축소(월간 <span class="math inline">\(\rightarrow\)</span> 주간) : <strong>현금흐름 개선 및 프리미엄 수익 극대화</strong></li>
</ol>
<ul>
<li>VW양매도 포트폴리오는 연평균 50회의 수익이 발생하는 반면, 일반 양매도 포트폴리오는 12회(월1회) 발생.</li>
<li>1회 발생 수익은 4배 미만으로 감소하여 평균 수익이 증가하였고, 수익주기가 짧아지면서 현금유동성 개선</li>
</ul>
<ol start="2" type="1">
<li>행사가격 범위 조정(5% <span class="math inline">\(\rightarrow\)</span> <span class="math inline">\(\sigma\)</span>연동) : <strong>포트폴리오 안정성 증가 및 리스크 축소</strong></li>
</ol>
<ul>
<li>일반 양매도 전략의 손실발생비율(권리행사비율)은 시장 상황에 따라 0~50%까지 큰 폭으로 변동</li>
<li>반면, 본 포트폴리오는 행사가격 범위를 변동성 수준에 조정하므로 비율이 10~30%수준으로 안정화</li>
<li>손실에 대한 예측가능성 및 포트폴리오 변동성이 개선되었으며 1회 손실도 감내 가능한 수준으로 축소</li>
</ul>
<ol start="3" type="1">
<li><strong>소결 : VW양매도 전략은 수익률, 리스크 측면에서 코스피200지수 및 일반 양매도 전략을 Outperform</strong></li>
</ol>
<div style="page-break-after: always;"></div>
<p><strong><em>그래프3, 4 : 지난 5년 및 3년간 코스피200지수, VW양매도, 5%양매도 누적수익률 및 초과수익</em></strong></p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="사례_과제_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="사례_과제_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><strong><em>표3 : 연도별 VW양매도, 일반 양매도, 코스피200지수의 수익률 및 변동성(월간수익률의 연환산)</em></strong></p>
<div class="cell">
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<colgroup>
<col style="width: 7%">
<col style="width: 18%">
<col style="width: 16%">
<col style="width: 18%">
<col style="width: 13%">
<col style="width: 12%">
<col style="width: 13%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">YEAR</th>
<th style="text-align: right;">Return_main</th>
<th style="text-align: right;">Return_sub</th>
<th style="text-align: right;">Return_K200</th>
<th style="text-align: right;">Vol_main</th>
<th style="text-align: right;">Vol_sub</th>
<th style="text-align: right;">Vol_K200</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">2020</td>
<td style="text-align: right;">-0.04</td>
<td style="text-align: right;">-0.23</td>
<td style="text-align: right;">0.33</td>
<td style="text-align: right;">0.08</td>
<td style="text-align: right;">0.19</td>
<td style="text-align: right;">0.27</td>
</tr>
<tr class="even">
<td style="text-align: left;">2021</td>
<td style="text-align: right;">0.12</td>
<td style="text-align: right;">0.13</td>
<td style="text-align: right;">0.01</td>
<td style="text-align: right;">0.03</td>
<td style="text-align: right;">0.02</td>
<td style="text-align: right;">0.11</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2022</td>
<td style="text-align: right;">-0.03</td>
<td style="text-align: right;">-0.04</td>
<td style="text-align: right;">-0.26</td>
<td style="text-align: right;">0.08</td>
<td style="text-align: right;">0.08</td>
<td style="text-align: right;">0.25</td>
</tr>
<tr class="even">
<td style="text-align: left;">2023</td>
<td style="text-align: right;">0.08</td>
<td style="text-align: right;">0.09</td>
<td style="text-align: right;">0.23</td>
<td style="text-align: right;">0.04</td>
<td style="text-align: right;">0.01</td>
<td style="text-align: right;">0.17</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2024</td>
<td style="text-align: right;">0.05</td>
<td style="text-align: right;">0.04</td>
<td style="text-align: right;">-0.11</td>
<td style="text-align: right;">0.07</td>
<td style="text-align: right;">0.08</td>
<td style="text-align: right;">0.16</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>그래프와 표를 통해 <strong>VW양매도 전략</strong>이 타 전략 대비 <strong>안정적이고 높은 수익을 실현</strong>하였음을 확인할 수 있었습니다.</p>
</section>
<section id="한계점" class="level3">
<h3 class="anchored" data-anchor-id="한계점">한계점</h3>
<p>그러나, <strong>행사가격 범위가 전일 V-Kospi200 지수에 따라 결정</strong>되므로 옵션 매도일 및 보유기간 중 V-Kospi200 지수가 급등락하는 경우 <strong>시장 변동성을 적절히 반영되지 않을 가능성</strong>이 있습니다.</p>
<ul>
<li>당일 장중 지수를 사용할 수 있겠으나 종가보다 신뢰성이 높다고 보기 어렵고, 당일 종가는 매도시점에서 확인 불가</li>
<li>보유기간 중 V-Kospi200의 변동에 따라 옵션 행사가격을 리밸런싱하면 보다 정확히 변동성을 반영할 수 있으나, 잦은 거래로 인해 수반되는 비용이 급증</li>
<li>시장 변동성이 적절히 반영되지 않는 경우, 프리미엄 수익성이 낮아지고 옵션 권리행사 위험이 증가할 수 있음</li>
</ul>
<p>또한, <strong>실제로 VW양매도 포트폴리오를 운영</strong>한다면 <strong>거래비용 및 유동성 등의 한계점</strong>으로 인해 보완해야할 점이 있으며 이 과정에서 초과수익률 등의 <strong>성과가 다소 희석</strong>될 것으로 예상됩니다.</p>
<ul>
<li>수수료/유동성 등으로 인해 자주 옵션을 매도하는 전략 특성상 거래비용 상승이 수반됨</li>
<li>월물 옵션 대비 위클리옵션의 유동성이 낮아, 변동성 확대 국면에서 원하는 위클리옵션의 거래가 없을 수 있음</li>
</ul>
</section>
</section>
<section id="포트폴리오-검증-25.3.13-4.10" class="level2">
<h2 class="anchored" data-anchor-id="포트폴리오-검증-25.3.13-4.10">4. 포트폴리오 검증 (’25.3.13 ~ 4.10)</h2>
<p>포트폴리오의 성과 검증을 위해 <strong>’25년 3월 옵션만기일부터 1개월간의 성과를 측정</strong>해보겠습니다.</p>
<p><strong>Backtesting과 동일한 방식으로 진행</strong>하였으며, 날짜 등 일부를 제외하고 동일 코드를 재사용하였습니다.</p>
<p><strong><em>표4 : 검증기간(’25.3.13 ~ 4.10) VW양매도 및 일반 양매도 전략 성과</em></strong></p>
<div class="cell">
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<colgroup>
<col style="width: 13%">
<col style="width: 29%">
<col style="width: 11%">
<col style="width: 13%">
<col style="width: 8%">
<col style="width: 11%">
<col style="width: 10%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: right;">BAS_DD</th>
<th style="text-align: left;">Group</th>
<th style="text-align: right;">Premium</th>
<th style="text-align: right;">Interest</th>
<th style="text-align: right;">Loss</th>
<th style="text-align: right;">Revenue</th>
<th style="text-align: right;">Return</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">20250313</td>
<td style="text-align: left;">Monthly</td>
<td style="text-align: right;">12653</td>
<td style="text-align: right;">2400</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">15053</td>
<td style="text-align: right;">0.02</td>
</tr>
<tr class="even">
<td style="text-align: right;">20250313</td>
<td style="text-align: left;">Vol-adj. Weekly</td>
<td style="text-align: right;">5624</td>
<td style="text-align: right;">596</td>
<td style="text-align: right;">2929</td>
<td style="text-align: right;">3291</td>
<td style="text-align: right;">0.00</td>
</tr>
<tr class="odd">
<td style="text-align: right;">20250320</td>
<td style="text-align: left;">Vol-adj. Weekly</td>
<td style="text-align: right;">2687</td>
<td style="text-align: right;">587</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">3274</td>
<td style="text-align: right;">0.00</td>
</tr>
<tr class="even">
<td style="text-align: right;">20250327</td>
<td style="text-align: left;">Vol-adj. Weekly</td>
<td style="text-align: right;">4283</td>
<td style="text-align: right;">578</td>
<td style="text-align: right;">20214</td>
<td style="text-align: right;">-15353</td>
<td style="text-align: right;">-0.02</td>
</tr>
<tr class="odd">
<td style="text-align: right;">20250403</td>
<td style="text-align: left;">Vol-adj. Weekly</td>
<td style="text-align: right;">11594</td>
<td style="text-align: right;">578</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">12173</td>
<td style="text-align: right;">0.01</td>
</tr>
<tr class="even">
<td style="text-align: right;">81001363</td>
<td style="text-align: left;">Vol-adj. Weekly Sum</td>
<td style="text-align: right;">24188</td>
<td style="text-align: right;">2338</td>
<td style="text-align: right;">23142</td>
<td style="text-align: right;">3384</td>
<td style="text-align: right;">0.00</td>
</tr>
</tbody>
</table>
</div>
</div>
<p><strong>검증기간 중 VW양매도 전략은 옵션을 4회 매도하였고, 일반 양매도는 1회 매도</strong>하였습니다.</p>
<p>VW양매도 전략의 <strong>프리미엄이 4회 발생하면서 수익성은 개선</strong>되었지만, 세번째 매도시기에 <strong>큰 손실이 발생하면서 순이익이 악화</strong>되었습니다. 벡테스팅 결과와 비교할 때 <strong>상반된 결과</strong>입니다.</p>
<p>그 <strong>원인은 최근 트럼프 행정부의 관세 부과 정책의 영향</strong>으로, 증시가 이례적으로 급등락한 데에서 찾을 수 있었습니다.</p>
<div style="page-break-after: always;"></div>
<p><strong><em>그래프5 : 검증기간(’25.3.13 ~ 4.10) Kospi200 및 V-Kospi200 지수 추이</em></strong></p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="사례_과제_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>먼저, <strong>3.27일 예상변동성(V-K200)이 낮아 행사가격 범위가 좁게 형성</strong>되어 VW양매도 전략이 실행되었고, 이후 관세 정책 영향으로 지수가 급락하면서 <strong>큰 손실이 발생</strong>하게 되었습니다.</p>
<p>반면 <strong>월별 전략은 만기 직전에 관세가 연기</strong>되면서 <strong>증시가 회복</strong>하였고(304 &gt; 325), 손실을 피하게 되었습니다.</p>
<p>다소 아쉬운 결과이나, <strong>VW양매도 전략의 한계점과 특수한 상황에서는 오히려 불리하다는 점</strong>을 알 수 있었습니다.</p>
<ol type="1">
<li>VW양매도 전략은 <strong>시장 변동성이 적절히 반영되지 않을 가능성</strong>이 있고, 이 경우 예기치 못한 손실이 발생할 수 있음</li>
<li><strong>옵션 만기가 짧은 것은 일반적</strong>으로 수익성, 유동성 등에서 <strong>장점</strong>이 있으나, <strong>증시가 급락 후 회복하는 상황에서는 만기가 긴 옵션이 유리</strong>할 수 있음</li>
</ol>
<div style="page-break-after: always;"></div>
</section>
<section id="appendix-python-r-code" class="level2">
<h2 class="anchored" data-anchor-id="appendix-python-r-code">5. Appendix : Python, R code</h2>
<section id="pyhon-code-데이터-수집-및-전처리" class="level3">
<h3 class="anchored" data-anchor-id="pyhon-code-데이터-수집-및-전처리">Pyhon code : 데이터 수집 및 전처리</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> requests</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> aiohttp</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> asyncio</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="co"># KRX OpenAPI 예시</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>url <span class="op">=</span> <span class="st">'http://data-dbg.krx.co.kr/svc/sample/apis/drv/opt_bydd_trd?basDd=20250312'</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>headers <span class="op">=</span> {<span class="st">'AUTH_KEY'</span>: <span class="st">'74D1B99DFBF345BBA3FB4476510A4BED4C78D13A'</span>}</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>res <span class="op">=</span> requests.get(url<span class="op">=</span>url, headers<span class="op">=</span>headers)</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>res.text</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="co"># KRX OpenAPI를 이용한 옵션 데이터 수집 (네트워크 병렬 처리)</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>idx_data <span class="op">=</span> pd.read_csv(<span class="st">'data/idx_data.csv'</span>)</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>url <span class="op">=</span> <span class="st">'http://data-dbg.krx.co.kr/svc/apis/drv/opt_bydd_trd?basDd='</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>key <span class="op">=</span> <span class="st">'BDFA640BBCE84C4B8A465EA024D50D6F3FD909FF'</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> fetch(session, url, bas_dd):</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="cf">with</span> session.get(url <span class="op">+</span> bas_dd, headers<span class="op">=</span>{<span class="st">'AUTH_KEY'</span>: key}) <span class="im">as</span> response:</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="cf">await</span> response.json()</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> fetch_all(bas_dd_list, url):</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="cf">with</span> aiohttp.ClientSession() <span class="im">as</span> session:</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>        tasks <span class="op">=</span> [fetch(session, url, <span class="bu">str</span>(bas_dd)) <span class="cf">for</span> bas_dd <span class="kw">in</span> bas_dd_list]</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="cf">await</span> asyncio.gather(<span class="op">*</span>tasks)</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> main():</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>    bas_dd_list <span class="op">=</span> idx_data[<span class="st">'BAS_DD'</span>].astype(<span class="bu">str</span>).tolist()</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>    responses <span class="op">=</span> <span class="cf">await</span> fetch_all(bas_dd_list, url)</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>    data_list <span class="op">=</span> [pd.json_normalize(res[<span class="st">'OutBlock_1'</span>]) <span class="cf">for</span> res <span class="kw">in</span> responses <span class="cf">if</span> <span class="st">'OutBlock_1'</span> <span class="kw">in</span> res <span class="kw">and</span> res[<span class="st">'OutBlock_1'</span>]]</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>    options <span class="op">=</span> pd.concat(data_list, axis<span class="op">=</span><span class="dv">0</span>, ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># CSV 저장</span></span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>    options.to_csv(<span class="st">"options_data.csv"</span>, encoding<span class="op">=</span><span class="st">"utf-8-sig"</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"complete"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="r-code-1-데이터-가공-backtesting" class="level3">
<h3 class="anchored" data-anchor-id="r-code-1-데이터-가공-backtesting">R code 1 : 데이터 가공, Backtesting</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list=</span><span class="fu">ls</span>())</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(knitr)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. 원본데이터 준비</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>options_raw <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/options_data.csv"</span>) <span class="sc">%&gt;%</span> <span class="fu">tibble</span>()</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>idx_raw <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/idx_data.csv"</span>) <span class="sc">%&gt;%</span> <span class="fu">tibble</span>()</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>mmf_raw <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/mmf.csv"</span>) <span class="sc">%&gt;%</span> <span class="fu">tibble</span>()</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="co"># 2-1. 데이터 전처리 : KRX openAPI 옵션데이터 전처리</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>options <span class="ot">&lt;-</span> options_raw <span class="sc">%&gt;%</span> </span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># K200, WK200 이외의 옵션 제외</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">substr</span>(PROD_NM,<span class="dv">1</span>,<span class="dv">3</span>)<span class="sc">==</span><span class="st">"코스피"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 종가가 없는 경우 익일 기준가격(이론가격) 사용</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">PRICE =</span> <span class="fu">as.double</span>(<span class="fu">if_else</span>(TDD_CLSPRC<span class="sc">==</span><span class="st">"-"</span>,NXTDD_BAS_PRC,TDD_CLSPRC))) <span class="sc">%&gt;%</span> </span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>(PRICE) <span class="sc">%&gt;%</span> </span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(BAS_DD,ISU_NM,PRICE,ACC_TRDVOL) <span class="sc">%&gt;%</span> </span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">separate</span>(ISU_NM, <span class="at">into=</span><span class="fu">c</span>(<span class="st">"PROD"</span>,<span class="st">"RGHT"</span>,<span class="st">"EXP"</span>,<span class="st">"EXER_PRC"</span>), <span class="at">sep=</span><span class="st">' '</span>) <span class="sc">%&gt;%</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">EXER_PRC=</span><span class="fu">as.double</span>(EXER_PRC),</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>         <span class="at">EXPMM=</span><span class="fu">if_else</span>(PROD<span class="sc">==</span><span class="st">"코스피200"</span>,<span class="fu">substr</span>(EXP,<span class="dv">3</span>,<span class="dv">6</span>),<span class="fu">substr</span>(EXP,<span class="dv">1</span>,<span class="dv">4</span>)),</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>         <span class="at">EXPWW=</span><span class="fu">if_else</span>(PROD<span class="sc">==</span><span class="st">"코스피200"</span>,<span class="dv">2</span>,<span class="fu">as.integer</span>(<span class="fu">substr</span>(EXP,<span class="dv">6</span>,<span class="dv">6</span>)))) <span class="sc">%&gt;%</span> </span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(EXER_PRC<span class="sc">&gt;</span><span class="fu">min</span>(idx_raw<span class="sc">$</span>KOSPI200)<span class="sc">*</span><span class="fl">0.85</span>,</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>         EXER_PRC<span class="sc">&lt;</span><span class="fu">max</span>(idx_raw<span class="sc">$</span>KOSPI200)<span class="sc">*</span><span class="fl">1.15</span>,</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>         PROD<span class="sc">!=</span><span class="st">"코스피위클리M"</span>) <span class="sc">%&gt;%</span> <span class="co"># 월요일 만기 위클리옵션 제외</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">PRIOR=</span><span class="fu">as.integer</span>(EXPMM)<span class="sc">*</span><span class="dv">10</span><span class="sc">+</span>EXPWW) <span class="co"># 만기가 짧은 순으로 우선순위 부여</span></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a><span class="co"># 2-2. 데이터 전처리 : 옵션 만기일 데이터 생성</span></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>target_date <span class="ot">&lt;-</span> options <span class="sc">%&gt;%</span> </span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(.,BAS_DD, PRIOR) <span class="sc">%&gt;%</span> </span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(PRIOR, <span class="fu">desc</span>(BAS_DD)) <span class="sc">%&gt;%</span> </span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(PRIOR) <span class="sc">%&gt;%</span> </span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(BAS_DD) <span class="sc">%&gt;%</span> </span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(BAS_DD)) <span class="sc">%&gt;%</span> </span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(BAS_DD<span class="sc">&lt;</span><span class="dv">20241231</span>, BAS_DD<span class="sc">&gt;</span><span class="dv">20200101</span>)</span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a><span class="co"># 2-3. 데이터 전처리 : KRX 정보데이터시스템 K200 및 V-K200지수 전처리</span></span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>idx_data <span class="ot">&lt;-</span> idx_raw <span class="sc">%&gt;%</span></span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(BAS_DD) <span class="sc">%&gt;%</span> </span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">LAG_K200=</span><span class="fu">lag</span>(KOSPI200),</span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>         <span class="at">LAG_VK200=</span><span class="fu">lag</span>(VKOSPI200))</span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a>K200_portfolio<span class="ot">=</span>idx_data <span class="sc">%&gt;%</span> </span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(mmf_raw, <span class="at">by=</span><span class="st">"BAS_DD"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">RATE=</span>(KOSPI200<span class="sc">-</span>LAG_K200)<span class="sc">/</span>LAG_K200,</span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a>         <span class="at">YEAR =</span> <span class="fu">substr</span>(BAS_DD, <span class="dv">1</span>, <span class="dv">4</span>),</span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a>         <span class="at">YM =</span> <span class="fu">ym</span>(<span class="fu">substr</span>(BAS_DD, <span class="dv">1</span>, <span class="dv">6</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(YEAR, YM) <span class="sc">%&gt;%</span></span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">RATE_K200 =</span> <span class="fu">if_else</span>(<span class="fu">is.na</span>(<span class="fu">prod</span>(<span class="dv">1</span> <span class="sc">+</span> RATE)),<span class="dv">0</span>,<span class="fu">prod</span>(<span class="dv">1</span> <span class="sc">+</span> RATE)),</span>
<span id="cb5-52"><a href="#cb5-52" aria-hidden="true" tabindex="-1"></a>            <span class="at">MMF =</span> <span class="fu">mean</span>(MMF)<span class="sc">/</span><span class="dv">100</span>,</span>
<span id="cb5-53"><a href="#cb5-53" aria-hidden="true" tabindex="-1"></a>            <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb5-54"><a href="#cb5-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb5-55"><a href="#cb5-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-56"><a href="#cb5-56" aria-hidden="true" tabindex="-1"></a><span class="co"># 3-1. 포트폴리오 구성 : VW양매도 포트폴리오 기초정보 생성</span></span>
<span id="cb5-57"><a href="#cb5-57" aria-hidden="true" tabindex="-1"></a>target_info <span class="ot">&lt;-</span> target_date <span class="sc">%&gt;%</span> </span>
<span id="cb5-58"><a href="#cb5-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(options, <span class="at">by=</span><span class="st">"BAS_DD"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb5-59"><a href="#cb5-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(BAS_DD,PRIOR) <span class="sc">%&gt;%</span> </span>
<span id="cb5-60"><a href="#cb5-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(BAS_DD),PRIOR) <span class="sc">%&gt;%</span> </span>
<span id="cb5-61"><a href="#cb5-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(BAS_DD) <span class="sc">%&gt;%</span> </span>
<span id="cb5-62"><a href="#cb5-62" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 만기가 도래하는 옵션을 제외하고 우선순위가 높은 옵션 선택</span></span>
<span id="cb5-63"><a href="#cb5-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">2</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb5-64"><a href="#cb5-64" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb5-65"><a href="#cb5-65" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(BAS_DD)) <span class="sc">%&gt;%</span> </span>
<span id="cb5-66"><a href="#cb5-66" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(idx_data, <span class="at">by=</span><span class="st">"BAS_DD"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb5-67"><a href="#cb5-67" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(mmf_raw, <span class="at">by=</span><span class="st">"BAS_DD"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb5-68"><a href="#cb5-68" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 옵션 보유기간 및 단기금리(MMF) 계산</span></span>
<span id="cb5-69"><a href="#cb5-69" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">DIFF_DAY=</span><span class="fu">as.integer</span>(<span class="fu">ymd</span>(<span class="fu">lag</span>(BAS_DD))<span class="sc">-</span><span class="fu">ymd</span>(BAS_DD)),</span>
<span id="cb5-70"><a href="#cb5-70" aria-hidden="true" tabindex="-1"></a>         <span class="at">MMF=</span>MMF<span class="sc">*</span><span class="fl">0.01</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb5-71"><a href="#cb5-71" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 옵션 보유기간에 해당하는 시장기대변동성 계산(V-K200활용)</span></span>
<span id="cb5-72"><a href="#cb5-72" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">VOL=</span>LAG_VK200<span class="sc">*</span><span class="fu">sqrt</span>(DIFF_DAY)<span class="sc">/</span><span class="fu">sqrt</span>(<span class="dv">365</span>)<span class="sc">/</span><span class="dv">100</span>) <span class="sc">%&gt;%</span></span>
<span id="cb5-73"><a href="#cb5-73" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 변동성에 따른 옵션 행사가격 상단(2.5단위 올림) 및 하단(2.5단위 내림) 계산</span></span>
<span id="cb5-74"><a href="#cb5-74" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">TARGET_C_K=</span><span class="fu">ceiling</span>(KOSPI200<span class="sc">*</span>(<span class="dv">1</span><span class="sc">+</span>VOL)<span class="sc">*</span><span class="fl">0.4</span>)<span class="sc">/</span><span class="fl">0.4</span>,</span>
<span id="cb5-75"><a href="#cb5-75" aria-hidden="true" tabindex="-1"></a>         <span class="at">TARGET_P_K=</span><span class="fu">floor</span>(KOSPI200<span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span>VOL)<span class="sc">*</span><span class="fl">0.4</span>)<span class="sc">/</span><span class="fl">0.4</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb5-76"><a href="#cb5-76" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>(DIFF_DAY) <span class="sc">%&gt;%</span> </span>
<span id="cb5-77"><a href="#cb5-77" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(BAS_DD,VOL,DIFF_DAY,MMF,KOSPI200,LAG_VK200,PRIOR,TARGET_C_K,TARGET_P_K)</span>
<span id="cb5-78"><a href="#cb5-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-79"><a href="#cb5-79" aria-hidden="true" tabindex="-1"></a><span class="co"># 3-2. 포트폴리오 구성 : VW양매도 포트폴리오 거래대상 옵션 정보 생성</span></span>
<span id="cb5-80"><a href="#cb5-80" aria-hidden="true" tabindex="-1"></a>target_options <span class="ot">&lt;-</span> target_info <span class="sc">%&gt;%</span> </span>
<span id="cb5-81"><a href="#cb5-81" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(BAS_DD, PRIOR, TARGET_C_K, TARGET_P_K) <span class="sc">%&gt;%</span> </span>
<span id="cb5-82"><a href="#cb5-82" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols=</span><span class="fu">c</span>(<span class="st">"TARGET_C_K"</span>,<span class="st">"TARGET_P_K"</span>),<span class="at">names_to =</span> <span class="st">"GRP"</span>, <span class="at">values_to =</span> <span class="st">"EXER_PRC"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb5-83"><a href="#cb5-83" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">RGHT=</span><span class="fu">substr</span>(GRP,<span class="dv">8</span>,<span class="dv">8</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb5-84"><a href="#cb5-84" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(options,<span class="at">by=</span><span class="fu">c</span>(<span class="st">"BAS_DD"</span>,<span class="st">"PRIOR"</span>,<span class="st">"RGHT"</span>,<span class="st">"EXER_PRC"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb5-85"><a href="#cb5-85" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(BAS_DD,GRP,PRICE,ACC_TRDVOL) <span class="sc">%&gt;%</span> </span>
<span id="cb5-86"><a href="#cb5-86" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> <span class="st">"GRP"</span>, <span class="at">values_from =</span> <span class="fu">c</span>(<span class="st">"PRICE"</span>,<span class="st">"ACC_TRDVOL"</span>))</span>
<span id="cb5-87"><a href="#cb5-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-88"><a href="#cb5-88" aria-hidden="true" tabindex="-1"></a><span class="co"># 원금 100억원 가정</span></span>
<span id="cb5-89"><a href="#cb5-89" aria-hidden="true" tabindex="-1"></a>cash <span class="ot">=</span> <span class="dv">10000</span><span class="sc">*</span><span class="dv">10000</span><span class="sc">*</span><span class="dv">100</span></span>
<span id="cb5-90"><a href="#cb5-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-91"><a href="#cb5-91" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. 포트폴리오 구현 : VW양매도 전략을 구현하여 일자별 손익 계산</span></span>
<span id="cb5-92"><a href="#cb5-92" aria-hidden="true" tabindex="-1"></a>portfolio <span class="ot">&lt;-</span> target_info <span class="sc">%&gt;%</span> </span>
<span id="cb5-93"><a href="#cb5-93" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(target_options,<span class="at">by=</span><span class="st">"BAS_DD"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb5-94"><a href="#cb5-94" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(BAS_DD) <span class="sc">%&gt;%</span> </span>
<span id="cb5-95"><a href="#cb5-95" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 원금에 따른 옵션 매도수량 계산</span></span>
<span id="cb5-96"><a href="#cb5-96" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">SELL_AMT=</span>cash<span class="sc">/</span><span class="dv">250000</span><span class="sc">/</span>KOSPI200) <span class="sc">%&gt;%</span> </span>
<span id="cb5-97"><a href="#cb5-97" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 옵션 프리미엄(매도수익)) 계산</span></span>
<span id="cb5-98"><a href="#cb5-98" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">PREMIUM=</span>SELL_AMT<span class="sc">*</span>(PRICE_TARGET_C_K<span class="sc">+</span>PRICE_TARGET_P_K)<span class="sc">*</span><span class="dv">250000</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb5-99"><a href="#cb5-99" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 원금 및 프리미엄의 MMF 이자수익 및 권리행사손실 계산</span></span>
<span id="cb5-100"><a href="#cb5-100" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">INTEREST=</span>(cash<span class="sc">+</span><span class="fu">replace_na</span>(PREMIUM,<span class="dv">0</span>))<span class="sc">*</span>MMF<span class="sc">*</span>DIFF_DAY<span class="sc">/</span><span class="dv">365</span>,</span>
<span id="cb5-101"><a href="#cb5-101" aria-hidden="true" tabindex="-1"></a>         <span class="at">EXERCISE=</span>(<span class="fu">if_else</span>(<span class="fu">lead</span>(KOSPI200)<span class="sc">-</span>TARGET_C_K<span class="sc">&gt;</span><span class="dv">0</span>,<span class="fu">lead</span>(KOSPI200)<span class="sc">-</span>TARGET_C_K,<span class="dv">0</span>)<span class="sc">+</span></span>
<span id="cb5-102"><a href="#cb5-102" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">if_else</span>(TARGET_P_K<span class="sc">-</span><span class="fu">lead</span>(KOSPI200)<span class="sc">&gt;</span><span class="dv">0</span>,TARGET_P_K<span class="sc">-</span><span class="fu">lead</span>(KOSPI200),<span class="dv">0</span>))<span class="sc">*</span><span class="dv">250000</span><span class="sc">*</span>SELL_AMT) <span class="sc">%&gt;%</span> </span>
<span id="cb5-103"><a href="#cb5-103" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 주단위 포트폴리오 손익 계산(원금 100억 가정, 당일 투자시 다음주 실현손익을 의미)</span></span>
<span id="cb5-104"><a href="#cb5-104" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">REVENUE=</span>PREMIUM<span class="sc">+</span>INTEREST<span class="sc">-</span>EXERCISE) <span class="sc">%&gt;%</span> </span>
<span id="cb5-105"><a href="#cb5-105" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 거래대상 옵션이 상장되어있지 않은 경우, MMF수익만 고려</span></span>
<span id="cb5-106"><a href="#cb5-106" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">REVENUE=</span><span class="fu">if_else</span>(<span class="fu">is.na</span>(REVENUE),INTEREST,REVENUE)) <span class="sc">%&gt;%</span> </span>
<span id="cb5-107"><a href="#cb5-107" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">RATE=</span>REVENUE<span class="sc">/</span>cash)  <span class="co"># 주단위 포트폴리오 수익률</span></span>
<span id="cb5-108"><a href="#cb5-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-109"><a href="#cb5-109" aria-hidden="true" tabindex="-1"></a><span class="co"># 5. 비교군 포트폴리오 생성 : 월별 5% OTM 양매도 전략</span></span>
<span id="cb5-110"><a href="#cb5-110" aria-hidden="true" tabindex="-1"></a>options2 <span class="ot">&lt;-</span> options <span class="sc">%&gt;%</span> </span>
<span id="cb5-111"><a href="#cb5-111" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(PROD<span class="sc">==</span><span class="st">"코스피200"</span>)</span>
<span id="cb5-112"><a href="#cb5-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-113"><a href="#cb5-113" aria-hidden="true" tabindex="-1"></a><span class="co"># 옵션 만기일(매달) 생성</span></span>
<span id="cb5-114"><a href="#cb5-114" aria-hidden="true" tabindex="-1"></a>target_date2 <span class="ot">&lt;-</span> options2 <span class="sc">%&gt;%</span> </span>
<span id="cb5-115"><a href="#cb5-115" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(.,BAS_DD, PRIOR) <span class="sc">%&gt;%</span> </span>
<span id="cb5-116"><a href="#cb5-116" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(PRIOR, <span class="fu">desc</span>(BAS_DD)) <span class="sc">%&gt;%</span> </span>
<span id="cb5-117"><a href="#cb5-117" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(PRIOR) <span class="sc">%&gt;%</span> </span>
<span id="cb5-118"><a href="#cb5-118" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb5-119"><a href="#cb5-119" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb5-120"><a href="#cb5-120" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(BAS_DD) <span class="sc">%&gt;%</span> </span>
<span id="cb5-121"><a href="#cb5-121" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(BAS_DD)) <span class="sc">%&gt;%</span> </span>
<span id="cb5-122"><a href="#cb5-122" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(BAS_DD<span class="sc">&lt;</span><span class="dv">20241231</span>, BAS_DD<span class="sc">&gt;</span><span class="dv">20200101</span>)</span>
<span id="cb5-123"><a href="#cb5-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-124"><a href="#cb5-124" aria-hidden="true" tabindex="-1"></a><span class="co"># 일반 양매도 포트폴리오 기본 정보 생성</span></span>
<span id="cb5-125"><a href="#cb5-125" aria-hidden="true" tabindex="-1"></a>target_info2 <span class="ot">&lt;-</span> target_date2 <span class="sc">%&gt;%</span> </span>
<span id="cb5-126"><a href="#cb5-126" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(options2, <span class="at">by=</span><span class="st">"BAS_DD"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb5-127"><a href="#cb5-127" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(BAS_DD,PRIOR) <span class="sc">%&gt;%</span> </span>
<span id="cb5-128"><a href="#cb5-128" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(BAS_DD),PRIOR) <span class="sc">%&gt;%</span> </span>
<span id="cb5-129"><a href="#cb5-129" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(BAS_DD) <span class="sc">%&gt;%</span> </span>
<span id="cb5-130"><a href="#cb5-130" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 만기가 도래하는 옵션을 제외하고 우선순위가 높은 옵션 선택</span></span>
<span id="cb5-131"><a href="#cb5-131" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">2</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb5-132"><a href="#cb5-132" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb5-133"><a href="#cb5-133" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(BAS_DD)) <span class="sc">%&gt;%</span> </span>
<span id="cb5-134"><a href="#cb5-134" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(idx_data, <span class="at">by=</span><span class="st">"BAS_DD"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb5-135"><a href="#cb5-135" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(mmf_raw, <span class="at">by=</span><span class="st">"BAS_DD"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb5-136"><a href="#cb5-136" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 옵션 보유기간 및 단기금리(MMF) 계산</span></span>
<span id="cb5-137"><a href="#cb5-137" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">DIFF_DAY=</span><span class="fu">as.integer</span>(<span class="fu">ymd</span>(<span class="fu">lag</span>(BAS_DD))<span class="sc">-</span><span class="fu">ymd</span>(BAS_DD)),</span>
<span id="cb5-138"><a href="#cb5-138" aria-hidden="true" tabindex="-1"></a>         <span class="at">MMF=</span>MMF<span class="sc">*</span><span class="fl">0.01</span>,</span>
<span id="cb5-139"><a href="#cb5-139" aria-hidden="true" tabindex="-1"></a>         <span class="at">VOL=</span><span class="fl">0.05</span>) <span class="sc">%&gt;%</span></span>
<span id="cb5-140"><a href="#cb5-140" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 변동성에 따른 옵션 행사가격 상단(2.5단위 올림) 및 하단(2.5단위 내림) 계산</span></span>
<span id="cb5-141"><a href="#cb5-141" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">TARGET_C_K=</span><span class="fu">ceiling</span>(KOSPI200<span class="sc">*</span>(<span class="dv">1</span><span class="sc">+</span>VOL)<span class="sc">*</span><span class="fl">0.4</span>)<span class="sc">/</span><span class="fl">0.4</span>,</span>
<span id="cb5-142"><a href="#cb5-142" aria-hidden="true" tabindex="-1"></a>         <span class="at">TARGET_P_K=</span><span class="fu">floor</span>(KOSPI200<span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span>VOL)<span class="sc">*</span><span class="fl">0.4</span>)<span class="sc">/</span><span class="fl">0.4</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb5-143"><a href="#cb5-143" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">DIFF_DAY=</span><span class="fu">if_else</span>(<span class="fu">is.na</span>(DIFF_DAY),<span class="dv">28</span>,DIFF_DAY)) <span class="sc">%&gt;%</span> </span>
<span id="cb5-144"><a href="#cb5-144" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(BAS_DD,VOL,DIFF_DAY,MMF,KOSPI200,LAG_VK200,PRIOR,TARGET_C_K,TARGET_P_K)</span>
<span id="cb5-145"><a href="#cb5-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-146"><a href="#cb5-146" aria-hidden="true" tabindex="-1"></a><span class="co"># 일반 양매도 포트폴리오 거래대상 옵션</span></span>
<span id="cb5-147"><a href="#cb5-147" aria-hidden="true" tabindex="-1"></a>target_options2 <span class="ot">&lt;-</span> target_info2 <span class="sc">%&gt;%</span> </span>
<span id="cb5-148"><a href="#cb5-148" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(BAS_DD, PRIOR, TARGET_C_K, TARGET_P_K) <span class="sc">%&gt;%</span> </span>
<span id="cb5-149"><a href="#cb5-149" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols=</span><span class="fu">c</span>(<span class="st">"TARGET_C_K"</span>,<span class="st">"TARGET_P_K"</span>),<span class="at">names_to =</span> <span class="st">"GRP"</span>, <span class="at">values_to =</span> <span class="st">"EXER_PRC"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb5-150"><a href="#cb5-150" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">RGHT=</span><span class="fu">substr</span>(GRP,<span class="dv">8</span>,<span class="dv">8</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb5-151"><a href="#cb5-151" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(options2,<span class="at">by=</span><span class="fu">c</span>(<span class="st">"BAS_DD"</span>,<span class="st">"PRIOR"</span>,<span class="st">"RGHT"</span>,<span class="st">"EXER_PRC"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb5-152"><a href="#cb5-152" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(BAS_DD,GRP,PRICE,ACC_TRDVOL) <span class="sc">%&gt;%</span> </span>
<span id="cb5-153"><a href="#cb5-153" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> <span class="st">"GRP"</span>, <span class="at">values_from =</span> <span class="fu">c</span>(<span class="st">"PRICE"</span>,<span class="st">"ACC_TRDVOL"</span>))</span>
<span id="cb5-154"><a href="#cb5-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-155"><a href="#cb5-155" aria-hidden="true" tabindex="-1"></a><span class="co"># 일반 양매도 포트폴리오 구현</span></span>
<span id="cb5-156"><a href="#cb5-156" aria-hidden="true" tabindex="-1"></a>portfolio2 <span class="ot">&lt;-</span> target_info2 <span class="sc">%&gt;%</span> </span>
<span id="cb5-157"><a href="#cb5-157" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(target_options2,<span class="at">by=</span><span class="st">"BAS_DD"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb5-158"><a href="#cb5-158" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(BAS_DD) <span class="sc">%&gt;%</span> </span>
<span id="cb5-159"><a href="#cb5-159" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 원금에 따른 옵션 매도수량 계산</span></span>
<span id="cb5-160"><a href="#cb5-160" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">SELL_AMT=</span>cash<span class="sc">/</span><span class="dv">250000</span><span class="sc">/</span>KOSPI200) <span class="sc">%&gt;%</span> </span>
<span id="cb5-161"><a href="#cb5-161" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 옵션 프리미엄(매도수익)) 계산</span></span>
<span id="cb5-162"><a href="#cb5-162" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">PREMIUM=</span>SELL_AMT<span class="sc">*</span>(PRICE_TARGET_C_K<span class="sc">+</span>PRICE_TARGET_P_K)<span class="sc">*</span><span class="dv">250000</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb5-163"><a href="#cb5-163" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 원금 및 프리미엄의 MMF 이자수익 및 권리행사손실 계산</span></span>
<span id="cb5-164"><a href="#cb5-164" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">INTEREST=</span>(cash<span class="sc">+</span><span class="fu">replace_na</span>(PREMIUM,<span class="dv">0</span>))<span class="sc">*</span>MMF<span class="sc">*</span>DIFF_DAY<span class="sc">/</span><span class="dv">365</span>,</span>
<span id="cb5-165"><a href="#cb5-165" aria-hidden="true" tabindex="-1"></a>         <span class="at">EXERCISE=</span>(<span class="fu">if_else</span>(<span class="fu">lead</span>(KOSPI200)<span class="sc">-</span>TARGET_C_K<span class="sc">&gt;</span><span class="dv">0</span>,<span class="fu">lead</span>(KOSPI200)<span class="sc">-</span>TARGET_C_K,<span class="dv">0</span>)<span class="sc">+</span></span>
<span id="cb5-166"><a href="#cb5-166" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">if_else</span>(TARGET_P_K<span class="sc">-</span><span class="fu">lead</span>(KOSPI200)<span class="sc">&gt;</span><span class="dv">0</span>,TARGET_P_K<span class="sc">-</span><span class="fu">lead</span>(KOSPI200),<span class="dv">0</span>))<span class="sc">*</span><span class="dv">250000</span><span class="sc">*</span>SELL_AMT) <span class="sc">%&gt;%</span> </span>
<span id="cb5-167"><a href="#cb5-167" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">EXERCISE=</span><span class="fu">if_else</span>(<span class="fu">is.na</span>(EXERCISE),<span class="dv">0</span>,EXERCISE)) <span class="sc">%&gt;%</span> </span>
<span id="cb5-168"><a href="#cb5-168" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 주단위 포트폴리오 손익 계산(원금 100억 가정, 당일 투자시 다음주 실현손익을 의미)</span></span>
<span id="cb5-169"><a href="#cb5-169" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">REVENUE=</span>PREMIUM<span class="sc">+</span>INTEREST<span class="sc">-</span>EXERCISE) <span class="sc">%&gt;%</span> </span>
<span id="cb5-170"><a href="#cb5-170" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 거래대상 옵션이 상장되어있지 않은 경우, MMF수익만 고려</span></span>
<span id="cb5-171"><a href="#cb5-171" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">REVENUE=</span><span class="fu">if_else</span>(<span class="fu">is.na</span>(REVENUE),INTEREST,REVENUE)) <span class="sc">%&gt;%</span> </span>
<span id="cb5-172"><a href="#cb5-172" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">RATE=</span>REVENUE<span class="sc">/</span>cash) <span class="co"># 주단위 포트폴리오 수익률</span></span>
<span id="cb5-173"><a href="#cb5-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-174"><a href="#cb5-174" aria-hidden="true" tabindex="-1"></a><span class="co"># 6. 성과분석 : VW양매도 포트폴리오</span></span>
<span id="cb5-175"><a href="#cb5-175" aria-hidden="true" tabindex="-1"></a>performance <span class="ot">&lt;-</span> portfolio <span class="sc">%&gt;%</span></span>
<span id="cb5-176"><a href="#cb5-176" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>(PREMIUM, EXERCISE) <span class="sc">%&gt;%</span></span>
<span id="cb5-177"><a href="#cb5-177" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">YEAR =</span> <span class="fu">substr</span>(BAS_DD, <span class="dv">1</span>, <span class="dv">4</span>),</span>
<span id="cb5-178"><a href="#cb5-178" aria-hidden="true" tabindex="-1"></a>         <span class="at">YM =</span> <span class="fu">ym</span>(<span class="fu">substr</span>(BAS_DD, <span class="dv">1</span>, <span class="dv">6</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb5-179"><a href="#cb5-179" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(YEAR, YM) <span class="sc">%&gt;%</span></span>
<span id="cb5-180"><a href="#cb5-180" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">PREMIUM =</span> <span class="fu">sum</span>(PREMIUM),</span>
<span id="cb5-181"><a href="#cb5-181" aria-hidden="true" tabindex="-1"></a>            <span class="at">INTEREST =</span> <span class="fu">sum</span>(INTEREST),</span>
<span id="cb5-182"><a href="#cb5-182" aria-hidden="true" tabindex="-1"></a>            <span class="at">EXERCISE =</span> <span class="fu">sum</span>(EXERCISE),</span>
<span id="cb5-183"><a href="#cb5-183" aria-hidden="true" tabindex="-1"></a>            <span class="at">REVENUE =</span> <span class="fu">sum</span>(REVENUE),</span>
<span id="cb5-184"><a href="#cb5-184" aria-hidden="true" tabindex="-1"></a>            <span class="at">RATE =</span> <span class="fu">prod</span>(<span class="dv">1</span> <span class="sc">+</span> RATE),</span>
<span id="cb5-185"><a href="#cb5-185" aria-hidden="true" tabindex="-1"></a>            <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb5-186"><a href="#cb5-186" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb5-187"><a href="#cb5-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-188"><a href="#cb5-188" aria-hidden="true" tabindex="-1"></a><span class="co"># 6. 성과분석 : 일반 양매도 포트폴리오</span></span>
<span id="cb5-189"><a href="#cb5-189" aria-hidden="true" tabindex="-1"></a>performance2 <span class="ot">&lt;-</span> portfolio2 <span class="sc">%&gt;%</span></span>
<span id="cb5-190"><a href="#cb5-190" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>(PREMIUM, EXERCISE) <span class="sc">%&gt;%</span></span>
<span id="cb5-191"><a href="#cb5-191" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">YEAR =</span> <span class="fu">substr</span>(BAS_DD, <span class="dv">1</span>, <span class="dv">4</span>),</span>
<span id="cb5-192"><a href="#cb5-192" aria-hidden="true" tabindex="-1"></a>         <span class="at">YM =</span> <span class="fu">ym</span>(<span class="fu">substr</span>(BAS_DD, <span class="dv">1</span>, <span class="dv">6</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb5-193"><a href="#cb5-193" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(YEAR, YM) <span class="sc">%&gt;%</span></span>
<span id="cb5-194"><a href="#cb5-194" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">PREMIUM =</span> <span class="fu">sum</span>(PREMIUM),</span>
<span id="cb5-195"><a href="#cb5-195" aria-hidden="true" tabindex="-1"></a>            <span class="at">INTEREST =</span> <span class="fu">sum</span>(INTEREST),</span>
<span id="cb5-196"><a href="#cb5-196" aria-hidden="true" tabindex="-1"></a>            <span class="at">EXERCISE =</span> <span class="fu">sum</span>(EXERCISE),</span>
<span id="cb5-197"><a href="#cb5-197" aria-hidden="true" tabindex="-1"></a>            <span class="at">REVENUE =</span> <span class="fu">sum</span>(REVENUE),</span>
<span id="cb5-198"><a href="#cb5-198" aria-hidden="true" tabindex="-1"></a>            <span class="at">RATE =</span> <span class="fu">prod</span>(<span class="dv">1</span> <span class="sc">+</span> RATE),</span>
<span id="cb5-199"><a href="#cb5-199" aria-hidden="true" tabindex="-1"></a>            <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb5-200"><a href="#cb5-200" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb5-201"><a href="#cb5-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-202"><a href="#cb5-202" aria-hidden="true" tabindex="-1"></a><span class="co"># 시각화 등</span></span>
<span id="cb5-203"><a href="#cb5-203" aria-hidden="true" tabindex="-1"></a>graph1_1 <span class="ot">&lt;-</span> performance <span class="sc">%&gt;%</span></span>
<span id="cb5-204"><a href="#cb5-204" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(YM) <span class="sc">%&gt;%</span></span>
<span id="cb5-205"><a href="#cb5-205" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(K200_portfolio,<span class="at">by=</span><span class="fu">c</span>(<span class="st">"YEAR"</span>,<span class="st">"YM"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb5-206"><a href="#cb5-206" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">CUM_RATE =</span> <span class="fu">cumprod</span>(RATE) <span class="sc">*</span> <span class="dv">100</span> <span class="sc">-</span> <span class="dv">100</span>,</span>
<span id="cb5-207"><a href="#cb5-207" aria-hidden="true" tabindex="-1"></a>         <span class="at">CUM_RATE_K200 =</span> <span class="fu">cumprod</span>(RATE_K200) <span class="sc">*</span> <span class="dv">100</span> <span class="sc">-</span> <span class="dv">100</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb5-208"><a href="#cb5-208" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(<span class="fu">tibble</span>(<span class="at">YM=</span><span class="fu">ym</span>(<span class="dv">201912</span>),<span class="at">CUM_RATE=</span><span class="dv">0</span>,<span class="at">CUM_RATE_K200=</span><span class="dv">0</span>))</span>
<span id="cb5-209"><a href="#cb5-209" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-210"><a href="#cb5-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-211"><a href="#cb5-211" aria-hidden="true" tabindex="-1"></a>graph1_2 <span class="ot">&lt;-</span> performance2 <span class="sc">%&gt;%</span></span>
<span id="cb5-212"><a href="#cb5-212" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(YM) <span class="sc">%&gt;%</span></span>
<span id="cb5-213"><a href="#cb5-213" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(K200_portfolio,<span class="at">by=</span><span class="fu">c</span>(<span class="st">"YEAR"</span>,<span class="st">"YM"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb5-214"><a href="#cb5-214" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">CUM_RATE =</span> <span class="fu">cumprod</span>(RATE) <span class="sc">*</span> <span class="dv">100</span> <span class="sc">-</span> <span class="dv">100</span>,</span>
<span id="cb5-215"><a href="#cb5-215" aria-hidden="true" tabindex="-1"></a>         <span class="at">CUM_RATE_K200 =</span> <span class="fu">cumprod</span>(RATE_K200) <span class="sc">*</span> <span class="dv">100</span> <span class="sc">-</span> <span class="dv">100</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb5-216"><a href="#cb5-216" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(<span class="fu">tibble</span>(<span class="at">YM=</span><span class="fu">ym</span>(<span class="dv">201912</span>),<span class="at">CUM_RATE=</span><span class="dv">0</span>,<span class="at">CUM_RATE_K200=</span><span class="dv">0</span>))</span>
<span id="cb5-217"><a href="#cb5-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-218"><a href="#cb5-218" aria-hidden="true" tabindex="-1"></a>graph1_3 <span class="ot">&lt;-</span> graph1_1 <span class="sc">%&gt;%</span></span>
<span id="cb5-219"><a href="#cb5-219" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(graph1_2, <span class="at">by =</span> <span class="st">"YM"</span>, <span class="at">suffix =</span> <span class="fu">c</span>(<span class="st">"_1"</span>, <span class="st">"_2"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb5-220"><a href="#cb5-220" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">REVENUE_DIFF =</span> (REVENUE_1 <span class="sc">-</span> REVENUE_2) <span class="sc">/</span> <span class="fl">1e8</span>)</span>
<span id="cb5-221"><a href="#cb5-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-222"><a href="#cb5-222" aria-hidden="true" tabindex="-1"></a>graph2_1 <span class="ot">&lt;-</span> performance <span class="sc">%&gt;%</span></span>
<span id="cb5-223"><a href="#cb5-223" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(YM) <span class="sc">%&gt;%</span></span>
<span id="cb5-224"><a href="#cb5-224" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(K200_portfolio,<span class="at">by=</span><span class="fu">c</span>(<span class="st">"YEAR"</span>,<span class="st">"YM"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb5-225"><a href="#cb5-225" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">as.integer</span>(YEAR) <span class="sc">&gt;</span> <span class="dv">2021</span>) <span class="sc">%&gt;%</span></span>
<span id="cb5-226"><a href="#cb5-226" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">CUM_RATE =</span> <span class="fu">cumprod</span>(RATE) <span class="sc">*</span> <span class="dv">100</span> <span class="sc">-</span> <span class="dv">100</span>,</span>
<span id="cb5-227"><a href="#cb5-227" aria-hidden="true" tabindex="-1"></a>         <span class="at">CUM_RATE_K200 =</span> <span class="fu">cumprod</span>(RATE_K200) <span class="sc">*</span> <span class="dv">100</span> <span class="sc">-</span> <span class="dv">100</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb5-228"><a href="#cb5-228" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(<span class="fu">tibble</span>(<span class="at">YM=</span><span class="fu">ym</span>(<span class="dv">202112</span>),<span class="at">CUM_RATE=</span><span class="dv">0</span>,<span class="at">CUM_RATE_K200=</span><span class="dv">0</span>))</span>
<span id="cb5-229"><a href="#cb5-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-230"><a href="#cb5-230" aria-hidden="true" tabindex="-1"></a>graph2_2 <span class="ot">&lt;-</span> performance2 <span class="sc">%&gt;%</span></span>
<span id="cb5-231"><a href="#cb5-231" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(YM) <span class="sc">%&gt;%</span></span>
<span id="cb5-232"><a href="#cb5-232" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(K200_portfolio,<span class="at">by=</span><span class="fu">c</span>(<span class="st">"YEAR"</span>,<span class="st">"YM"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb5-233"><a href="#cb5-233" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">as.integer</span>(YEAR) <span class="sc">&gt;</span> <span class="dv">2021</span>) <span class="sc">%&gt;%</span></span>
<span id="cb5-234"><a href="#cb5-234" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">CUM_RATE =</span> <span class="fu">cumprod</span>(RATE) <span class="sc">*</span> <span class="dv">100</span> <span class="sc">-</span> <span class="dv">100</span>,</span>
<span id="cb5-235"><a href="#cb5-235" aria-hidden="true" tabindex="-1"></a>         <span class="at">CUM_RATE_K200 =</span> <span class="fu">cumprod</span>(RATE_K200) <span class="sc">*</span> <span class="dv">100</span> <span class="sc">-</span> <span class="dv">100</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb5-236"><a href="#cb5-236" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(<span class="fu">tibble</span>(<span class="at">YM=</span><span class="fu">ym</span>(<span class="dv">202112</span>),<span class="at">CUM_RATE=</span><span class="dv">0</span>,<span class="at">CUM_RATE_K200=</span><span class="dv">0</span>))</span>
<span id="cb5-237"><a href="#cb5-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-238"><a href="#cb5-238" aria-hidden="true" tabindex="-1"></a>graph2_3 <span class="ot">&lt;-</span> graph2_1 <span class="sc">%&gt;%</span></span>
<span id="cb5-239"><a href="#cb5-239" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(graph2_2, <span class="at">by =</span> <span class="st">"YM"</span>, <span class="at">suffix =</span> <span class="fu">c</span>(<span class="st">"_1"</span>, <span class="st">"_2"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb5-240"><a href="#cb5-240" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">REVENUE_DIFF =</span> (REVENUE_1 <span class="sc">-</span> REVENUE_2) <span class="sc">/</span> <span class="fl">1e8</span>)</span>
<span id="cb5-241"><a href="#cb5-241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-242"><a href="#cb5-242" aria-hidden="true" tabindex="-1"></a>graph3_1 <span class="ot">&lt;-</span> portfolio <span class="sc">%&gt;%</span></span>
<span id="cb5-243"><a href="#cb5-243" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">YM =</span> <span class="fu">ym</span>(<span class="fu">substr</span>(BAS_DD, <span class="dv">1</span>, <span class="dv">6</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb5-244"><a href="#cb5-244" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(YM) <span class="sc">%&gt;%</span></span>
<span id="cb5-245"><a href="#cb5-245" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">TargetVol=</span><span class="fu">mean</span>(VOL),</span>
<span id="cb5-246"><a href="#cb5-246" aria-hidden="true" tabindex="-1"></a>            <span class="at">Kospi200=</span><span class="fu">mean</span>(KOSPI200)) <span class="sc">%&gt;%</span> <span class="fu">ungroup</span>()</span>
<span id="cb5-247"><a href="#cb5-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-248"><a href="#cb5-248" aria-hidden="true" tabindex="-1"></a>graph1<span class="ot">=</span><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb5-249"><a href="#cb5-249" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> graph1_1, <span class="fu">aes</span>(<span class="at">x =</span> YM, <span class="at">y =</span> CUM_RATE, <span class="at">color =</span> <span class="st">"Vol-adj. Weekly"</span>), <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb5-250"><a href="#cb5-250" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> graph1_1, <span class="fu">aes</span>(<span class="at">x =</span> YM, <span class="at">y =</span> CUM_RATE, <span class="at">color =</span> <span class="st">"Vol-adj. Weekly"</span>), <span class="at">shape =</span> <span class="dv">16</span>, <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb5-251"><a href="#cb5-251" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> graph1_2, <span class="fu">aes</span>(<span class="at">x =</span> YM, <span class="at">y =</span> CUM_RATE, <span class="at">color =</span> <span class="st">"5% OTM Monthly"</span>), <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb5-252"><a href="#cb5-252" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> graph1_2, <span class="fu">aes</span>(<span class="at">x =</span> YM, <span class="at">y =</span> CUM_RATE, <span class="at">color =</span> <span class="st">"5% OTM Monthly"</span>), <span class="at">shape =</span> <span class="dv">16</span>, <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb5-253"><a href="#cb5-253" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> graph1_1, <span class="fu">aes</span>(<span class="at">x =</span> YM, <span class="at">y =</span> CUM_RATE_K200, <span class="at">color =</span> <span class="st">"Kospi 200"</span>), <span class="at">size =</span> <span class="dv">1</span>, <span class="at">alpha=</span><span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb5-254"><a href="#cb5-254" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> graph1_1, <span class="fu">aes</span>(<span class="at">x =</span> YM, <span class="at">y =</span> CUM_RATE_K200, <span class="at">color =</span> <span class="st">"Kospi 200"</span>), <span class="at">shape =</span> <span class="dv">16</span>, <span class="at">size =</span> <span class="dv">2</span>,<span class="at">alpha=</span><span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb5-255"><a href="#cb5-255" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">data =</span> graph1_3, <span class="fu">aes</span>(<span class="at">x =</span> YM, <span class="at">y =</span> REVENUE_DIFF <span class="sc">*</span> <span class="dv">3</span>),</span>
<span id="cb5-256"><a href="#cb5-256" aria-hidden="true" tabindex="-1"></a>           <span class="at">stat =</span> <span class="st">"identity"</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>, <span class="at">fill =</span> <span class="st">"gray"</span>) <span class="sc">+</span></span>
<span id="cb5-257"><a href="#cb5-257" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_date</span>(<span class="at">date_breaks =</span> <span class="st">"1 year"</span>, <span class="at">date_labels =</span> <span class="st">"%Y"</span>) <span class="sc">+</span></span>
<span id="cb5-258"><a href="#cb5-258" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">30</span>, <span class="dv">50</span>), <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="dv">30</span>, <span class="dv">50</span>, <span class="dv">10</span>), <span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">number_format</span>(<span class="at">accuracy =</span> <span class="fl">0.1</span>),</span>
<span id="cb5-259"><a href="#cb5-259" aria-hidden="true" tabindex="-1"></a>                     <span class="at">sec.axis =</span> <span class="fu">sec_axis</span>(<span class="sc">~</span> . <span class="sc">/</span> <span class="dv">3</span>, <span class="at">name =</span> <span class="st">"Overperform (100M)"</span>, <span class="at">breaks =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">10</span>, <span class="sc">-</span><span class="dv">5</span>, <span class="dv">0</span>, <span class="dv">5</span>, <span class="dv">10</span>), <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"-10"</span>, <span class="st">"-5"</span>, <span class="st">"0"</span>, <span class="st">"5"</span>, <span class="st">"10"</span>))) <span class="sc">+</span></span>
<span id="cb5-260"><a href="#cb5-260" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Vol-adj. Weekly"</span> <span class="ot">=</span> <span class="st">"red"</span>, <span class="st">"5% OTM Monthly"</span> <span class="ot">=</span> <span class="st">"blue"</span>, <span class="st">"Kospi 200"</span> <span class="ot">=</span> <span class="st">"Green"</span>)) <span class="sc">+</span></span>
<span id="cb5-261"><a href="#cb5-261" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="cn">NULL</span>, <span class="at">y =</span> <span class="st">"Cumulative Return (%)"</span>, <span class="at">color =</span> <span class="st">""</span>) <span class="sc">+</span></span>
<span id="cb5-262"><a href="#cb5-262" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb5-263"><a href="#cb5-263" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="fu">c</span>(<span class="fl">0.4</span>, <span class="fl">0.93</span>), <span class="at">legend.direction =</span> <span class="st">"horizontal"</span>)</span>
<span id="cb5-264"><a href="#cb5-264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-265"><a href="#cb5-265" aria-hidden="true" tabindex="-1"></a>graph2<span class="ot">=</span><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb5-266"><a href="#cb5-266" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> graph2_1, <span class="fu">aes</span>(<span class="at">x =</span> YM, <span class="at">y =</span> CUM_RATE, <span class="at">color =</span> <span class="st">"Vol-adj. Weekly"</span>), <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb5-267"><a href="#cb5-267" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> graph2_1, <span class="fu">aes</span>(<span class="at">x =</span> YM, <span class="at">y =</span> CUM_RATE, <span class="at">color =</span> <span class="st">"Vol-adj. Weekly"</span>), <span class="at">shape =</span> <span class="dv">16</span>, <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb5-268"><a href="#cb5-268" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> graph2_2, <span class="fu">aes</span>(<span class="at">x =</span> YM, <span class="at">y =</span> CUM_RATE, <span class="at">color =</span> <span class="st">"5% OTM Monthly"</span>), <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb5-269"><a href="#cb5-269" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> graph2_2, <span class="fu">aes</span>(<span class="at">x =</span> YM, <span class="at">y =</span> CUM_RATE, <span class="at">color =</span> <span class="st">"5% OTM Monthly"</span>), <span class="at">shape =</span> <span class="dv">16</span>, <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb5-270"><a href="#cb5-270" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> graph2_1, <span class="fu">aes</span>(<span class="at">x =</span> YM, <span class="at">y =</span> CUM_RATE_K200, <span class="at">color =</span> <span class="st">"Kospi 200"</span>), <span class="at">size =</span> <span class="dv">1</span>, <span class="at">alpha=</span><span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb5-271"><a href="#cb5-271" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> graph2_1, <span class="fu">aes</span>(<span class="at">x =</span> YM, <span class="at">y =</span> CUM_RATE_K200, <span class="at">color =</span> <span class="st">"Kospi 200"</span>), <span class="at">shape =</span> <span class="dv">16</span>, <span class="at">size =</span> <span class="dv">2</span>,<span class="at">alpha=</span><span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb5-272"><a href="#cb5-272" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">data =</span> graph2_3, <span class="fu">aes</span>(<span class="at">x =</span> YM, <span class="at">y =</span> REVENUE_DIFF <span class="sc">*</span> <span class="dv">3</span>),</span>
<span id="cb5-273"><a href="#cb5-273" aria-hidden="true" tabindex="-1"></a>           <span class="at">stat =</span> <span class="st">"identity"</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>, <span class="at">fill =</span> <span class="st">"gray"</span>) <span class="sc">+</span></span>
<span id="cb5-274"><a href="#cb5-274" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_date</span>(<span class="at">date_breaks =</span> <span class="st">"1 year"</span>, <span class="at">date_labels =</span> <span class="st">"%Y"</span>) <span class="sc">+</span></span>
<span id="cb5-275"><a href="#cb5-275" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">30</span>, <span class="dv">20</span>), <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="dv">30</span>, <span class="dv">30</span>, <span class="dv">10</span>), <span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">number_format</span>(<span class="at">accuracy =</span> <span class="fl">0.1</span>),</span>
<span id="cb5-276"><a href="#cb5-276" aria-hidden="true" tabindex="-1"></a>                     <span class="at">sec.axis =</span> <span class="fu">sec_axis</span>(<span class="sc">~</span> . <span class="sc">/</span> <span class="dv">3</span>, <span class="at">name =</span> <span class="st">"Overperform (100M)"</span>, <span class="at">breaks =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">10</span>, <span class="sc">-</span><span class="dv">5</span>, <span class="dv">0</span>, <span class="dv">5</span>, <span class="dv">10</span>), <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"-10"</span>, <span class="st">"-5"</span>, <span class="st">"0"</span>, <span class="st">"5"</span>, <span class="st">"10"</span>))) <span class="sc">+</span></span>
<span id="cb5-277"><a href="#cb5-277" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Vol-adj. Weekly"</span> <span class="ot">=</span> <span class="st">"red"</span>, <span class="st">"5% OTM Monthly"</span> <span class="ot">=</span> <span class="st">"blue"</span>, <span class="st">"Kospi 200"</span> <span class="ot">=</span> <span class="st">"Green"</span>)) <span class="sc">+</span></span>
<span id="cb5-278"><a href="#cb5-278" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="cn">NULL</span>, <span class="at">y =</span> <span class="st">"Cumulative Return (%)"</span>, <span class="at">color =</span> <span class="st">""</span>) <span class="sc">+</span></span>
<span id="cb5-279"><a href="#cb5-279" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb5-280"><a href="#cb5-280" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="fu">c</span>(<span class="fl">0.4</span>, <span class="fl">0.93</span>), <span class="at">legend.direction =</span> <span class="st">"horizontal"</span>)</span>
<span id="cb5-281"><a href="#cb5-281" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-282"><a href="#cb5-282" aria-hidden="true" tabindex="-1"></a>graph3<span class="ot">=</span><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb5-283"><a href="#cb5-283" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> graph3_1, <span class="fu">aes</span>(<span class="at">x =</span> YM, <span class="at">y =</span> Kospi200, <span class="at">color =</span> <span class="st">"Kospi 200"</span>), <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb5-284"><a href="#cb5-284" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> graph3_1, <span class="fu">aes</span>(<span class="at">x =</span> YM, <span class="at">y =</span> Kospi200, <span class="at">color =</span> <span class="st">"Kospi 200"</span>), <span class="at">shape =</span> <span class="dv">16</span>, <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb5-285"><a href="#cb5-285" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">data =</span> graph3_1, <span class="fu">aes</span>(<span class="at">x =</span> YM, <span class="at">y =</span> TargetVol <span class="sc">*</span> <span class="dv">7000</span>),</span>
<span id="cb5-286"><a href="#cb5-286" aria-hidden="true" tabindex="-1"></a>           <span class="at">stat =</span> <span class="st">"identity"</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>, <span class="at">fill =</span> <span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb5-287"><a href="#cb5-287" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">200</span>, <span class="at">size=</span><span class="fl">0.5</span>, <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">alpha=</span><span class="fl">0.5</span>)<span class="sc">+</span></span>
<span id="cb5-288"><a href="#cb5-288" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_date</span>(<span class="at">date_breaks =</span> <span class="st">"1 year"</span>, <span class="at">date_labels =</span> <span class="st">"%Y"</span>) <span class="sc">+</span></span>
<span id="cb5-289"><a href="#cb5-289" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">500</span>), <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">100</span>, <span class="dv">500</span>, <span class="dv">100</span>),</span>
<span id="cb5-290"><a href="#cb5-290" aria-hidden="true" tabindex="-1"></a>                     <span class="at">sec.axis =</span> <span class="fu">sec_axis</span>(<span class="sc">~</span> . <span class="sc">/</span> <span class="dv">7000</span>, <span class="at">name =</span> <span class="st">"Strike Range(Monthly)"</span>, <span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.025</span>,<span class="fl">0.05</span>,<span class="fl">0.075</span>, <span class="fl">0.1</span>), <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"0"</span>,<span class="st">"5%"</span>, <span class="st">"10%"</span>,<span class="st">"15%"</span>, <span class="st">"20%"</span>))) <span class="sc">+</span></span>
<span id="cb5-291"><a href="#cb5-291" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Kospi 200"</span> <span class="ot">=</span> <span class="st">"red"</span>)) <span class="sc">+</span></span>
<span id="cb5-292"><a href="#cb5-292" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="cn">NULL</span>, <span class="at">y =</span> <span class="st">"Kospi 200"</span>, <span class="at">color =</span> <span class="st">""</span>) <span class="sc">+</span></span>
<span id="cb5-293"><a href="#cb5-293" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb5-294"><a href="#cb5-294" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="fu">c</span>(<span class="fl">0.1</span>, <span class="fl">0.93</span>), <span class="at">legend.direction =</span> <span class="st">"horizontal"</span>)</span>
<span id="cb5-295"><a href="#cb5-295" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-296"><a href="#cb5-296" aria-hidden="true" tabindex="-1"></a><span class="co"># 요약표 1 : VW포트폴리오</span></span>
<span id="cb5-297"><a href="#cb5-297" aria-hidden="true" tabindex="-1"></a>table1 <span class="ot">&lt;-</span> portfolio <span class="sc">%&gt;%</span></span>
<span id="cb5-298"><a href="#cb5-298" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>(PREMIUM, EXERCISE) <span class="sc">%&gt;%</span></span>
<span id="cb5-299"><a href="#cb5-299" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">YEAR =</span> <span class="fu">substr</span>(BAS_DD, <span class="dv">1</span>, <span class="dv">4</span>),</span>
<span id="cb5-300"><a href="#cb5-300" aria-hidden="true" tabindex="-1"></a>         <span class="at">CNT=</span><span class="dv">1</span>,</span>
<span id="cb5-301"><a href="#cb5-301" aria-hidden="true" tabindex="-1"></a>         <span class="at">NO=</span><span class="fu">if_else</span>(EXERCISE<span class="sc">==</span><span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">0</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb5-302"><a href="#cb5-302" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(YEAR) <span class="sc">%&gt;%</span></span>
<span id="cb5-303"><a href="#cb5-303" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">Expiry =</span> <span class="fu">sum</span>(CNT),</span>
<span id="cb5-304"><a href="#cb5-304" aria-hidden="true" tabindex="-1"></a>            <span class="at">NoExercise =</span> <span class="fu">round</span>(<span class="fu">sum</span>(NO)<span class="sc">/</span><span class="fu">sum</span>(CNT),<span class="dv">2</span>),</span>
<span id="cb5-305"><a href="#cb5-305" aria-hidden="true" tabindex="-1"></a>            <span class="at">Premium =</span> <span class="fu">round</span>(<span class="fu">mean</span>(PREMIUM)<span class="sc">/</span><span class="dv">10000</span>,<span class="dv">0</span>),</span>
<span id="cb5-306"><a href="#cb5-306" aria-hidden="true" tabindex="-1"></a>            <span class="at">Interest =</span> <span class="fu">round</span>(<span class="fu">mean</span>(INTEREST)<span class="sc">/</span><span class="dv">10000</span>,<span class="dv">0</span>),</span>
<span id="cb5-307"><a href="#cb5-307" aria-hidden="true" tabindex="-1"></a>            <span class="at">Loss =</span> <span class="fu">round</span>(<span class="fu">mean</span>(EXERCISE)<span class="sc">/</span><span class="dv">10000</span>,<span class="dv">0</span>),</span>
<span id="cb5-308"><a href="#cb5-308" aria-hidden="true" tabindex="-1"></a>            <span class="at">Revenue =</span> <span class="fu">round</span>(<span class="fu">mean</span>(REVENUE)<span class="sc">/</span><span class="dv">10000</span>,<span class="dv">0</span>),</span>
<span id="cb5-309"><a href="#cb5-309" aria-hidden="true" tabindex="-1"></a>            <span class="at">Return =</span> <span class="fu">round</span>(<span class="fu">prod</span>(<span class="dv">1</span> <span class="sc">+</span> RATE)<span class="sc">-</span><span class="dv">1</span>,<span class="dv">2</span>),</span>
<span id="cb5-310"><a href="#cb5-310" aria-hidden="true" tabindex="-1"></a>            <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb5-311"><a href="#cb5-311" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(K200_portfolio <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(YEAR) <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="at">Return_K200=</span><span class="fu">round</span>(<span class="fu">prod</span>(RATE_K200)<span class="sc">-</span><span class="dv">1</span>,<span class="dv">2</span>)),</span>
<span id="cb5-312"><a href="#cb5-312" aria-hidden="true" tabindex="-1"></a>            <span class="at">by=</span><span class="st">"YEAR"</span>)</span>
<span id="cb5-313"><a href="#cb5-313" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-314"><a href="#cb5-314" aria-hidden="true" tabindex="-1"></a><span class="co"># 요약표 2 : 일반 포트폴리오</span></span>
<span id="cb5-315"><a href="#cb5-315" aria-hidden="true" tabindex="-1"></a>table2 <span class="ot">&lt;-</span> portfolio2 <span class="sc">%&gt;%</span></span>
<span id="cb5-316"><a href="#cb5-316" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>(PREMIUM, EXERCISE) <span class="sc">%&gt;%</span></span>
<span id="cb5-317"><a href="#cb5-317" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">YEAR =</span> <span class="fu">substr</span>(BAS_DD, <span class="dv">1</span>, <span class="dv">4</span>),</span>
<span id="cb5-318"><a href="#cb5-318" aria-hidden="true" tabindex="-1"></a>         <span class="at">CNT=</span><span class="dv">1</span>,</span>
<span id="cb5-319"><a href="#cb5-319" aria-hidden="true" tabindex="-1"></a>         <span class="at">NO=</span><span class="fu">if_else</span>(EXERCISE<span class="sc">==</span><span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">0</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb5-320"><a href="#cb5-320" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(YEAR) <span class="sc">%&gt;%</span></span>
<span id="cb5-321"><a href="#cb5-321" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">Expiry =</span> <span class="fu">sum</span>(CNT),</span>
<span id="cb5-322"><a href="#cb5-322" aria-hidden="true" tabindex="-1"></a>            <span class="at">NoExercise =</span> <span class="fu">round</span>(<span class="fu">sum</span>(NO)<span class="sc">/</span><span class="fu">sum</span>(CNT),<span class="dv">2</span>),</span>
<span id="cb5-323"><a href="#cb5-323" aria-hidden="true" tabindex="-1"></a>            <span class="at">Premium =</span> <span class="fu">round</span>(<span class="fu">mean</span>(PREMIUM)<span class="sc">/</span><span class="dv">10000</span>,<span class="dv">0</span>),</span>
<span id="cb5-324"><a href="#cb5-324" aria-hidden="true" tabindex="-1"></a>            <span class="at">Interest =</span> <span class="fu">round</span>(<span class="fu">mean</span>(INTEREST)<span class="sc">/</span><span class="dv">10000</span>,<span class="dv">0</span>),</span>
<span id="cb5-325"><a href="#cb5-325" aria-hidden="true" tabindex="-1"></a>            <span class="at">Loss =</span> <span class="fu">round</span>(<span class="fu">mean</span>(EXERCISE)<span class="sc">/</span><span class="dv">10000</span>,<span class="dv">0</span>),</span>
<span id="cb5-326"><a href="#cb5-326" aria-hidden="true" tabindex="-1"></a>            <span class="at">Revenue =</span> <span class="fu">round</span>(<span class="fu">mean</span>(REVENUE)<span class="sc">/</span><span class="dv">10000</span>,<span class="dv">0</span>),</span>
<span id="cb5-327"><a href="#cb5-327" aria-hidden="true" tabindex="-1"></a>            <span class="at">Return =</span> <span class="fu">round</span>(<span class="fu">prod</span>(<span class="dv">1</span> <span class="sc">+</span> RATE)<span class="sc">-</span><span class="dv">1</span>,<span class="dv">2</span>),</span>
<span id="cb5-328"><a href="#cb5-328" aria-hidden="true" tabindex="-1"></a>            <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb5-329"><a href="#cb5-329" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(K200_portfolio <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(YEAR) <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="at">Return_K200=</span><span class="fu">round</span>(<span class="fu">prod</span>(RATE_K200)<span class="sc">-</span><span class="dv">1</span>,<span class="dv">2</span>)),</span>
<span id="cb5-330"><a href="#cb5-330" aria-hidden="true" tabindex="-1"></a>            <span class="at">by=</span><span class="st">"YEAR"</span>)</span>
<span id="cb5-331"><a href="#cb5-331" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-332"><a href="#cb5-332" aria-hidden="true" tabindex="-1"></a><span class="co"># 요약표 3 : 포트폴리오 변동성 비교</span></span>
<span id="cb5-333"><a href="#cb5-333" aria-hidden="true" tabindex="-1"></a>Vol1 <span class="ot">&lt;-</span> graph1_1 <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(YEAR) <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="at">Vol=</span><span class="fu">round</span>(<span class="fu">sd</span>(RATE)<span class="sc">*</span><span class="fu">sqrt</span>(<span class="dv">12</span>),<span class="dv">2</span>),</span>
<span id="cb5-334"><a href="#cb5-334" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">Vol_K200=</span><span class="fu">round</span>(<span class="fu">sd</span>(RATE_K200)<span class="sc">*</span><span class="fu">sqrt</span>(<span class="dv">12</span>),<span class="dv">2</span>))</span>
<span id="cb5-335"><a href="#cb5-335" aria-hidden="true" tabindex="-1"></a>Vol2 <span class="ot">&lt;-</span> graph1_2 <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(YEAR) <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="at">Vol=</span><span class="fu">round</span>(<span class="fu">sd</span>(RATE)<span class="sc">*</span><span class="fu">sqrt</span>(<span class="dv">12</span>),<span class="dv">2</span>))</span>
<span id="cb5-336"><a href="#cb5-336" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-337"><a href="#cb5-337" aria-hidden="true" tabindex="-1"></a>table3 <span class="ot">&lt;-</span> table1 <span class="sc">%&gt;%</span> </span>
<span id="cb5-338"><a href="#cb5-338" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(YEAR,Return,Return_K200) <span class="sc">%&gt;%</span> </span>
<span id="cb5-339"><a href="#cb5-339" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(Vol1, <span class="at">by=</span><span class="st">"YEAR"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb5-340"><a href="#cb5-340" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Return_main=</span>Return,</span>
<span id="cb5-341"><a href="#cb5-341" aria-hidden="true" tabindex="-1"></a>         <span class="at">Vol_main=</span>Vol) <span class="sc">%&gt;%</span> </span>
<span id="cb5-342"><a href="#cb5-342" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(YEAR, Return_main,Vol_main,Return_K200,Vol_K200) <span class="sc">%&gt;%</span> </span>
<span id="cb5-343"><a href="#cb5-343" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(table2 <span class="sc">%&gt;%</span> </span>
<span id="cb5-344"><a href="#cb5-344" aria-hidden="true" tabindex="-1"></a>              <span class="fu">select</span>(YEAR,Return) <span class="sc">%&gt;%</span> </span>
<span id="cb5-345"><a href="#cb5-345" aria-hidden="true" tabindex="-1"></a>              <span class="fu">left_join</span>(Vol2, <span class="at">by=</span><span class="st">"YEAR"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb5-346"><a href="#cb5-346" aria-hidden="true" tabindex="-1"></a>              <span class="fu">mutate</span>(<span class="at">Return_sub=</span>Return,</span>
<span id="cb5-347"><a href="#cb5-347" aria-hidden="true" tabindex="-1"></a>                     <span class="at">Vol_sub=</span>Vol) <span class="sc">%&gt;%</span> </span>
<span id="cb5-348"><a href="#cb5-348" aria-hidden="true" tabindex="-1"></a>              <span class="fu">select</span>(YEAR,Return_sub,Vol_sub), <span class="at">by=</span><span class="st">"YEAR"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="r-code-2-전략-검증" class="level3">
<h3 class="anchored" data-anchor-id="r-code-2-전략-검증">R code 2 : 전략 검증</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list=</span><span class="fu">ls</span>())</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(knitr)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="fu">setwd</span>(<span class="st">"homepage/study_25spring/data/"</span>)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. 원본데이터 준비</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>options_raw <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"options_data_test.csv"</span>) <span class="sc">%&gt;%</span> <span class="fu">tibble</span>()</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>idx_raw <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"idx_data_test.csv"</span>) <span class="sc">%&gt;%</span> <span class="fu">tibble</span>()</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>mmf_raw <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"mmf_test.csv"</span>) <span class="sc">%&gt;%</span> <span class="fu">tibble</span>()</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="co"># 2-1. 데이터 전처리 : KRX openAPI 옵션데이터 전처리</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>options <span class="ot">&lt;-</span> options_raw <span class="sc">%&gt;%</span> </span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># K200, WK200 이외의 옵션 제외</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">substr</span>(PROD_NM,<span class="dv">1</span>,<span class="dv">3</span>)<span class="sc">==</span><span class="st">"코스피"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 종가가 없는 경우 익일 기준가격(이론가격) 사용</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">PRICE =</span> <span class="fu">as.double</span>(<span class="fu">if_else</span>(TDD_CLSPRC<span class="sc">==</span><span class="st">"-"</span>,NXTDD_BAS_PRC,TDD_CLSPRC))) <span class="sc">%&gt;%</span> </span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>(PRICE) <span class="sc">%&gt;%</span> </span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(BAS_DD,ISU_NM,PRICE,ACC_TRDVOL) <span class="sc">%&gt;%</span> </span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">separate</span>(ISU_NM, <span class="at">into=</span><span class="fu">c</span>(<span class="st">"PROD"</span>,<span class="st">"RGHT"</span>,<span class="st">"EXP"</span>,<span class="st">"EXER_PRC"</span>), <span class="at">sep=</span><span class="st">' '</span>) <span class="sc">%&gt;%</span></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">EXER_PRC=</span><span class="fu">as.double</span>(EXER_PRC),</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>         <span class="at">EXPMM=</span><span class="fu">if_else</span>(PROD<span class="sc">==</span><span class="st">"코스피200"</span>,<span class="fu">substr</span>(EXP,<span class="dv">3</span>,<span class="dv">6</span>),<span class="fu">substr</span>(EXP,<span class="dv">1</span>,<span class="dv">4</span>)),</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>         <span class="at">EXPWW=</span><span class="fu">if_else</span>(PROD<span class="sc">==</span><span class="st">"코스피200"</span>,<span class="dv">2</span>,<span class="fu">as.integer</span>(<span class="fu">substr</span>(EXP,<span class="dv">6</span>,<span class="dv">6</span>)))) <span class="sc">%&gt;%</span> </span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(EXER_PRC<span class="sc">&gt;</span><span class="fu">min</span>(idx_raw<span class="sc">$</span>KOSPI200)<span class="sc">*</span><span class="fl">0.85</span>,</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>         EXER_PRC<span class="sc">&lt;</span><span class="fu">max</span>(idx_raw<span class="sc">$</span>KOSPI200)<span class="sc">*</span><span class="fl">1.15</span>,</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>         PROD<span class="sc">!=</span><span class="st">"코스피위클리M"</span>) <span class="sc">%&gt;%</span> <span class="co"># 월요일 만기 위클리옵션 제외</span></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">PRIOR=</span><span class="fu">as.integer</span>(EXPMM)<span class="sc">*</span><span class="dv">10</span><span class="sc">+</span>EXPWW) <span class="co"># 만기가 짧은 순으로 우선순위 부여</span></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a><span class="co"># 2-2. 데이터 전처리 : 옵션 만기일 데이터 생성</span></span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>target_date <span class="ot">&lt;-</span> options <span class="sc">%&gt;%</span> </span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(.,BAS_DD, PRIOR) <span class="sc">%&gt;%</span> </span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(PRIOR, <span class="fu">desc</span>(BAS_DD)) <span class="sc">%&gt;%</span> </span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(PRIOR) <span class="sc">%&gt;%</span> </span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(BAS_DD) <span class="sc">%&gt;%</span> </span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(BAS_DD)) <span class="sc">%&gt;%</span> </span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(BAS_DD<span class="sc">&lt;</span><span class="dv">20250411</span>)</span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a><span class="co"># 2-3. 데이터 전처리 : KRX 정보데이터시스템 K200 및 V-K200지수 전처리</span></span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a>idx_data <span class="ot">&lt;-</span> idx_raw <span class="sc">%&gt;%</span></span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(BAS_DD) <span class="sc">%&gt;%</span> </span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">LAG_K200=</span><span class="fu">lag</span>(KOSPI200),</span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a>         <span class="at">LAG_VK200=</span><span class="fu">lag</span>(VKOSPI200))</span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a>K200_portfolio<span class="ot">=</span>idx_data <span class="sc">%&gt;%</span> </span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(mmf_raw, <span class="at">by=</span><span class="st">"BAS_DD"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb6-48"><a href="#cb6-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">RATE=</span>(KOSPI200<span class="sc">-</span>LAG_K200)<span class="sc">/</span>LAG_K200,</span>
<span id="cb6-49"><a href="#cb6-49" aria-hidden="true" tabindex="-1"></a>         <span class="at">YEAR =</span> <span class="fu">substr</span>(BAS_DD, <span class="dv">1</span>, <span class="dv">4</span>),</span>
<span id="cb6-50"><a href="#cb6-50" aria-hidden="true" tabindex="-1"></a>         <span class="at">YM =</span> <span class="fu">ym</span>(<span class="fu">substr</span>(BAS_DD, <span class="dv">1</span>, <span class="dv">6</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb6-51"><a href="#cb6-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(YEAR) <span class="sc">%&gt;%</span></span>
<span id="cb6-52"><a href="#cb6-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">is.na</span>(RATE)<span class="sc">==</span><span class="cn">FALSE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb6-53"><a href="#cb6-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">RATE_K200 =</span> <span class="fu">prod</span>(<span class="dv">1</span> <span class="sc">+</span> RATE),</span>
<span id="cb6-54"><a href="#cb6-54" aria-hidden="true" tabindex="-1"></a>            <span class="at">MMF =</span> <span class="fu">mean</span>(MMF)<span class="sc">/</span><span class="dv">100</span>,</span>
<span id="cb6-55"><a href="#cb6-55" aria-hidden="true" tabindex="-1"></a>            <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb6-56"><a href="#cb6-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb6-57"><a href="#cb6-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-58"><a href="#cb6-58" aria-hidden="true" tabindex="-1"></a><span class="co"># 3-1. 포트폴리오 구성 : VW양매도 포트폴리오 기초정보 생성</span></span>
<span id="cb6-59"><a href="#cb6-59" aria-hidden="true" tabindex="-1"></a>target_info <span class="ot">&lt;-</span> target_date <span class="sc">%&gt;%</span> </span>
<span id="cb6-60"><a href="#cb6-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(options, <span class="at">by=</span><span class="st">"BAS_DD"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb6-61"><a href="#cb6-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(BAS_DD,PRIOR) <span class="sc">%&gt;%</span> </span>
<span id="cb6-62"><a href="#cb6-62" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(BAS_DD),PRIOR) <span class="sc">%&gt;%</span> </span>
<span id="cb6-63"><a href="#cb6-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(BAS_DD) <span class="sc">%&gt;%</span> </span>
<span id="cb6-64"><a href="#cb6-64" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 만기가 도래하는 옵션을 제외하고 우선순위가 높은 옵션 선택</span></span>
<span id="cb6-65"><a href="#cb6-65" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">2</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb6-66"><a href="#cb6-66" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb6-67"><a href="#cb6-67" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(BAS_DD)) <span class="sc">%&gt;%</span> </span>
<span id="cb6-68"><a href="#cb6-68" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(idx_data, <span class="at">by=</span><span class="st">"BAS_DD"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb6-69"><a href="#cb6-69" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(mmf_raw, <span class="at">by=</span><span class="st">"BAS_DD"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb6-70"><a href="#cb6-70" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 옵션 보유기간 및 단기금리(MMF) 계산</span></span>
<span id="cb6-71"><a href="#cb6-71" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">DIFF_DAY=</span><span class="fu">as.integer</span>(<span class="fu">ymd</span>(<span class="fu">lag</span>(BAS_DD))<span class="sc">-</span><span class="fu">ymd</span>(BAS_DD)),</span>
<span id="cb6-72"><a href="#cb6-72" aria-hidden="true" tabindex="-1"></a>         <span class="at">MMF=</span>MMF<span class="sc">*</span><span class="fl">0.01</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb6-73"><a href="#cb6-73" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 옵션 보유기간에 해당하는 시장기대변동성 계산(V-K200활용)</span></span>
<span id="cb6-74"><a href="#cb6-74" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">VOL=</span>LAG_VK200<span class="sc">*</span><span class="fu">sqrt</span>(DIFF_DAY)<span class="sc">/</span><span class="fu">sqrt</span>(<span class="dv">365</span>)<span class="sc">/</span><span class="dv">100</span>) <span class="sc">%&gt;%</span></span>
<span id="cb6-75"><a href="#cb6-75" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 변동성에 따른 옵션 행사가격 상단(2.5단위 올림) 및 하단(2.5단위 내림) 계산</span></span>
<span id="cb6-76"><a href="#cb6-76" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">TARGET_C_K=</span><span class="fu">ceiling</span>(KOSPI200<span class="sc">*</span>(<span class="dv">1</span><span class="sc">+</span>VOL)<span class="sc">*</span><span class="fl">0.4</span>)<span class="sc">/</span><span class="fl">0.4</span>,</span>
<span id="cb6-77"><a href="#cb6-77" aria-hidden="true" tabindex="-1"></a>         <span class="at">TARGET_P_K=</span><span class="fu">floor</span>(KOSPI200<span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span>VOL)<span class="sc">*</span><span class="fl">0.4</span>)<span class="sc">/</span><span class="fl">0.4</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb6-78"><a href="#cb6-78" aria-hidden="true" tabindex="-1"></a>  <span class="co"># drop_na(DIFF_DAY) %&gt;% </span></span>
<span id="cb6-79"><a href="#cb6-79" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(BAS_DD,VOL,DIFF_DAY,MMF,KOSPI200,LAG_VK200,PRIOR,TARGET_C_K,TARGET_P_K)</span>
<span id="cb6-80"><a href="#cb6-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-81"><a href="#cb6-81" aria-hidden="true" tabindex="-1"></a><span class="co"># 3-2. 포트폴리오 구성 : VW양매도 포트폴리오 거래대상 옵션 정보 생성</span></span>
<span id="cb6-82"><a href="#cb6-82" aria-hidden="true" tabindex="-1"></a>target_options <span class="ot">&lt;-</span> target_info <span class="sc">%&gt;%</span> </span>
<span id="cb6-83"><a href="#cb6-83" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(BAS_DD, PRIOR, TARGET_C_K, TARGET_P_K) <span class="sc">%&gt;%</span> </span>
<span id="cb6-84"><a href="#cb6-84" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols=</span><span class="fu">c</span>(<span class="st">"TARGET_C_K"</span>,<span class="st">"TARGET_P_K"</span>),<span class="at">names_to =</span> <span class="st">"GRP"</span>, <span class="at">values_to =</span> <span class="st">"EXER_PRC"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb6-85"><a href="#cb6-85" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">RGHT=</span><span class="fu">substr</span>(GRP,<span class="dv">8</span>,<span class="dv">8</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb6-86"><a href="#cb6-86" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(options,<span class="at">by=</span><span class="fu">c</span>(<span class="st">"BAS_DD"</span>,<span class="st">"PRIOR"</span>,<span class="st">"RGHT"</span>,<span class="st">"EXER_PRC"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb6-87"><a href="#cb6-87" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(BAS_DD,GRP,PRICE,ACC_TRDVOL) <span class="sc">%&gt;%</span> </span>
<span id="cb6-88"><a href="#cb6-88" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> <span class="st">"GRP"</span>, <span class="at">values_from =</span> <span class="fu">c</span>(<span class="st">"PRICE"</span>,<span class="st">"ACC_TRDVOL"</span>))</span>
<span id="cb6-89"><a href="#cb6-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-90"><a href="#cb6-90" aria-hidden="true" tabindex="-1"></a><span class="co"># 원금 100억원 가정</span></span>
<span id="cb6-91"><a href="#cb6-91" aria-hidden="true" tabindex="-1"></a>cash <span class="ot">=</span> <span class="dv">10000</span><span class="sc">*</span><span class="dv">10000</span><span class="sc">*</span><span class="dv">100</span></span>
<span id="cb6-92"><a href="#cb6-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-93"><a href="#cb6-93" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. 포트폴리오 구현 : VW양매도 전략을 구현하여 일자별 손익 계산</span></span>
<span id="cb6-94"><a href="#cb6-94" aria-hidden="true" tabindex="-1"></a>portfolio <span class="ot">&lt;-</span> target_info <span class="sc">%&gt;%</span> </span>
<span id="cb6-95"><a href="#cb6-95" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(target_options,<span class="at">by=</span><span class="st">"BAS_DD"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb6-96"><a href="#cb6-96" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(BAS_DD) <span class="sc">%&gt;%</span> </span>
<span id="cb6-97"><a href="#cb6-97" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 원금에 따른 옵션 매도수량 계산</span></span>
<span id="cb6-98"><a href="#cb6-98" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">SELL_AMT=</span>cash<span class="sc">/</span><span class="dv">250000</span><span class="sc">/</span>KOSPI200) <span class="sc">%&gt;%</span> </span>
<span id="cb6-99"><a href="#cb6-99" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 옵션 프리미엄(매도수익)) 계산</span></span>
<span id="cb6-100"><a href="#cb6-100" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">PREMIUM=</span>SELL_AMT<span class="sc">*</span>(PRICE_TARGET_C_K<span class="sc">+</span>PRICE_TARGET_P_K)<span class="sc">*</span><span class="dv">250000</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb6-101"><a href="#cb6-101" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 원금 및 프리미엄의 MMF 이자수익 및 권리행사손실 계산</span></span>
<span id="cb6-102"><a href="#cb6-102" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">INTEREST=</span>(cash<span class="sc">+</span><span class="fu">replace_na</span>(PREMIUM,<span class="dv">0</span>))<span class="sc">*</span>MMF<span class="sc">*</span>DIFF_DAY<span class="sc">/</span><span class="dv">365</span>,</span>
<span id="cb6-103"><a href="#cb6-103" aria-hidden="true" tabindex="-1"></a>         <span class="at">EXERCISE=</span>(<span class="fu">if_else</span>(<span class="fu">lead</span>(KOSPI200)<span class="sc">-</span>TARGET_C_K<span class="sc">&gt;</span><span class="dv">0</span>,<span class="fu">lead</span>(KOSPI200)<span class="sc">-</span>TARGET_C_K,<span class="dv">0</span>)<span class="sc">+</span></span>
<span id="cb6-104"><a href="#cb6-104" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">if_else</span>(TARGET_P_K<span class="sc">-</span><span class="fu">lead</span>(KOSPI200)<span class="sc">&gt;</span><span class="dv">0</span>,TARGET_P_K<span class="sc">-</span><span class="fu">lead</span>(KOSPI200),<span class="dv">0</span>))<span class="sc">*</span><span class="dv">250000</span><span class="sc">*</span>SELL_AMT) <span class="sc">%&gt;%</span> </span>
<span id="cb6-105"><a href="#cb6-105" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 주단위 포트폴리오 손익 계산(원금 100억 가정, 당일 투자시 다음주 실현손익을 의미)</span></span>
<span id="cb6-106"><a href="#cb6-106" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">REVENUE=</span>PREMIUM<span class="sc">+</span>INTEREST<span class="sc">-</span>EXERCISE) <span class="sc">%&gt;%</span> </span>
<span id="cb6-107"><a href="#cb6-107" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 거래대상 옵션이 상장되어있지 않은 경우, MMF수익만 고려</span></span>
<span id="cb6-108"><a href="#cb6-108" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">REVENUE=</span><span class="fu">if_else</span>(<span class="fu">is.na</span>(REVENUE),INTEREST,REVENUE)) <span class="sc">%&gt;%</span> </span>
<span id="cb6-109"><a href="#cb6-109" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">RATE=</span>REVENUE<span class="sc">/</span>cash,</span>
<span id="cb6-110"><a href="#cb6-110" aria-hidden="true" tabindex="-1"></a>         <span class="at">Group=</span><span class="st">"Vol-adj. Weekly"</span>)  <span class="co"># 주단위 포트폴리오 수익률</span></span>
<span id="cb6-111"><a href="#cb6-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-112"><a href="#cb6-112" aria-hidden="true" tabindex="-1"></a><span class="co"># 5. 비교군 포트폴리오 생성 : 월별 5% OTM 양매도 전략</span></span>
<span id="cb6-113"><a href="#cb6-113" aria-hidden="true" tabindex="-1"></a>options2 <span class="ot">&lt;-</span> options <span class="sc">%&gt;%</span> </span>
<span id="cb6-114"><a href="#cb6-114" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(PROD<span class="sc">==</span><span class="st">"코스피200"</span>)</span>
<span id="cb6-115"><a href="#cb6-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-116"><a href="#cb6-116" aria-hidden="true" tabindex="-1"></a><span class="co"># 옵션 만기일(매달) 생성</span></span>
<span id="cb6-117"><a href="#cb6-117" aria-hidden="true" tabindex="-1"></a>target_date2 <span class="ot">&lt;-</span> options2 <span class="sc">%&gt;%</span> </span>
<span id="cb6-118"><a href="#cb6-118" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(.,BAS_DD, PRIOR) <span class="sc">%&gt;%</span> </span>
<span id="cb6-119"><a href="#cb6-119" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(PRIOR, <span class="fu">desc</span>(BAS_DD)) <span class="sc">%&gt;%</span> </span>
<span id="cb6-120"><a href="#cb6-120" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(PRIOR) <span class="sc">%&gt;%</span> </span>
<span id="cb6-121"><a href="#cb6-121" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb6-122"><a href="#cb6-122" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb6-123"><a href="#cb6-123" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(BAS_DD) <span class="sc">%&gt;%</span> </span>
<span id="cb6-124"><a href="#cb6-124" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(BAS_DD)) <span class="sc">%&gt;%</span> </span>
<span id="cb6-125"><a href="#cb6-125" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(BAS_DD<span class="sc">&lt;</span><span class="dv">20250411</span>)</span>
<span id="cb6-126"><a href="#cb6-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-127"><a href="#cb6-127" aria-hidden="true" tabindex="-1"></a><span class="co"># 일반 양매도 포트폴리오 기본 정보 생성</span></span>
<span id="cb6-128"><a href="#cb6-128" aria-hidden="true" tabindex="-1"></a>target_info2 <span class="ot">&lt;-</span> target_date2 <span class="sc">%&gt;%</span> </span>
<span id="cb6-129"><a href="#cb6-129" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(options2, <span class="at">by=</span><span class="st">"BAS_DD"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb6-130"><a href="#cb6-130" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(BAS_DD,PRIOR) <span class="sc">%&gt;%</span> </span>
<span id="cb6-131"><a href="#cb6-131" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(BAS_DD),PRIOR) <span class="sc">%&gt;%</span> </span>
<span id="cb6-132"><a href="#cb6-132" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(BAS_DD) <span class="sc">%&gt;%</span> </span>
<span id="cb6-133"><a href="#cb6-133" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 만기가 도래하는 옵션을 제외하고 우선순위가 높은 옵션 선택</span></span>
<span id="cb6-134"><a href="#cb6-134" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">2</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb6-135"><a href="#cb6-135" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb6-136"><a href="#cb6-136" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(BAS_DD)) <span class="sc">%&gt;%</span> </span>
<span id="cb6-137"><a href="#cb6-137" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(idx_data, <span class="at">by=</span><span class="st">"BAS_DD"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb6-138"><a href="#cb6-138" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(mmf_raw, <span class="at">by=</span><span class="st">"BAS_DD"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb6-139"><a href="#cb6-139" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 옵션 보유기간 및 단기금리(MMF) 계산</span></span>
<span id="cb6-140"><a href="#cb6-140" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">DIFF_DAY=</span><span class="fu">as.integer</span>(<span class="fu">ymd</span>(<span class="fu">lag</span>(BAS_DD))<span class="sc">-</span><span class="fu">ymd</span>(BAS_DD)),</span>
<span id="cb6-141"><a href="#cb6-141" aria-hidden="true" tabindex="-1"></a>         <span class="at">MMF=</span>MMF<span class="sc">*</span><span class="fl">0.01</span>,</span>
<span id="cb6-142"><a href="#cb6-142" aria-hidden="true" tabindex="-1"></a>         <span class="at">VOL=</span><span class="fl">0.05</span>) <span class="sc">%&gt;%</span></span>
<span id="cb6-143"><a href="#cb6-143" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 변동성에 따른 옵션 행사가격 상단(2.5단위 올림) 및 하단(2.5단위 내림) 계산</span></span>
<span id="cb6-144"><a href="#cb6-144" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">TARGET_C_K=</span><span class="fu">ceiling</span>(KOSPI200<span class="sc">*</span>(<span class="dv">1</span><span class="sc">+</span>VOL)<span class="sc">*</span><span class="fl">0.4</span>)<span class="sc">/</span><span class="fl">0.4</span>,</span>
<span id="cb6-145"><a href="#cb6-145" aria-hidden="true" tabindex="-1"></a>         <span class="at">TARGET_P_K=</span><span class="fu">floor</span>(KOSPI200<span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span>VOL)<span class="sc">*</span><span class="fl">0.4</span>)<span class="sc">/</span><span class="fl">0.4</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb6-146"><a href="#cb6-146" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">DIFF_DAY=</span><span class="fu">if_else</span>(<span class="fu">is.na</span>(DIFF_DAY),<span class="dv">28</span>,DIFF_DAY)) <span class="sc">%&gt;%</span> </span>
<span id="cb6-147"><a href="#cb6-147" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(BAS_DD,VOL,DIFF_DAY,MMF,KOSPI200,LAG_VK200,PRIOR,TARGET_C_K,TARGET_P_K)</span>
<span id="cb6-148"><a href="#cb6-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-149"><a href="#cb6-149" aria-hidden="true" tabindex="-1"></a><span class="co"># 일반 양매도 포트폴리오 거래대상 옵션</span></span>
<span id="cb6-150"><a href="#cb6-150" aria-hidden="true" tabindex="-1"></a>target_options2 <span class="ot">&lt;-</span> target_info2 <span class="sc">%&gt;%</span> </span>
<span id="cb6-151"><a href="#cb6-151" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(BAS_DD, PRIOR, TARGET_C_K, TARGET_P_K) <span class="sc">%&gt;%</span> </span>
<span id="cb6-152"><a href="#cb6-152" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols=</span><span class="fu">c</span>(<span class="st">"TARGET_C_K"</span>,<span class="st">"TARGET_P_K"</span>),<span class="at">names_to =</span> <span class="st">"GRP"</span>, <span class="at">values_to =</span> <span class="st">"EXER_PRC"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb6-153"><a href="#cb6-153" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">RGHT=</span><span class="fu">substr</span>(GRP,<span class="dv">8</span>,<span class="dv">8</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb6-154"><a href="#cb6-154" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(options2,<span class="at">by=</span><span class="fu">c</span>(<span class="st">"BAS_DD"</span>,<span class="st">"PRIOR"</span>,<span class="st">"RGHT"</span>,<span class="st">"EXER_PRC"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb6-155"><a href="#cb6-155" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(BAS_DD,GRP,PRICE,ACC_TRDVOL) <span class="sc">%&gt;%</span> </span>
<span id="cb6-156"><a href="#cb6-156" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> <span class="st">"GRP"</span>, <span class="at">values_from =</span> <span class="fu">c</span>(<span class="st">"PRICE"</span>,<span class="st">"ACC_TRDVOL"</span>))</span>
<span id="cb6-157"><a href="#cb6-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-158"><a href="#cb6-158" aria-hidden="true" tabindex="-1"></a><span class="co"># 일반 양매도 포트폴리오 구현</span></span>
<span id="cb6-159"><a href="#cb6-159" aria-hidden="true" tabindex="-1"></a>portfolio2 <span class="ot">&lt;-</span> target_info2 <span class="sc">%&gt;%</span> </span>
<span id="cb6-160"><a href="#cb6-160" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(target_options2,<span class="at">by=</span><span class="st">"BAS_DD"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb6-161"><a href="#cb6-161" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(BAS_DD) <span class="sc">%&gt;%</span> </span>
<span id="cb6-162"><a href="#cb6-162" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 원금에 따른 옵션 매도수량 계산</span></span>
<span id="cb6-163"><a href="#cb6-163" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">SELL_AMT=</span>cash<span class="sc">/</span><span class="dv">250000</span><span class="sc">/</span>KOSPI200) <span class="sc">%&gt;%</span> </span>
<span id="cb6-164"><a href="#cb6-164" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 옵션 프리미엄(매도수익)) 계산</span></span>
<span id="cb6-165"><a href="#cb6-165" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">PREMIUM=</span>SELL_AMT<span class="sc">*</span>(PRICE_TARGET_C_K<span class="sc">+</span>PRICE_TARGET_P_K)<span class="sc">*</span><span class="dv">250000</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb6-166"><a href="#cb6-166" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 원금 및 프리미엄의 MMF 이자수익 및 권리행사손실 계산</span></span>
<span id="cb6-167"><a href="#cb6-167" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">INTEREST=</span>(cash<span class="sc">+</span><span class="fu">replace_na</span>(PREMIUM,<span class="dv">0</span>))<span class="sc">*</span>MMF<span class="sc">*</span>DIFF_DAY<span class="sc">/</span><span class="dv">365</span>,</span>
<span id="cb6-168"><a href="#cb6-168" aria-hidden="true" tabindex="-1"></a>         <span class="at">EXERCISE=</span>(<span class="fu">if_else</span>(<span class="fu">lead</span>(KOSPI200)<span class="sc">-</span>TARGET_C_K<span class="sc">&gt;</span><span class="dv">0</span>,<span class="fu">lead</span>(KOSPI200)<span class="sc">-</span>TARGET_C_K,<span class="dv">0</span>)<span class="sc">+</span></span>
<span id="cb6-169"><a href="#cb6-169" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">if_else</span>(TARGET_P_K<span class="sc">-</span><span class="fu">lead</span>(KOSPI200)<span class="sc">&gt;</span><span class="dv">0</span>,TARGET_P_K<span class="sc">-</span><span class="fu">lead</span>(KOSPI200),<span class="dv">0</span>))<span class="sc">*</span><span class="dv">250000</span><span class="sc">*</span>SELL_AMT) <span class="sc">%&gt;%</span> </span>
<span id="cb6-170"><a href="#cb6-170" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">EXERCISE=</span><span class="fu">if_else</span>(<span class="fu">is.na</span>(EXERCISE),<span class="dv">0</span>,EXERCISE)) <span class="sc">%&gt;%</span> </span>
<span id="cb6-171"><a href="#cb6-171" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 주단위 포트폴리오 손익 계산(원금 100억 가정, 당일 투자시 다음주 실현손익을 의미)</span></span>
<span id="cb6-172"><a href="#cb6-172" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">REVENUE=</span>PREMIUM<span class="sc">+</span>INTEREST<span class="sc">-</span>EXERCISE) <span class="sc">%&gt;%</span> </span>
<span id="cb6-173"><a href="#cb6-173" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 거래대상 옵션이 상장되어있지 않은 경우, MMF수익만 고려</span></span>
<span id="cb6-174"><a href="#cb6-174" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">REVENUE=</span><span class="fu">if_else</span>(<span class="fu">is.na</span>(REVENUE),INTEREST,REVENUE)) <span class="sc">%&gt;%</span> </span>
<span id="cb6-175"><a href="#cb6-175" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">RATE=</span>REVENUE<span class="sc">/</span>cash,</span>
<span id="cb6-176"><a href="#cb6-176" aria-hidden="true" tabindex="-1"></a>         <span class="at">Group=</span><span class="st">"Monthly"</span>) <span class="co"># 주단위 포트폴리오 수익률</span></span>
<span id="cb6-177"><a href="#cb6-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-178"><a href="#cb6-178" aria-hidden="true" tabindex="-1"></a>portfolio <span class="ot">&lt;-</span> portfolio <span class="sc">%&gt;%</span> <span class="fu">filter</span>(BAS_DD<span class="sc">!=</span><span class="dv">20250410</span>)</span>
<span id="cb6-179"><a href="#cb6-179" aria-hidden="true" tabindex="-1"></a>portfolio2 <span class="ot">&lt;-</span> portfolio2 <span class="sc">%&gt;%</span> <span class="fu">filter</span>(BAS_DD<span class="sc">!=</span><span class="dv">20250410</span>)</span>
<span id="cb6-180"><a href="#cb6-180" aria-hidden="true" tabindex="-1"></a>portfolio3 <span class="ot">&lt;-</span> portfolio <span class="sc">%&gt;%</span> </span>
<span id="cb6-181"><a href="#cb6-181" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.numeric), sum)) <span class="sc">%&gt;%</span> </span>
<span id="cb6-182"><a href="#cb6-182" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Group=</span><span class="st">"Vol-adj. Weekly Sum"</span>)</span>
<span id="cb6-183"><a href="#cb6-183" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-184"><a href="#cb6-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-185"><a href="#cb6-185" aria-hidden="true" tabindex="-1"></a><span class="co"># 요약표 4 : 검증 자료</span></span>
<span id="cb6-186"><a href="#cb6-186" aria-hidden="true" tabindex="-1"></a>table4 <span class="ot">&lt;-</span> portfolio <span class="sc">%&gt;%</span></span>
<span id="cb6-187"><a href="#cb6-187" aria-hidden="true" tabindex="-1"></a>  <span class="fu">union_all</span>(portfolio2) <span class="sc">%&gt;%</span></span>
<span id="cb6-188"><a href="#cb6-188" aria-hidden="true" tabindex="-1"></a>  <span class="fu">union_all</span>(portfolio3) <span class="sc">%&gt;%</span> </span>
<span id="cb6-189"><a href="#cb6-189" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(BAS_DD, Group) <span class="sc">%&gt;%</span></span>
<span id="cb6-190"><a href="#cb6-190" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">Premium =</span> <span class="fu">round</span>(<span class="fu">mean</span>(PREMIUM)<span class="sc">/</span><span class="dv">10000</span>,<span class="dv">0</span>),</span>
<span id="cb6-191"><a href="#cb6-191" aria-hidden="true" tabindex="-1"></a>            <span class="at">Interest =</span> <span class="fu">round</span>(<span class="fu">mean</span>(INTEREST)<span class="sc">/</span><span class="dv">10000</span>,<span class="dv">0</span>),</span>
<span id="cb6-192"><a href="#cb6-192" aria-hidden="true" tabindex="-1"></a>            <span class="at">Loss =</span> <span class="fu">round</span>(<span class="fu">mean</span>(EXERCISE)<span class="sc">/</span><span class="dv">10000</span>,<span class="dv">0</span>),</span>
<span id="cb6-193"><a href="#cb6-193" aria-hidden="true" tabindex="-1"></a>            <span class="at">Revenue =</span> <span class="fu">round</span>(<span class="fu">mean</span>(REVENUE)<span class="sc">/</span><span class="dv">10000</span>,<span class="dv">0</span>),</span>
<span id="cb6-194"><a href="#cb6-194" aria-hidden="true" tabindex="-1"></a>            <span class="at">Return =</span> <span class="fu">round</span>(<span class="fu">prod</span>(<span class="dv">1</span> <span class="sc">+</span> RATE)<span class="sc">-</span><span class="dv">1</span>,<span class="dv">2</span>),</span>
<span id="cb6-195"><a href="#cb6-195" aria-hidden="true" tabindex="-1"></a>            <span class="at">.groups =</span> <span class="st">"drop"</span>)</span>
<span id="cb6-196"><a href="#cb6-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-197"><a href="#cb6-197" aria-hidden="true" tabindex="-1"></a><span class="co"># 그래프 4 : 검증기간중 코스피200지수 추이</span></span>
<span id="cb6-198"><a href="#cb6-198" aria-hidden="true" tabindex="-1"></a>graph4 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(idx_raw, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">ymd</span>(BAS_DD))) <span class="sc">+</span></span>
<span id="cb6-199"><a href="#cb6-199" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> KOSPI200, <span class="at">color =</span> <span class="st">"KOSPI200"</span>), <span class="at">size =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb6-200"><a href="#cb6-200" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> (VKOSPI200 <span class="sc">-</span> <span class="dv">19</span>) <span class="sc">/</span> <span class="dv">26</span> <span class="sc">*</span> <span class="dv">60</span> <span class="sc">+</span> <span class="dv">300</span>, <span class="at">color =</span> <span class="st">"VKOSPI200"</span>), <span class="at">size =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb6-201"><a href="#cb6-201" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fu">ymd</span>(<span class="fu">c</span>(<span class="st">"20250313"</span>, <span class="st">"20250320"</span>, <span class="st">"20250327"</span>, <span class="st">"20250403"</span>,<span class="st">"20250410"</span>)),</span>
<span id="cb6-202"><a href="#cb6-202" aria-hidden="true" tabindex="-1"></a>             <span class="at">linetype =</span> <span class="st">"dotted"</span>, <span class="at">color =</span> <span class="st">"grey40"</span>) <span class="sc">+</span></span>
<span id="cb6-203"><a href="#cb6-203" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">name =</span> <span class="st">"KOSPI200"</span>,<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">300</span>, <span class="dv">360</span>),</span>
<span id="cb6-204"><a href="#cb6-204" aria-hidden="true" tabindex="-1"></a>                     <span class="at">sec.axis =</span> <span class="fu">sec_axis</span>(</span>
<span id="cb6-205"><a href="#cb6-205" aria-hidden="true" tabindex="-1"></a>                       <span class="sc">~</span> (.<span class="sc">-</span><span class="dv">300</span>) <span class="sc">/</span> <span class="dv">60</span> <span class="sc">*</span> <span class="dv">26</span> <span class="sc">+</span> <span class="dv">19</span>, <span class="at">name =</span> <span class="st">"VKOSPI200"</span>)) <span class="sc">+</span></span>
<span id="cb6-206"><a href="#cb6-206" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"KOSPI200"</span> <span class="ot">=</span> <span class="st">"blue"</span>, <span class="st">"VKOSPI200"</span> <span class="ot">=</span> <span class="st">"red"</span>),</span>
<span id="cb6-207"><a href="#cb6-207" aria-hidden="true" tabindex="-1"></a>                     <span class="at">guide =</span> <span class="fu">guide_legend</span>(<span class="at">direction =</span> <span class="st">"horizontal"</span>)) <span class="sc">+</span></span>
<span id="cb6-208"><a href="#cb6-208" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Kospi200 &amp; V-Kospi200 indices"</span>,<span class="at">x =</span> <span class="cn">NULL</span>,<span class="at">color =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb6-209"><a href="#cb6-209" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb6-210"><a href="#cb6-210" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_date</span>(<span class="at">date_breaks =</span> <span class="st">"3 days"</span>, <span class="at">date_labels =</span> <span class="st">"%m-%d"</span>) <span class="sc">+</span></span>
<span id="cb6-211"><a href="#cb6-211" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>),</span>
<span id="cb6-212"><a href="#cb6-212" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">0.95</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>


<!-- -->

</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./사례1.html" class="pagination-link" aria-label="사례로 보는 금융공학 실무">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">사례로 보는 금융공학 실무</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./장외파생1.html" class="pagination-link" aria-label="장외파생상품 기초 실무">
        <span class="nav-page-text">장외파생상품 기초 실무</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb7" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu"># 코스피200 변동성 조정 위클리 양매도 전략 {.unnumbered}</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>25년도 봄학기 금융공학 특수논제 &lt;사례로 보는 금융공학 실무&gt; A조</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>**김경재(20259048) / 강상묵(20259013) / 김형환(20249132) / 어환석(20259248) / 유수형(20259273)**</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: true</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a><span class="co">#| error: false</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a><span class="co">#| output: false</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list=</span><span class="fu">ls</span>())</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(knitr)</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. 원본데이터 준비</span></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>options_raw <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/options_data.csv"</span>) <span class="sc">%&gt;%</span> <span class="fu">tibble</span>()</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>idx_raw <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/idx_data.csv"</span>) <span class="sc">%&gt;%</span> <span class="fu">tibble</span>()</span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>mmf_raw <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/mmf.csv"</span>) <span class="sc">%&gt;%</span> <span class="fu">tibble</span>()</span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a><span class="co"># 2-1. 데이터 전처리 : KRX openAPI 옵션데이터 전처리</span></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>options <span class="ot">&lt;-</span> options_raw <span class="sc">%&gt;%</span> </span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>  <span class="co"># K200, WK200 이외의 옵션 제외</span></span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">substr</span>(PROD_NM,<span class="dv">1</span>,<span class="dv">3</span>)<span class="sc">==</span><span class="st">"코스피"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 종가가 없는 경우 익일 기준가격(이론가격) 사용</span></span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">PRICE =</span> <span class="fu">as.double</span>(<span class="fu">if_else</span>(TDD_CLSPRC<span class="sc">==</span><span class="st">"-"</span>,NXTDD_BAS_PRC,TDD_CLSPRC))) <span class="sc">%&gt;%</span> </span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>(PRICE) <span class="sc">%&gt;%</span> </span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(BAS_DD,ISU_NM,PRICE,ACC_TRDVOL) <span class="sc">%&gt;%</span> </span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">separate</span>(ISU_NM, <span class="at">into=</span><span class="fu">c</span>(<span class="st">"PROD"</span>,<span class="st">"RGHT"</span>,<span class="st">"EXP"</span>,<span class="st">"EXER_PRC"</span>), <span class="at">sep=</span><span class="st">' '</span>) <span class="sc">%&gt;%</span></span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">EXER_PRC=</span><span class="fu">as.double</span>(EXER_PRC),</span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>         <span class="at">EXPMM=</span><span class="fu">if_else</span>(PROD<span class="sc">==</span><span class="st">"코스피200"</span>,<span class="fu">substr</span>(EXP,<span class="dv">3</span>,<span class="dv">6</span>),<span class="fu">substr</span>(EXP,<span class="dv">1</span>,<span class="dv">4</span>)),</span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a>         <span class="at">EXPWW=</span><span class="fu">if_else</span>(PROD<span class="sc">==</span><span class="st">"코스피200"</span>,<span class="dv">2</span>,<span class="fu">as.integer</span>(<span class="fu">substr</span>(EXP,<span class="dv">6</span>,<span class="dv">6</span>)))) <span class="sc">%&gt;%</span> </span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(EXER_PRC<span class="sc">&gt;</span><span class="fu">min</span>(idx_raw<span class="sc">$</span>KOSPI200)<span class="sc">*</span><span class="fl">0.85</span>,</span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a>         EXER_PRC<span class="sc">&lt;</span><span class="fu">max</span>(idx_raw<span class="sc">$</span>KOSPI200)<span class="sc">*</span><span class="fl">1.15</span>,</span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a>         PROD<span class="sc">!=</span><span class="st">"코스피위클리M"</span>) <span class="sc">%&gt;%</span> <span class="co"># 월요일 만기 위클리옵션 제외</span></span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">PRIOR=</span><span class="fu">as.integer</span>(EXPMM)<span class="sc">*</span><span class="dv">10</span><span class="sc">+</span>EXPWW) <span class="co"># 만기가 짧은 순으로 우선순위 부여</span></span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a><span class="co"># 2-2. 데이터 전처리 : 옵션 만기일 데이터 생성</span></span>
<span id="cb7-44"><a href="#cb7-44" aria-hidden="true" tabindex="-1"></a>target_date <span class="ot">&lt;-</span> options <span class="sc">%&gt;%</span> </span>
<span id="cb7-45"><a href="#cb7-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(.,BAS_DD, PRIOR) <span class="sc">%&gt;%</span> </span>
<span id="cb7-46"><a href="#cb7-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(PRIOR, <span class="fu">desc</span>(BAS_DD)) <span class="sc">%&gt;%</span> </span>
<span id="cb7-47"><a href="#cb7-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(PRIOR) <span class="sc">%&gt;%</span> </span>
<span id="cb7-48"><a href="#cb7-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-49"><a href="#cb7-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb7-50"><a href="#cb7-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(BAS_DD) <span class="sc">%&gt;%</span> </span>
<span id="cb7-51"><a href="#cb7-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(BAS_DD)) <span class="sc">%&gt;%</span> </span>
<span id="cb7-52"><a href="#cb7-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(BAS_DD<span class="sc">&lt;</span><span class="dv">20241231</span>, BAS_DD<span class="sc">&gt;</span><span class="dv">20200101</span>)</span>
<span id="cb7-53"><a href="#cb7-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-54"><a href="#cb7-54" aria-hidden="true" tabindex="-1"></a><span class="co"># 2-3. 데이터 전처리 : KRX 정보데이터시스템 K200 및 V-K200지수 전처리</span></span>
<span id="cb7-55"><a href="#cb7-55" aria-hidden="true" tabindex="-1"></a>idx_data <span class="ot">&lt;-</span> idx_raw <span class="sc">%&gt;%</span></span>
<span id="cb7-56"><a href="#cb7-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(BAS_DD) <span class="sc">%&gt;%</span> </span>
<span id="cb7-57"><a href="#cb7-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">LAG_K200=</span><span class="fu">lag</span>(KOSPI200),</span>
<span id="cb7-58"><a href="#cb7-58" aria-hidden="true" tabindex="-1"></a>         <span class="at">LAG_VK200=</span><span class="fu">lag</span>(VKOSPI200))</span>
<span id="cb7-59"><a href="#cb7-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-60"><a href="#cb7-60" aria-hidden="true" tabindex="-1"></a>K200_portfolio<span class="ot">=</span>idx_data <span class="sc">%&gt;%</span> </span>
<span id="cb7-61"><a href="#cb7-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(mmf_raw, <span class="at">by=</span><span class="st">"BAS_DD"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-62"><a href="#cb7-62" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">RATE=</span>(KOSPI200<span class="sc">-</span>LAG_K200)<span class="sc">/</span>LAG_K200,</span>
<span id="cb7-63"><a href="#cb7-63" aria-hidden="true" tabindex="-1"></a>         <span class="at">YEAR =</span> <span class="fu">substr</span>(BAS_DD, <span class="dv">1</span>, <span class="dv">4</span>),</span>
<span id="cb7-64"><a href="#cb7-64" aria-hidden="true" tabindex="-1"></a>         <span class="at">YM =</span> <span class="fu">ym</span>(<span class="fu">substr</span>(BAS_DD, <span class="dv">1</span>, <span class="dv">6</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb7-65"><a href="#cb7-65" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(YEAR, YM) <span class="sc">%&gt;%</span></span>
<span id="cb7-66"><a href="#cb7-66" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">RATE_K200 =</span> <span class="fu">if_else</span>(<span class="fu">is.na</span>(<span class="fu">prod</span>(<span class="dv">1</span> <span class="sc">+</span> RATE)),<span class="dv">0</span>,<span class="fu">prod</span>(<span class="dv">1</span> <span class="sc">+</span> RATE)),</span>
<span id="cb7-67"><a href="#cb7-67" aria-hidden="true" tabindex="-1"></a>            <span class="at">MMF =</span> <span class="fu">mean</span>(MMF)<span class="sc">/</span><span class="dv">100</span>,</span>
<span id="cb7-68"><a href="#cb7-68" aria-hidden="true" tabindex="-1"></a>            <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb7-69"><a href="#cb7-69" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb7-70"><a href="#cb7-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-71"><a href="#cb7-71" aria-hidden="true" tabindex="-1"></a><span class="co"># 3-1. 포트폴리오 구성 : VW양매도 포트폴리오 기초정보 생성</span></span>
<span id="cb7-72"><a href="#cb7-72" aria-hidden="true" tabindex="-1"></a>target_info <span class="ot">&lt;-</span> target_date <span class="sc">%&gt;%</span> </span>
<span id="cb7-73"><a href="#cb7-73" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(options, <span class="at">by=</span><span class="st">"BAS_DD"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-74"><a href="#cb7-74" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(BAS_DD,PRIOR) <span class="sc">%&gt;%</span> </span>
<span id="cb7-75"><a href="#cb7-75" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(BAS_DD),PRIOR) <span class="sc">%&gt;%</span> </span>
<span id="cb7-76"><a href="#cb7-76" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(BAS_DD) <span class="sc">%&gt;%</span> </span>
<span id="cb7-77"><a href="#cb7-77" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 만기가 도래하는 옵션을 제외하고 우선순위가 높은 옵션 선택</span></span>
<span id="cb7-78"><a href="#cb7-78" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">2</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-79"><a href="#cb7-79" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb7-80"><a href="#cb7-80" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(BAS_DD)) <span class="sc">%&gt;%</span> </span>
<span id="cb7-81"><a href="#cb7-81" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(idx_data, <span class="at">by=</span><span class="st">"BAS_DD"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-82"><a href="#cb7-82" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(mmf_raw, <span class="at">by=</span><span class="st">"BAS_DD"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-83"><a href="#cb7-83" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 옵션 보유기간 및 단기금리(MMF) 계산</span></span>
<span id="cb7-84"><a href="#cb7-84" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">DIFF_DAY=</span><span class="fu">as.integer</span>(<span class="fu">ymd</span>(<span class="fu">lag</span>(BAS_DD))<span class="sc">-</span><span class="fu">ymd</span>(BAS_DD)),</span>
<span id="cb7-85"><a href="#cb7-85" aria-hidden="true" tabindex="-1"></a>         <span class="at">MMF=</span>MMF<span class="sc">*</span><span class="fl">0.01</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-86"><a href="#cb7-86" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 옵션 보유기간에 해당하는 시장기대변동성 계산(V-K200활용)</span></span>
<span id="cb7-87"><a href="#cb7-87" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">VOL=</span>LAG_VK200<span class="sc">*</span><span class="fu">sqrt</span>(DIFF_DAY)<span class="sc">/</span><span class="fu">sqrt</span>(<span class="dv">365</span>)<span class="sc">/</span><span class="dv">100</span>) <span class="sc">%&gt;%</span></span>
<span id="cb7-88"><a href="#cb7-88" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 변동성에 따른 옵션 행사가격 상단(2.5단위 올림) 및 하단(2.5단위 내림) 계산</span></span>
<span id="cb7-89"><a href="#cb7-89" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">TARGET_C_K=</span><span class="fu">ceiling</span>(KOSPI200<span class="sc">*</span>(<span class="dv">1</span><span class="sc">+</span>VOL)<span class="sc">*</span><span class="fl">0.4</span>)<span class="sc">/</span><span class="fl">0.4</span>,</span>
<span id="cb7-90"><a href="#cb7-90" aria-hidden="true" tabindex="-1"></a>         <span class="at">TARGET_P_K=</span><span class="fu">floor</span>(KOSPI200<span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span>VOL)<span class="sc">*</span><span class="fl">0.4</span>)<span class="sc">/</span><span class="fl">0.4</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-91"><a href="#cb7-91" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>(DIFF_DAY) <span class="sc">%&gt;%</span> </span>
<span id="cb7-92"><a href="#cb7-92" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(BAS_DD,VOL,DIFF_DAY,MMF,KOSPI200,LAG_VK200,PRIOR,TARGET_C_K,TARGET_P_K)</span>
<span id="cb7-93"><a href="#cb7-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-94"><a href="#cb7-94" aria-hidden="true" tabindex="-1"></a><span class="co"># 3-2. 포트폴리오 구성 : VW양매도 포트폴리오 거래대상 옵션 정보 생성</span></span>
<span id="cb7-95"><a href="#cb7-95" aria-hidden="true" tabindex="-1"></a>target_options <span class="ot">&lt;-</span> target_info <span class="sc">%&gt;%</span> </span>
<span id="cb7-96"><a href="#cb7-96" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(BAS_DD, PRIOR, TARGET_C_K, TARGET_P_K) <span class="sc">%&gt;%</span> </span>
<span id="cb7-97"><a href="#cb7-97" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols=</span><span class="fu">c</span>(<span class="st">"TARGET_C_K"</span>,<span class="st">"TARGET_P_K"</span>),<span class="at">names_to =</span> <span class="st">"GRP"</span>, <span class="at">values_to =</span> <span class="st">"EXER_PRC"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-98"><a href="#cb7-98" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">RGHT=</span><span class="fu">substr</span>(GRP,<span class="dv">8</span>,<span class="dv">8</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb7-99"><a href="#cb7-99" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(options,<span class="at">by=</span><span class="fu">c</span>(<span class="st">"BAS_DD"</span>,<span class="st">"PRIOR"</span>,<span class="st">"RGHT"</span>,<span class="st">"EXER_PRC"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb7-100"><a href="#cb7-100" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(BAS_DD,GRP,PRICE,ACC_TRDVOL) <span class="sc">%&gt;%</span> </span>
<span id="cb7-101"><a href="#cb7-101" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> <span class="st">"GRP"</span>, <span class="at">values_from =</span> <span class="fu">c</span>(<span class="st">"PRICE"</span>,<span class="st">"ACC_TRDVOL"</span>))</span>
<span id="cb7-102"><a href="#cb7-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-103"><a href="#cb7-103" aria-hidden="true" tabindex="-1"></a><span class="co"># 원금 100억원 가정</span></span>
<span id="cb7-104"><a href="#cb7-104" aria-hidden="true" tabindex="-1"></a>cash <span class="ot">=</span> <span class="dv">10000</span><span class="sc">*</span><span class="dv">10000</span><span class="sc">*</span><span class="dv">100</span></span>
<span id="cb7-105"><a href="#cb7-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-106"><a href="#cb7-106" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. 포트폴리오 구현 : VW양매도 전략을 구현하여 일자별 손익 계산</span></span>
<span id="cb7-107"><a href="#cb7-107" aria-hidden="true" tabindex="-1"></a>portfolio <span class="ot">&lt;-</span> target_info <span class="sc">%&gt;%</span> </span>
<span id="cb7-108"><a href="#cb7-108" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(target_options,<span class="at">by=</span><span class="st">"BAS_DD"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-109"><a href="#cb7-109" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(BAS_DD) <span class="sc">%&gt;%</span> </span>
<span id="cb7-110"><a href="#cb7-110" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 원금에 따른 옵션 매도수량 계산</span></span>
<span id="cb7-111"><a href="#cb7-111" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">SELL_AMT=</span>cash<span class="sc">/</span><span class="dv">250000</span><span class="sc">/</span>KOSPI200) <span class="sc">%&gt;%</span> </span>
<span id="cb7-112"><a href="#cb7-112" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 옵션 프리미엄(매도수익)) 계산</span></span>
<span id="cb7-113"><a href="#cb7-113" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">PREMIUM=</span>SELL_AMT<span class="sc">*</span>(PRICE_TARGET_C_K<span class="sc">+</span>PRICE_TARGET_P_K)<span class="sc">*</span><span class="dv">250000</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-114"><a href="#cb7-114" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 원금 및 프리미엄의 MMF 이자수익 및 권리행사손실 계산</span></span>
<span id="cb7-115"><a href="#cb7-115" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">INTEREST=</span>(cash<span class="sc">+</span><span class="fu">replace_na</span>(PREMIUM,<span class="dv">0</span>))<span class="sc">*</span>MMF<span class="sc">*</span>DIFF_DAY<span class="sc">/</span><span class="dv">365</span>,</span>
<span id="cb7-116"><a href="#cb7-116" aria-hidden="true" tabindex="-1"></a>         <span class="at">EXERCISE=</span>(<span class="fu">if_else</span>(<span class="fu">lead</span>(KOSPI200)<span class="sc">-</span>TARGET_C_K<span class="sc">&gt;</span><span class="dv">0</span>,<span class="fu">lead</span>(KOSPI200)<span class="sc">-</span>TARGET_C_K,<span class="dv">0</span>)<span class="sc">+</span></span>
<span id="cb7-117"><a href="#cb7-117" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">if_else</span>(TARGET_P_K<span class="sc">-</span><span class="fu">lead</span>(KOSPI200)<span class="sc">&gt;</span><span class="dv">0</span>,TARGET_P_K<span class="sc">-</span><span class="fu">lead</span>(KOSPI200),<span class="dv">0</span>))<span class="sc">*</span><span class="dv">250000</span><span class="sc">*</span>SELL_AMT) <span class="sc">%&gt;%</span> </span>
<span id="cb7-118"><a href="#cb7-118" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 주단위 포트폴리오 손익 계산(원금 100억 가정, 당일 투자시 다음주 실현손익을 의미)</span></span>
<span id="cb7-119"><a href="#cb7-119" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">REVENUE=</span>PREMIUM<span class="sc">+</span>INTEREST<span class="sc">-</span>EXERCISE) <span class="sc">%&gt;%</span> </span>
<span id="cb7-120"><a href="#cb7-120" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 거래대상 옵션이 상장되어있지 않은 경우, MMF수익만 고려</span></span>
<span id="cb7-121"><a href="#cb7-121" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">REVENUE=</span><span class="fu">if_else</span>(<span class="fu">is.na</span>(REVENUE),INTEREST,REVENUE)) <span class="sc">%&gt;%</span> </span>
<span id="cb7-122"><a href="#cb7-122" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">RATE=</span>REVENUE<span class="sc">/</span>cash)  <span class="co"># 주단위 포트폴리오 수익률</span></span>
<span id="cb7-123"><a href="#cb7-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-124"><a href="#cb7-124" aria-hidden="true" tabindex="-1"></a><span class="co"># 5. 비교군 포트폴리오 생성 : 월별 5% OTM 양매도 전략</span></span>
<span id="cb7-125"><a href="#cb7-125" aria-hidden="true" tabindex="-1"></a>options2 <span class="ot">&lt;-</span> options <span class="sc">%&gt;%</span> </span>
<span id="cb7-126"><a href="#cb7-126" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(PROD<span class="sc">==</span><span class="st">"코스피200"</span>)</span>
<span id="cb7-127"><a href="#cb7-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-128"><a href="#cb7-128" aria-hidden="true" tabindex="-1"></a><span class="co"># 옵션 만기일(매달) 생성</span></span>
<span id="cb7-129"><a href="#cb7-129" aria-hidden="true" tabindex="-1"></a>target_date2 <span class="ot">&lt;-</span> options2 <span class="sc">%&gt;%</span> </span>
<span id="cb7-130"><a href="#cb7-130" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(.,BAS_DD, PRIOR) <span class="sc">%&gt;%</span> </span>
<span id="cb7-131"><a href="#cb7-131" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(PRIOR, <span class="fu">desc</span>(BAS_DD)) <span class="sc">%&gt;%</span> </span>
<span id="cb7-132"><a href="#cb7-132" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(PRIOR) <span class="sc">%&gt;%</span> </span>
<span id="cb7-133"><a href="#cb7-133" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-134"><a href="#cb7-134" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb7-135"><a href="#cb7-135" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(BAS_DD) <span class="sc">%&gt;%</span> </span>
<span id="cb7-136"><a href="#cb7-136" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(BAS_DD)) <span class="sc">%&gt;%</span> </span>
<span id="cb7-137"><a href="#cb7-137" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(BAS_DD<span class="sc">&lt;</span><span class="dv">20241231</span>, BAS_DD<span class="sc">&gt;</span><span class="dv">20200101</span>)</span>
<span id="cb7-138"><a href="#cb7-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-139"><a href="#cb7-139" aria-hidden="true" tabindex="-1"></a><span class="co"># 일반 양매도 포트폴리오 기본 정보 생성</span></span>
<span id="cb7-140"><a href="#cb7-140" aria-hidden="true" tabindex="-1"></a>target_info2 <span class="ot">&lt;-</span> target_date2 <span class="sc">%&gt;%</span> </span>
<span id="cb7-141"><a href="#cb7-141" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(options2, <span class="at">by=</span><span class="st">"BAS_DD"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-142"><a href="#cb7-142" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(BAS_DD,PRIOR) <span class="sc">%&gt;%</span> </span>
<span id="cb7-143"><a href="#cb7-143" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(BAS_DD),PRIOR) <span class="sc">%&gt;%</span> </span>
<span id="cb7-144"><a href="#cb7-144" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(BAS_DD) <span class="sc">%&gt;%</span> </span>
<span id="cb7-145"><a href="#cb7-145" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 만기가 도래하는 옵션을 제외하고 우선순위가 높은 옵션 선택</span></span>
<span id="cb7-146"><a href="#cb7-146" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">2</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-147"><a href="#cb7-147" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb7-148"><a href="#cb7-148" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(BAS_DD)) <span class="sc">%&gt;%</span> </span>
<span id="cb7-149"><a href="#cb7-149" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(idx_data, <span class="at">by=</span><span class="st">"BAS_DD"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-150"><a href="#cb7-150" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(mmf_raw, <span class="at">by=</span><span class="st">"BAS_DD"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-151"><a href="#cb7-151" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 옵션 보유기간 및 단기금리(MMF) 계산</span></span>
<span id="cb7-152"><a href="#cb7-152" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">DIFF_DAY=</span><span class="fu">as.integer</span>(<span class="fu">ymd</span>(<span class="fu">lag</span>(BAS_DD))<span class="sc">-</span><span class="fu">ymd</span>(BAS_DD)),</span>
<span id="cb7-153"><a href="#cb7-153" aria-hidden="true" tabindex="-1"></a>         <span class="at">MMF=</span>MMF<span class="sc">*</span><span class="fl">0.01</span>,</span>
<span id="cb7-154"><a href="#cb7-154" aria-hidden="true" tabindex="-1"></a>         <span class="at">VOL=</span><span class="fl">0.05</span>) <span class="sc">%&gt;%</span></span>
<span id="cb7-155"><a href="#cb7-155" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 변동성에 따른 옵션 행사가격 상단(2.5단위 올림) 및 하단(2.5단위 내림) 계산</span></span>
<span id="cb7-156"><a href="#cb7-156" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">TARGET_C_K=</span><span class="fu">ceiling</span>(KOSPI200<span class="sc">*</span>(<span class="dv">1</span><span class="sc">+</span>VOL)<span class="sc">*</span><span class="fl">0.4</span>)<span class="sc">/</span><span class="fl">0.4</span>,</span>
<span id="cb7-157"><a href="#cb7-157" aria-hidden="true" tabindex="-1"></a>         <span class="at">TARGET_P_K=</span><span class="fu">floor</span>(KOSPI200<span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span>VOL)<span class="sc">*</span><span class="fl">0.4</span>)<span class="sc">/</span><span class="fl">0.4</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-158"><a href="#cb7-158" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">DIFF_DAY=</span><span class="fu">if_else</span>(<span class="fu">is.na</span>(DIFF_DAY),<span class="dv">28</span>,DIFF_DAY)) <span class="sc">%&gt;%</span> </span>
<span id="cb7-159"><a href="#cb7-159" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(BAS_DD,VOL,DIFF_DAY,MMF,KOSPI200,LAG_VK200,PRIOR,TARGET_C_K,TARGET_P_K)</span>
<span id="cb7-160"><a href="#cb7-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-161"><a href="#cb7-161" aria-hidden="true" tabindex="-1"></a><span class="co"># 일반 양매도 포트폴리오 거래대상 옵션</span></span>
<span id="cb7-162"><a href="#cb7-162" aria-hidden="true" tabindex="-1"></a>target_options2 <span class="ot">&lt;-</span> target_info2 <span class="sc">%&gt;%</span> </span>
<span id="cb7-163"><a href="#cb7-163" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(BAS_DD, PRIOR, TARGET_C_K, TARGET_P_K) <span class="sc">%&gt;%</span> </span>
<span id="cb7-164"><a href="#cb7-164" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols=</span><span class="fu">c</span>(<span class="st">"TARGET_C_K"</span>,<span class="st">"TARGET_P_K"</span>),<span class="at">names_to =</span> <span class="st">"GRP"</span>, <span class="at">values_to =</span> <span class="st">"EXER_PRC"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-165"><a href="#cb7-165" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">RGHT=</span><span class="fu">substr</span>(GRP,<span class="dv">8</span>,<span class="dv">8</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb7-166"><a href="#cb7-166" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(options2,<span class="at">by=</span><span class="fu">c</span>(<span class="st">"BAS_DD"</span>,<span class="st">"PRIOR"</span>,<span class="st">"RGHT"</span>,<span class="st">"EXER_PRC"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb7-167"><a href="#cb7-167" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(BAS_DD,GRP,PRICE,ACC_TRDVOL) <span class="sc">%&gt;%</span> </span>
<span id="cb7-168"><a href="#cb7-168" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> <span class="st">"GRP"</span>, <span class="at">values_from =</span> <span class="fu">c</span>(<span class="st">"PRICE"</span>,<span class="st">"ACC_TRDVOL"</span>))</span>
<span id="cb7-169"><a href="#cb7-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-170"><a href="#cb7-170" aria-hidden="true" tabindex="-1"></a><span class="co"># 일반 양매도 포트폴리오 구현</span></span>
<span id="cb7-171"><a href="#cb7-171" aria-hidden="true" tabindex="-1"></a>portfolio2 <span class="ot">&lt;-</span> target_info2 <span class="sc">%&gt;%</span> </span>
<span id="cb7-172"><a href="#cb7-172" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(target_options2,<span class="at">by=</span><span class="st">"BAS_DD"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-173"><a href="#cb7-173" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(BAS_DD) <span class="sc">%&gt;%</span> </span>
<span id="cb7-174"><a href="#cb7-174" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 원금에 따른 옵션 매도수량 계산</span></span>
<span id="cb7-175"><a href="#cb7-175" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">SELL_AMT=</span>cash<span class="sc">/</span><span class="dv">250000</span><span class="sc">/</span>KOSPI200) <span class="sc">%&gt;%</span> </span>
<span id="cb7-176"><a href="#cb7-176" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 옵션 프리미엄(매도수익)) 계산</span></span>
<span id="cb7-177"><a href="#cb7-177" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">PREMIUM=</span>SELL_AMT<span class="sc">*</span>(PRICE_TARGET_C_K<span class="sc">+</span>PRICE_TARGET_P_K)<span class="sc">*</span><span class="dv">250000</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-178"><a href="#cb7-178" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 원금 및 프리미엄의 MMF 이자수익 및 권리행사손실 계산</span></span>
<span id="cb7-179"><a href="#cb7-179" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">INTEREST=</span>(cash<span class="sc">+</span><span class="fu">replace_na</span>(PREMIUM,<span class="dv">0</span>))<span class="sc">*</span>MMF<span class="sc">*</span>DIFF_DAY<span class="sc">/</span><span class="dv">365</span>,</span>
<span id="cb7-180"><a href="#cb7-180" aria-hidden="true" tabindex="-1"></a>         <span class="at">EXERCISE=</span>(<span class="fu">if_else</span>(<span class="fu">lead</span>(KOSPI200)<span class="sc">-</span>TARGET_C_K<span class="sc">&gt;</span><span class="dv">0</span>,<span class="fu">lead</span>(KOSPI200)<span class="sc">-</span>TARGET_C_K,<span class="dv">0</span>)<span class="sc">+</span></span>
<span id="cb7-181"><a href="#cb7-181" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">if_else</span>(TARGET_P_K<span class="sc">-</span><span class="fu">lead</span>(KOSPI200)<span class="sc">&gt;</span><span class="dv">0</span>,TARGET_P_K<span class="sc">-</span><span class="fu">lead</span>(KOSPI200),<span class="dv">0</span>))<span class="sc">*</span><span class="dv">250000</span><span class="sc">*</span>SELL_AMT) <span class="sc">%&gt;%</span> </span>
<span id="cb7-182"><a href="#cb7-182" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">EXERCISE=</span><span class="fu">if_else</span>(<span class="fu">is.na</span>(EXERCISE),<span class="dv">0</span>,EXERCISE)) <span class="sc">%&gt;%</span> </span>
<span id="cb7-183"><a href="#cb7-183" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 주단위 포트폴리오 손익 계산(원금 100억 가정, 당일 투자시 다음주 실현손익을 의미)</span></span>
<span id="cb7-184"><a href="#cb7-184" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">REVENUE=</span>PREMIUM<span class="sc">+</span>INTEREST<span class="sc">-</span>EXERCISE) <span class="sc">%&gt;%</span> </span>
<span id="cb7-185"><a href="#cb7-185" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 거래대상 옵션이 상장되어있지 않은 경우, MMF수익만 고려</span></span>
<span id="cb7-186"><a href="#cb7-186" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">REVENUE=</span><span class="fu">if_else</span>(<span class="fu">is.na</span>(REVENUE),INTEREST,REVENUE)) <span class="sc">%&gt;%</span> </span>
<span id="cb7-187"><a href="#cb7-187" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">RATE=</span>REVENUE<span class="sc">/</span>cash) <span class="co"># 주단위 포트폴리오 수익률</span></span>
<span id="cb7-188"><a href="#cb7-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-189"><a href="#cb7-189" aria-hidden="true" tabindex="-1"></a><span class="co"># 6. 성과분석 : VW양매도 포트폴리오</span></span>
<span id="cb7-190"><a href="#cb7-190" aria-hidden="true" tabindex="-1"></a>performance <span class="ot">&lt;-</span> portfolio <span class="sc">%&gt;%</span></span>
<span id="cb7-191"><a href="#cb7-191" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>(PREMIUM, EXERCISE) <span class="sc">%&gt;%</span></span>
<span id="cb7-192"><a href="#cb7-192" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">YEAR =</span> <span class="fu">substr</span>(BAS_DD, <span class="dv">1</span>, <span class="dv">4</span>),</span>
<span id="cb7-193"><a href="#cb7-193" aria-hidden="true" tabindex="-1"></a>         <span class="at">YM =</span> <span class="fu">ym</span>(<span class="fu">substr</span>(BAS_DD, <span class="dv">1</span>, <span class="dv">6</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb7-194"><a href="#cb7-194" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(YEAR, YM) <span class="sc">%&gt;%</span></span>
<span id="cb7-195"><a href="#cb7-195" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">PREMIUM =</span> <span class="fu">sum</span>(PREMIUM),</span>
<span id="cb7-196"><a href="#cb7-196" aria-hidden="true" tabindex="-1"></a>            <span class="at">INTEREST =</span> <span class="fu">sum</span>(INTEREST),</span>
<span id="cb7-197"><a href="#cb7-197" aria-hidden="true" tabindex="-1"></a>            <span class="at">EXERCISE =</span> <span class="fu">sum</span>(EXERCISE),</span>
<span id="cb7-198"><a href="#cb7-198" aria-hidden="true" tabindex="-1"></a>            <span class="at">REVENUE =</span> <span class="fu">sum</span>(REVENUE),</span>
<span id="cb7-199"><a href="#cb7-199" aria-hidden="true" tabindex="-1"></a>            <span class="at">RATE =</span> <span class="fu">prod</span>(<span class="dv">1</span> <span class="sc">+</span> RATE),</span>
<span id="cb7-200"><a href="#cb7-200" aria-hidden="true" tabindex="-1"></a>            <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb7-201"><a href="#cb7-201" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb7-202"><a href="#cb7-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-203"><a href="#cb7-203" aria-hidden="true" tabindex="-1"></a><span class="co"># 6. 성과분석 : 일반 양매도 포트폴리오</span></span>
<span id="cb7-204"><a href="#cb7-204" aria-hidden="true" tabindex="-1"></a>performance2 <span class="ot">&lt;-</span> portfolio2 <span class="sc">%&gt;%</span></span>
<span id="cb7-205"><a href="#cb7-205" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>(PREMIUM, EXERCISE) <span class="sc">%&gt;%</span></span>
<span id="cb7-206"><a href="#cb7-206" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">YEAR =</span> <span class="fu">substr</span>(BAS_DD, <span class="dv">1</span>, <span class="dv">4</span>),</span>
<span id="cb7-207"><a href="#cb7-207" aria-hidden="true" tabindex="-1"></a>         <span class="at">YM =</span> <span class="fu">ym</span>(<span class="fu">substr</span>(BAS_DD, <span class="dv">1</span>, <span class="dv">6</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb7-208"><a href="#cb7-208" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(YEAR, YM) <span class="sc">%&gt;%</span></span>
<span id="cb7-209"><a href="#cb7-209" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">PREMIUM =</span> <span class="fu">sum</span>(PREMIUM),</span>
<span id="cb7-210"><a href="#cb7-210" aria-hidden="true" tabindex="-1"></a>            <span class="at">INTEREST =</span> <span class="fu">sum</span>(INTEREST),</span>
<span id="cb7-211"><a href="#cb7-211" aria-hidden="true" tabindex="-1"></a>            <span class="at">EXERCISE =</span> <span class="fu">sum</span>(EXERCISE),</span>
<span id="cb7-212"><a href="#cb7-212" aria-hidden="true" tabindex="-1"></a>            <span class="at">REVENUE =</span> <span class="fu">sum</span>(REVENUE),</span>
<span id="cb7-213"><a href="#cb7-213" aria-hidden="true" tabindex="-1"></a>            <span class="at">RATE =</span> <span class="fu">prod</span>(<span class="dv">1</span> <span class="sc">+</span> RATE),</span>
<span id="cb7-214"><a href="#cb7-214" aria-hidden="true" tabindex="-1"></a>            <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb7-215"><a href="#cb7-215" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb7-216"><a href="#cb7-216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-217"><a href="#cb7-217" aria-hidden="true" tabindex="-1"></a><span class="co"># 시각화 등</span></span>
<span id="cb7-218"><a href="#cb7-218" aria-hidden="true" tabindex="-1"></a>graph1_1 <span class="ot">&lt;-</span> performance <span class="sc">%&gt;%</span></span>
<span id="cb7-219"><a href="#cb7-219" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(YM) <span class="sc">%&gt;%</span></span>
<span id="cb7-220"><a href="#cb7-220" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(K200_portfolio,<span class="at">by=</span><span class="fu">c</span>(<span class="st">"YEAR"</span>,<span class="st">"YM"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb7-221"><a href="#cb7-221" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">CUM_RATE =</span> <span class="fu">cumprod</span>(RATE) <span class="sc">*</span> <span class="dv">100</span> <span class="sc">-</span> <span class="dv">100</span>,</span>
<span id="cb7-222"><a href="#cb7-222" aria-hidden="true" tabindex="-1"></a>         <span class="at">CUM_RATE_K200 =</span> <span class="fu">cumprod</span>(RATE_K200) <span class="sc">*</span> <span class="dv">100</span> <span class="sc">-</span> <span class="dv">100</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-223"><a href="#cb7-223" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(<span class="fu">tibble</span>(<span class="at">YM=</span><span class="fu">ym</span>(<span class="dv">201912</span>),<span class="at">CUM_RATE=</span><span class="dv">0</span>,<span class="at">CUM_RATE_K200=</span><span class="dv">0</span>))</span>
<span id="cb7-224"><a href="#cb7-224" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-225"><a href="#cb7-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-226"><a href="#cb7-226" aria-hidden="true" tabindex="-1"></a>graph1_2 <span class="ot">&lt;-</span> performance2 <span class="sc">%&gt;%</span></span>
<span id="cb7-227"><a href="#cb7-227" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(YM) <span class="sc">%&gt;%</span></span>
<span id="cb7-228"><a href="#cb7-228" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(K200_portfolio,<span class="at">by=</span><span class="fu">c</span>(<span class="st">"YEAR"</span>,<span class="st">"YM"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb7-229"><a href="#cb7-229" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">CUM_RATE =</span> <span class="fu">cumprod</span>(RATE) <span class="sc">*</span> <span class="dv">100</span> <span class="sc">-</span> <span class="dv">100</span>,</span>
<span id="cb7-230"><a href="#cb7-230" aria-hidden="true" tabindex="-1"></a>         <span class="at">CUM_RATE_K200 =</span> <span class="fu">cumprod</span>(RATE_K200) <span class="sc">*</span> <span class="dv">100</span> <span class="sc">-</span> <span class="dv">100</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-231"><a href="#cb7-231" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(<span class="fu">tibble</span>(<span class="at">YM=</span><span class="fu">ym</span>(<span class="dv">201912</span>),<span class="at">CUM_RATE=</span><span class="dv">0</span>,<span class="at">CUM_RATE_K200=</span><span class="dv">0</span>))</span>
<span id="cb7-232"><a href="#cb7-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-233"><a href="#cb7-233" aria-hidden="true" tabindex="-1"></a>graph1_3 <span class="ot">&lt;-</span> graph1_1 <span class="sc">%&gt;%</span></span>
<span id="cb7-234"><a href="#cb7-234" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(graph1_2, <span class="at">by =</span> <span class="st">"YM"</span>, <span class="at">suffix =</span> <span class="fu">c</span>(<span class="st">"_1"</span>, <span class="st">"_2"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb7-235"><a href="#cb7-235" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">REVENUE_DIFF =</span> (REVENUE_1 <span class="sc">-</span> REVENUE_2) <span class="sc">/</span> <span class="fl">1e8</span>)</span>
<span id="cb7-236"><a href="#cb7-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-237"><a href="#cb7-237" aria-hidden="true" tabindex="-1"></a>graph2_1 <span class="ot">&lt;-</span> performance <span class="sc">%&gt;%</span></span>
<span id="cb7-238"><a href="#cb7-238" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(YM) <span class="sc">%&gt;%</span></span>
<span id="cb7-239"><a href="#cb7-239" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(K200_portfolio,<span class="at">by=</span><span class="fu">c</span>(<span class="st">"YEAR"</span>,<span class="st">"YM"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb7-240"><a href="#cb7-240" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">as.integer</span>(YEAR) <span class="sc">&gt;</span> <span class="dv">2021</span>) <span class="sc">%&gt;%</span></span>
<span id="cb7-241"><a href="#cb7-241" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">CUM_RATE =</span> <span class="fu">cumprod</span>(RATE) <span class="sc">*</span> <span class="dv">100</span> <span class="sc">-</span> <span class="dv">100</span>,</span>
<span id="cb7-242"><a href="#cb7-242" aria-hidden="true" tabindex="-1"></a>         <span class="at">CUM_RATE_K200 =</span> <span class="fu">cumprod</span>(RATE_K200) <span class="sc">*</span> <span class="dv">100</span> <span class="sc">-</span> <span class="dv">100</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-243"><a href="#cb7-243" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(<span class="fu">tibble</span>(<span class="at">YM=</span><span class="fu">ym</span>(<span class="dv">202112</span>),<span class="at">CUM_RATE=</span><span class="dv">0</span>,<span class="at">CUM_RATE_K200=</span><span class="dv">0</span>))</span>
<span id="cb7-244"><a href="#cb7-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-245"><a href="#cb7-245" aria-hidden="true" tabindex="-1"></a>graph2_2 <span class="ot">&lt;-</span> performance2 <span class="sc">%&gt;%</span></span>
<span id="cb7-246"><a href="#cb7-246" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(YM) <span class="sc">%&gt;%</span></span>
<span id="cb7-247"><a href="#cb7-247" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(K200_portfolio,<span class="at">by=</span><span class="fu">c</span>(<span class="st">"YEAR"</span>,<span class="st">"YM"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb7-248"><a href="#cb7-248" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">as.integer</span>(YEAR) <span class="sc">&gt;</span> <span class="dv">2021</span>) <span class="sc">%&gt;%</span></span>
<span id="cb7-249"><a href="#cb7-249" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">CUM_RATE =</span> <span class="fu">cumprod</span>(RATE) <span class="sc">*</span> <span class="dv">100</span> <span class="sc">-</span> <span class="dv">100</span>,</span>
<span id="cb7-250"><a href="#cb7-250" aria-hidden="true" tabindex="-1"></a>         <span class="at">CUM_RATE_K200 =</span> <span class="fu">cumprod</span>(RATE_K200) <span class="sc">*</span> <span class="dv">100</span> <span class="sc">-</span> <span class="dv">100</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-251"><a href="#cb7-251" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(<span class="fu">tibble</span>(<span class="at">YM=</span><span class="fu">ym</span>(<span class="dv">202112</span>),<span class="at">CUM_RATE=</span><span class="dv">0</span>,<span class="at">CUM_RATE_K200=</span><span class="dv">0</span>))</span>
<span id="cb7-252"><a href="#cb7-252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-253"><a href="#cb7-253" aria-hidden="true" tabindex="-1"></a>graph2_3 <span class="ot">&lt;-</span> graph2_1 <span class="sc">%&gt;%</span></span>
<span id="cb7-254"><a href="#cb7-254" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(graph2_2, <span class="at">by =</span> <span class="st">"YM"</span>, <span class="at">suffix =</span> <span class="fu">c</span>(<span class="st">"_1"</span>, <span class="st">"_2"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb7-255"><a href="#cb7-255" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">REVENUE_DIFF =</span> (REVENUE_1 <span class="sc">-</span> REVENUE_2) <span class="sc">/</span> <span class="fl">1e8</span>)</span>
<span id="cb7-256"><a href="#cb7-256" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-257"><a href="#cb7-257" aria-hidden="true" tabindex="-1"></a>graph3_1 <span class="ot">&lt;-</span> portfolio <span class="sc">%&gt;%</span></span>
<span id="cb7-258"><a href="#cb7-258" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">YM =</span> <span class="fu">ym</span>(<span class="fu">substr</span>(BAS_DD, <span class="dv">1</span>, <span class="dv">6</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb7-259"><a href="#cb7-259" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(YM) <span class="sc">%&gt;%</span></span>
<span id="cb7-260"><a href="#cb7-260" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">TargetVol=</span><span class="fu">mean</span>(VOL),</span>
<span id="cb7-261"><a href="#cb7-261" aria-hidden="true" tabindex="-1"></a>            <span class="at">Kospi200=</span><span class="fu">mean</span>(KOSPI200)) <span class="sc">%&gt;%</span> <span class="fu">ungroup</span>()</span>
<span id="cb7-262"><a href="#cb7-262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-263"><a href="#cb7-263" aria-hidden="true" tabindex="-1"></a>graph1<span class="ot">=</span><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb7-264"><a href="#cb7-264" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> graph1_1, <span class="fu">aes</span>(<span class="at">x =</span> YM, <span class="at">y =</span> CUM_RATE, <span class="at">color =</span> <span class="st">"Vol-adj. Weekly"</span>), <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb7-265"><a href="#cb7-265" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> graph1_1, <span class="fu">aes</span>(<span class="at">x =</span> YM, <span class="at">y =</span> CUM_RATE, <span class="at">color =</span> <span class="st">"Vol-adj. Weekly"</span>), <span class="at">shape =</span> <span class="dv">16</span>, <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb7-266"><a href="#cb7-266" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> graph1_2, <span class="fu">aes</span>(<span class="at">x =</span> YM, <span class="at">y =</span> CUM_RATE, <span class="at">color =</span> <span class="st">"5% OTM Monthly"</span>), <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb7-267"><a href="#cb7-267" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> graph1_2, <span class="fu">aes</span>(<span class="at">x =</span> YM, <span class="at">y =</span> CUM_RATE, <span class="at">color =</span> <span class="st">"5% OTM Monthly"</span>), <span class="at">shape =</span> <span class="dv">16</span>, <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb7-268"><a href="#cb7-268" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> graph1_1, <span class="fu">aes</span>(<span class="at">x =</span> YM, <span class="at">y =</span> CUM_RATE_K200, <span class="at">color =</span> <span class="st">"Kospi 200"</span>), <span class="at">size =</span> <span class="dv">1</span>, <span class="at">alpha=</span><span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb7-269"><a href="#cb7-269" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> graph1_1, <span class="fu">aes</span>(<span class="at">x =</span> YM, <span class="at">y =</span> CUM_RATE_K200, <span class="at">color =</span> <span class="st">"Kospi 200"</span>), <span class="at">shape =</span> <span class="dv">16</span>, <span class="at">size =</span> <span class="dv">2</span>,<span class="at">alpha=</span><span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb7-270"><a href="#cb7-270" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">data =</span> graph1_3, <span class="fu">aes</span>(<span class="at">x =</span> YM, <span class="at">y =</span> REVENUE_DIFF <span class="sc">*</span> <span class="dv">3</span>),</span>
<span id="cb7-271"><a href="#cb7-271" aria-hidden="true" tabindex="-1"></a>           <span class="at">stat =</span> <span class="st">"identity"</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>, <span class="at">fill =</span> <span class="st">"gray"</span>) <span class="sc">+</span></span>
<span id="cb7-272"><a href="#cb7-272" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_date</span>(<span class="at">date_breaks =</span> <span class="st">"1 year"</span>, <span class="at">date_labels =</span> <span class="st">"%Y"</span>) <span class="sc">+</span></span>
<span id="cb7-273"><a href="#cb7-273" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">30</span>, <span class="dv">50</span>), <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="dv">30</span>, <span class="dv">50</span>, <span class="dv">10</span>), <span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">number_format</span>(<span class="at">accuracy =</span> <span class="fl">0.1</span>),</span>
<span id="cb7-274"><a href="#cb7-274" aria-hidden="true" tabindex="-1"></a>                     <span class="at">sec.axis =</span> <span class="fu">sec_axis</span>(<span class="sc">~</span> . <span class="sc">/</span> <span class="dv">3</span>, <span class="at">name =</span> <span class="st">"Overperform (100M)"</span>, <span class="at">breaks =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">10</span>, <span class="sc">-</span><span class="dv">5</span>, <span class="dv">0</span>, <span class="dv">5</span>, <span class="dv">10</span>), <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"-10"</span>, <span class="st">"-5"</span>, <span class="st">"0"</span>, <span class="st">"5"</span>, <span class="st">"10"</span>))) <span class="sc">+</span></span>
<span id="cb7-275"><a href="#cb7-275" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Vol-adj. Weekly"</span> <span class="ot">=</span> <span class="st">"red"</span>, <span class="st">"5% OTM Monthly"</span> <span class="ot">=</span> <span class="st">"blue"</span>, <span class="st">"Kospi 200"</span> <span class="ot">=</span> <span class="st">"Green"</span>)) <span class="sc">+</span></span>
<span id="cb7-276"><a href="#cb7-276" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="cn">NULL</span>, <span class="at">y =</span> <span class="st">"Cumulative Return (%)"</span>, <span class="at">color =</span> <span class="st">""</span>) <span class="sc">+</span></span>
<span id="cb7-277"><a href="#cb7-277" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb7-278"><a href="#cb7-278" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="fu">c</span>(<span class="fl">0.4</span>, <span class="fl">0.93</span>), <span class="at">legend.direction =</span> <span class="st">"horizontal"</span>)</span>
<span id="cb7-279"><a href="#cb7-279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-280"><a href="#cb7-280" aria-hidden="true" tabindex="-1"></a>graph2<span class="ot">=</span><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb7-281"><a href="#cb7-281" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> graph2_1, <span class="fu">aes</span>(<span class="at">x =</span> YM, <span class="at">y =</span> CUM_RATE, <span class="at">color =</span> <span class="st">"Vol-adj. Weekly"</span>), <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb7-282"><a href="#cb7-282" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> graph2_1, <span class="fu">aes</span>(<span class="at">x =</span> YM, <span class="at">y =</span> CUM_RATE, <span class="at">color =</span> <span class="st">"Vol-adj. Weekly"</span>), <span class="at">shape =</span> <span class="dv">16</span>, <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb7-283"><a href="#cb7-283" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> graph2_2, <span class="fu">aes</span>(<span class="at">x =</span> YM, <span class="at">y =</span> CUM_RATE, <span class="at">color =</span> <span class="st">"5% OTM Monthly"</span>), <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb7-284"><a href="#cb7-284" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> graph2_2, <span class="fu">aes</span>(<span class="at">x =</span> YM, <span class="at">y =</span> CUM_RATE, <span class="at">color =</span> <span class="st">"5% OTM Monthly"</span>), <span class="at">shape =</span> <span class="dv">16</span>, <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb7-285"><a href="#cb7-285" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> graph2_1, <span class="fu">aes</span>(<span class="at">x =</span> YM, <span class="at">y =</span> CUM_RATE_K200, <span class="at">color =</span> <span class="st">"Kospi 200"</span>), <span class="at">size =</span> <span class="dv">1</span>, <span class="at">alpha=</span><span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb7-286"><a href="#cb7-286" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> graph2_1, <span class="fu">aes</span>(<span class="at">x =</span> YM, <span class="at">y =</span> CUM_RATE_K200, <span class="at">color =</span> <span class="st">"Kospi 200"</span>), <span class="at">shape =</span> <span class="dv">16</span>, <span class="at">size =</span> <span class="dv">2</span>,<span class="at">alpha=</span><span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb7-287"><a href="#cb7-287" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">data =</span> graph2_3, <span class="fu">aes</span>(<span class="at">x =</span> YM, <span class="at">y =</span> REVENUE_DIFF <span class="sc">*</span> <span class="dv">3</span>),</span>
<span id="cb7-288"><a href="#cb7-288" aria-hidden="true" tabindex="-1"></a>           <span class="at">stat =</span> <span class="st">"identity"</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>, <span class="at">fill =</span> <span class="st">"gray"</span>) <span class="sc">+</span></span>
<span id="cb7-289"><a href="#cb7-289" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_date</span>(<span class="at">date_breaks =</span> <span class="st">"1 year"</span>, <span class="at">date_labels =</span> <span class="st">"%Y"</span>) <span class="sc">+</span></span>
<span id="cb7-290"><a href="#cb7-290" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">30</span>, <span class="dv">20</span>), <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="dv">30</span>, <span class="dv">30</span>, <span class="dv">10</span>), <span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">number_format</span>(<span class="at">accuracy =</span> <span class="fl">0.1</span>),</span>
<span id="cb7-291"><a href="#cb7-291" aria-hidden="true" tabindex="-1"></a>                     <span class="at">sec.axis =</span> <span class="fu">sec_axis</span>(<span class="sc">~</span> . <span class="sc">/</span> <span class="dv">3</span>, <span class="at">name =</span> <span class="st">"Overperform (100M)"</span>, <span class="at">breaks =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">10</span>, <span class="sc">-</span><span class="dv">5</span>, <span class="dv">0</span>, <span class="dv">5</span>, <span class="dv">10</span>), <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"-10"</span>, <span class="st">"-5"</span>, <span class="st">"0"</span>, <span class="st">"5"</span>, <span class="st">"10"</span>))) <span class="sc">+</span></span>
<span id="cb7-292"><a href="#cb7-292" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Vol-adj. Weekly"</span> <span class="ot">=</span> <span class="st">"red"</span>, <span class="st">"5% OTM Monthly"</span> <span class="ot">=</span> <span class="st">"blue"</span>, <span class="st">"Kospi 200"</span> <span class="ot">=</span> <span class="st">"Green"</span>)) <span class="sc">+</span></span>
<span id="cb7-293"><a href="#cb7-293" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="cn">NULL</span>, <span class="at">y =</span> <span class="st">"Cumulative Return (%)"</span>, <span class="at">color =</span> <span class="st">""</span>) <span class="sc">+</span></span>
<span id="cb7-294"><a href="#cb7-294" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb7-295"><a href="#cb7-295" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="fu">c</span>(<span class="fl">0.4</span>, <span class="fl">0.93</span>), <span class="at">legend.direction =</span> <span class="st">"horizontal"</span>)</span>
<span id="cb7-296"><a href="#cb7-296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-297"><a href="#cb7-297" aria-hidden="true" tabindex="-1"></a>graph3<span class="ot">=</span><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb7-298"><a href="#cb7-298" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> graph3_1, <span class="fu">aes</span>(<span class="at">x =</span> YM, <span class="at">y =</span> Kospi200, <span class="at">color =</span> <span class="st">"Kospi 200"</span>), <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb7-299"><a href="#cb7-299" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> graph3_1, <span class="fu">aes</span>(<span class="at">x =</span> YM, <span class="at">y =</span> Kospi200, <span class="at">color =</span> <span class="st">"Kospi 200"</span>), <span class="at">shape =</span> <span class="dv">16</span>, <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb7-300"><a href="#cb7-300" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">data =</span> graph3_1, <span class="fu">aes</span>(<span class="at">x =</span> YM, <span class="at">y =</span> TargetVol <span class="sc">*</span> <span class="dv">7000</span>),</span>
<span id="cb7-301"><a href="#cb7-301" aria-hidden="true" tabindex="-1"></a>           <span class="at">stat =</span> <span class="st">"identity"</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>, <span class="at">fill =</span> <span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb7-302"><a href="#cb7-302" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">200</span>, <span class="at">size=</span><span class="fl">0.5</span>, <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">alpha=</span><span class="fl">0.5</span>)<span class="sc">+</span></span>
<span id="cb7-303"><a href="#cb7-303" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_date</span>(<span class="at">date_breaks =</span> <span class="st">"1 year"</span>, <span class="at">date_labels =</span> <span class="st">"%Y"</span>) <span class="sc">+</span></span>
<span id="cb7-304"><a href="#cb7-304" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">500</span>), <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">100</span>, <span class="dv">500</span>, <span class="dv">100</span>),</span>
<span id="cb7-305"><a href="#cb7-305" aria-hidden="true" tabindex="-1"></a>                     <span class="at">sec.axis =</span> <span class="fu">sec_axis</span>(<span class="sc">~</span> . <span class="sc">/</span> <span class="dv">7000</span>, <span class="at">name =</span> <span class="st">"Strike Range(Monthly)"</span>, <span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.025</span>,<span class="fl">0.05</span>,<span class="fl">0.075</span>, <span class="fl">0.1</span>), <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"0"</span>,<span class="st">"5%"</span>, <span class="st">"10%"</span>,<span class="st">"15%"</span>, <span class="st">"20%"</span>))) <span class="sc">+</span></span>
<span id="cb7-306"><a href="#cb7-306" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Kospi 200"</span> <span class="ot">=</span> <span class="st">"red"</span>)) <span class="sc">+</span></span>
<span id="cb7-307"><a href="#cb7-307" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="cn">NULL</span>, <span class="at">y =</span> <span class="st">"Kospi 200"</span>, <span class="at">color =</span> <span class="st">""</span>) <span class="sc">+</span></span>
<span id="cb7-308"><a href="#cb7-308" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb7-309"><a href="#cb7-309" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="fu">c</span>(<span class="fl">0.1</span>, <span class="fl">0.93</span>), <span class="at">legend.direction =</span> <span class="st">"horizontal"</span>)</span>
<span id="cb7-310"><a href="#cb7-310" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-311"><a href="#cb7-311" aria-hidden="true" tabindex="-1"></a><span class="co"># 요약표 1 : VW포트폴리오</span></span>
<span id="cb7-312"><a href="#cb7-312" aria-hidden="true" tabindex="-1"></a>table1 <span class="ot">&lt;-</span> portfolio <span class="sc">%&gt;%</span></span>
<span id="cb7-313"><a href="#cb7-313" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>(PREMIUM, EXERCISE) <span class="sc">%&gt;%</span></span>
<span id="cb7-314"><a href="#cb7-314" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">YEAR =</span> <span class="fu">substr</span>(BAS_DD, <span class="dv">1</span>, <span class="dv">4</span>),</span>
<span id="cb7-315"><a href="#cb7-315" aria-hidden="true" tabindex="-1"></a>         <span class="at">CNT=</span><span class="dv">1</span>,</span>
<span id="cb7-316"><a href="#cb7-316" aria-hidden="true" tabindex="-1"></a>         <span class="at">NO=</span><span class="fu">if_else</span>(EXERCISE<span class="sc">==</span><span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">0</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb7-317"><a href="#cb7-317" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(YEAR) <span class="sc">%&gt;%</span></span>
<span id="cb7-318"><a href="#cb7-318" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">Expiry =</span> <span class="fu">sum</span>(CNT),</span>
<span id="cb7-319"><a href="#cb7-319" aria-hidden="true" tabindex="-1"></a>            <span class="at">NoExercise =</span> <span class="fu">round</span>(<span class="fu">sum</span>(NO)<span class="sc">/</span><span class="fu">sum</span>(CNT),<span class="dv">2</span>),</span>
<span id="cb7-320"><a href="#cb7-320" aria-hidden="true" tabindex="-1"></a>            <span class="at">Premium =</span> <span class="fu">round</span>(<span class="fu">mean</span>(PREMIUM)<span class="sc">/</span><span class="dv">10000</span>,<span class="dv">0</span>),</span>
<span id="cb7-321"><a href="#cb7-321" aria-hidden="true" tabindex="-1"></a>            <span class="at">Interest =</span> <span class="fu">round</span>(<span class="fu">mean</span>(INTEREST)<span class="sc">/</span><span class="dv">10000</span>,<span class="dv">0</span>),</span>
<span id="cb7-322"><a href="#cb7-322" aria-hidden="true" tabindex="-1"></a>            <span class="at">Loss =</span> <span class="fu">round</span>(<span class="fu">mean</span>(EXERCISE)<span class="sc">/</span><span class="dv">10000</span>,<span class="dv">0</span>),</span>
<span id="cb7-323"><a href="#cb7-323" aria-hidden="true" tabindex="-1"></a>            <span class="at">Revenue =</span> <span class="fu">round</span>(<span class="fu">mean</span>(REVENUE)<span class="sc">/</span><span class="dv">10000</span>,<span class="dv">0</span>),</span>
<span id="cb7-324"><a href="#cb7-324" aria-hidden="true" tabindex="-1"></a>            <span class="at">Return =</span> <span class="fu">round</span>(<span class="fu">prod</span>(<span class="dv">1</span> <span class="sc">+</span> RATE)<span class="sc">-</span><span class="dv">1</span>,<span class="dv">2</span>),</span>
<span id="cb7-325"><a href="#cb7-325" aria-hidden="true" tabindex="-1"></a>            <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-326"><a href="#cb7-326" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(K200_portfolio <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(YEAR) <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="at">Return_K200=</span><span class="fu">round</span>(<span class="fu">prod</span>(RATE_K200)<span class="sc">-</span><span class="dv">1</span>,<span class="dv">2</span>)),</span>
<span id="cb7-327"><a href="#cb7-327" aria-hidden="true" tabindex="-1"></a>            <span class="at">by=</span><span class="st">"YEAR"</span>)</span>
<span id="cb7-328"><a href="#cb7-328" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-329"><a href="#cb7-329" aria-hidden="true" tabindex="-1"></a><span class="co"># 요약표 2 : 일반 포트폴리오</span></span>
<span id="cb7-330"><a href="#cb7-330" aria-hidden="true" tabindex="-1"></a>table2 <span class="ot">&lt;-</span> portfolio2 <span class="sc">%&gt;%</span></span>
<span id="cb7-331"><a href="#cb7-331" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>(PREMIUM, EXERCISE) <span class="sc">%&gt;%</span></span>
<span id="cb7-332"><a href="#cb7-332" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">YEAR =</span> <span class="fu">substr</span>(BAS_DD, <span class="dv">1</span>, <span class="dv">4</span>),</span>
<span id="cb7-333"><a href="#cb7-333" aria-hidden="true" tabindex="-1"></a>         <span class="at">CNT=</span><span class="dv">1</span>,</span>
<span id="cb7-334"><a href="#cb7-334" aria-hidden="true" tabindex="-1"></a>         <span class="at">NO=</span><span class="fu">if_else</span>(EXERCISE<span class="sc">==</span><span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">0</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb7-335"><a href="#cb7-335" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(YEAR) <span class="sc">%&gt;%</span></span>
<span id="cb7-336"><a href="#cb7-336" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">Expiry =</span> <span class="fu">sum</span>(CNT),</span>
<span id="cb7-337"><a href="#cb7-337" aria-hidden="true" tabindex="-1"></a>            <span class="at">NoExercise =</span> <span class="fu">round</span>(<span class="fu">sum</span>(NO)<span class="sc">/</span><span class="fu">sum</span>(CNT),<span class="dv">2</span>),</span>
<span id="cb7-338"><a href="#cb7-338" aria-hidden="true" tabindex="-1"></a>            <span class="at">Premium =</span> <span class="fu">round</span>(<span class="fu">mean</span>(PREMIUM)<span class="sc">/</span><span class="dv">10000</span>,<span class="dv">0</span>),</span>
<span id="cb7-339"><a href="#cb7-339" aria-hidden="true" tabindex="-1"></a>            <span class="at">Interest =</span> <span class="fu">round</span>(<span class="fu">mean</span>(INTEREST)<span class="sc">/</span><span class="dv">10000</span>,<span class="dv">0</span>),</span>
<span id="cb7-340"><a href="#cb7-340" aria-hidden="true" tabindex="-1"></a>            <span class="at">Loss =</span> <span class="fu">round</span>(<span class="fu">mean</span>(EXERCISE)<span class="sc">/</span><span class="dv">10000</span>,<span class="dv">0</span>),</span>
<span id="cb7-341"><a href="#cb7-341" aria-hidden="true" tabindex="-1"></a>            <span class="at">Revenue =</span> <span class="fu">round</span>(<span class="fu">mean</span>(REVENUE)<span class="sc">/</span><span class="dv">10000</span>,<span class="dv">0</span>),</span>
<span id="cb7-342"><a href="#cb7-342" aria-hidden="true" tabindex="-1"></a>            <span class="at">Return =</span> <span class="fu">round</span>(<span class="fu">prod</span>(<span class="dv">1</span> <span class="sc">+</span> RATE)<span class="sc">-</span><span class="dv">1</span>,<span class="dv">2</span>),</span>
<span id="cb7-343"><a href="#cb7-343" aria-hidden="true" tabindex="-1"></a>            <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-344"><a href="#cb7-344" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(K200_portfolio <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(YEAR) <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="at">Return_K200=</span><span class="fu">round</span>(<span class="fu">prod</span>(RATE_K200)<span class="sc">-</span><span class="dv">1</span>,<span class="dv">2</span>)),</span>
<span id="cb7-345"><a href="#cb7-345" aria-hidden="true" tabindex="-1"></a>            <span class="at">by=</span><span class="st">"YEAR"</span>)</span>
<span id="cb7-346"><a href="#cb7-346" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-347"><a href="#cb7-347" aria-hidden="true" tabindex="-1"></a><span class="co"># 요약표 3 : 포트폴리오 변동성 비교</span></span>
<span id="cb7-348"><a href="#cb7-348" aria-hidden="true" tabindex="-1"></a>Vol1 <span class="ot">&lt;-</span> graph1_1 <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(YEAR) <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="at">Vol=</span><span class="fu">round</span>(<span class="fu">sd</span>(RATE)<span class="sc">*</span><span class="fu">sqrt</span>(<span class="dv">12</span>),<span class="dv">2</span>),</span>
<span id="cb7-349"><a href="#cb7-349" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">Vol_K200=</span><span class="fu">round</span>(<span class="fu">sd</span>(RATE_K200)<span class="sc">*</span><span class="fu">sqrt</span>(<span class="dv">12</span>),<span class="dv">2</span>))</span>
<span id="cb7-350"><a href="#cb7-350" aria-hidden="true" tabindex="-1"></a>Vol2 <span class="ot">&lt;-</span> graph1_2 <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(YEAR) <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="at">Vol=</span><span class="fu">round</span>(<span class="fu">sd</span>(RATE)<span class="sc">*</span><span class="fu">sqrt</span>(<span class="dv">12</span>),<span class="dv">2</span>))</span>
<span id="cb7-351"><a href="#cb7-351" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-352"><a href="#cb7-352" aria-hidden="true" tabindex="-1"></a>table3 <span class="ot">&lt;-</span> table1 <span class="sc">%&gt;%</span> </span>
<span id="cb7-353"><a href="#cb7-353" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(YEAR,Return,Return_K200) <span class="sc">%&gt;%</span> </span>
<span id="cb7-354"><a href="#cb7-354" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(Vol1, <span class="at">by=</span><span class="st">"YEAR"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-355"><a href="#cb7-355" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Return_main=</span>Return,</span>
<span id="cb7-356"><a href="#cb7-356" aria-hidden="true" tabindex="-1"></a>         <span class="at">Vol_main=</span>Vol) <span class="sc">%&gt;%</span> </span>
<span id="cb7-357"><a href="#cb7-357" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(YEAR, Return_main,Vol_main,Return_K200,Vol_K200) <span class="sc">%&gt;%</span> </span>
<span id="cb7-358"><a href="#cb7-358" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(table2 <span class="sc">%&gt;%</span> </span>
<span id="cb7-359"><a href="#cb7-359" aria-hidden="true" tabindex="-1"></a>              <span class="fu">select</span>(YEAR,Return) <span class="sc">%&gt;%</span> </span>
<span id="cb7-360"><a href="#cb7-360" aria-hidden="true" tabindex="-1"></a>              <span class="fu">left_join</span>(Vol2, <span class="at">by=</span><span class="st">"YEAR"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-361"><a href="#cb7-361" aria-hidden="true" tabindex="-1"></a>              <span class="fu">mutate</span>(<span class="at">Return_sub=</span>Return,</span>
<span id="cb7-362"><a href="#cb7-362" aria-hidden="true" tabindex="-1"></a>                     <span class="at">Vol_sub=</span>Vol) <span class="sc">%&gt;%</span> </span>
<span id="cb7-363"><a href="#cb7-363" aria-hidden="true" tabindex="-1"></a>              <span class="fu">select</span>(YEAR,Return_sub,Vol_sub), <span class="at">by=</span><span class="st">"YEAR"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-364"><a href="#cb7-364" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(YEAR, Return_main, Return_sub, Return_K200, Vol_main, Vol_sub, Vol_K200)</span>
<span id="cb7-365"><a href="#cb7-365" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb7-366"><a href="#cb7-366" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-367"><a href="#cb7-367" aria-hidden="true" tabindex="-1"></a><span class="fu">## 1. 개요</span></span>
<span id="cb7-368"><a href="#cb7-368" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-369"><a href="#cb7-369" aria-hidden="true" tabindex="-1"></a>본 리포트는 옵션과 변동성지수를 활용한 **변동성 조정 위클리 양매도**전략을 알아보고, **과거 데이터를 통해 구현 및 검증**하기 위해 작성되었습니다. **변동성 조정 위클리 양매도**란 ***1.변동성 조정***, ***2.주단위 매도*** 두가지 특징을 통해 **기존 단점을 보완**한 양매도 전략으로, "매주" V-Kospi200를 이용해 행사가격 범위를 결정하고 콜/풋옵션을 매도(양매도)하게 됩니다.</span>
<span id="cb7-370"><a href="#cb7-370" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-371"><a href="#cb7-371" aria-hidden="true" tabindex="-1"></a>전략 소개에 앞서 필요한 배경지식을 다루고, 전략 소개 및 구현, 백테스팅 및 성과를 차례로 설명하겠습니다.</span>
<span id="cb7-372"><a href="#cb7-372" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-373"><a href="#cb7-373" aria-hidden="true" tabindex="-1"></a><span class="fu">## 2. 배경지식</span></span>
<span id="cb7-374"><a href="#cb7-374" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-375"><a href="#cb7-375" aria-hidden="true" tabindex="-1"></a><span class="fu">### 양매도 (Short strangle)</span></span>
<span id="cb7-376"><a href="#cb7-376" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-377"><a href="#cb7-377" aria-hidden="true" tabindex="-1"></a>**양매도란 옵션 거래전략**으로, 일반적으로 **만기일이 같은 외가격(OTM) 콜/풋옵션을 매도**하는 것을 의미합니다.</span>
<span id="cb7-378"><a href="#cb7-378" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-379"><a href="#cb7-379" aria-hidden="true" tabindex="-1"></a>OTM 옵션을 매도하므로, 만기일에 기초자산의 가격이 풋옵션의 행사가격과 콜옵션의 행사가격 사이라면 권리행사되지 않게 되고 **옵션 프리미엄(매도수익)을 그대로 얻을 수 있게 됩니다.**</span>
<span id="cb7-380"><a href="#cb7-380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-381"><a href="#cb7-381" aria-hidden="true" tabindex="-1"></a>반면, **양매도는 시장의 변동성이 예상과 달리 큰 경우, 큰 손실이 발생할 수 있다는 단점**도 존재합니다. **수익은 프리미엄으로 한정**되어있으나, 시황 급변에 따른 **옵션 손실에는 제한이 없어** 원금 이상의 손실이 발생할 수도 있기 때문입니다.</span>
<span id="cb7-382"><a href="#cb7-382" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-383"><a href="#cb7-383" aria-hidden="true" tabindex="-1"></a>즉, 양매도는 높은 확률로 **안정적인 중수익을 보장하나 매우 낮은 확률로 큰 손실이 발생할 수 있는 전략**이며, **향후 시장의 변동성이 크지 않을 것이라 예측될 때 주로 사용**됩니다.</span>
<span id="cb7-384"><a href="#cb7-384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-385"><a href="#cb7-385" aria-hidden="true" tabindex="-1"></a><span class="al">![](image/shortstrangle.png)</span>{fig-align="center" width="150mm" height="50mm"}</span>
<span id="cb7-386"><a href="#cb7-386" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-387"><a href="#cb7-387" aria-hidden="true" tabindex="-1"></a><span class="fu">#### 양매도 전략 예시</span></span>
<span id="cb7-388"><a href="#cb7-388" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-389"><a href="#cb7-389" aria-hidden="true" tabindex="-1"></a>국내의 경우 행사가격의 상하단을 등가격(ATM) $\pm$ 5%로 설정한 양매도 ETN이 한 때 큰 인기를 끌었습니다. 대표적인 예시인 **월별 코스피200 OTM 5% 양매도 전략**의 거래방법을 살펴보면, 다음과 같습니다.</span>
<span id="cb7-390"><a href="#cb7-390" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-391"><a href="#cb7-391" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>현재 코스피200지수를 기준으로 ATM+5%의 콜옵션과 ATM-5%의 풋옵션을 매도 (프리미엄 수익 발생)</span>
<span id="cb7-392"><a href="#cb7-392" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>다음달 만기일이 되면, 옵션은 청산(권리행사시 손실)되고 다시 ATM $\pm$ 5%의 콜,풋옵션을 매도</span>
<span id="cb7-393"><a href="#cb7-393" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-394"><a href="#cb7-394" aria-hidden="true" tabindex="-1"></a>즉, **월단위로 옵션을 교체하게 되며 행사가격의 상하단은 ATM** $\pm$ 5%로 고정한 양매도 전략입니다. 중위험-중수익으로 흥행에 성공한 상품이지만, **아래와 같은 한계점**도 존재합니다.</span>
<span id="cb7-395"><a href="#cb7-395" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-396"><a href="#cb7-396" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>행사가격 범위가 고정되어있어 변동성 확대시 손실 가능성이 커지고, 변동성 축소시 프리미엄 수익이 크게 감소</span>
<span id="cb7-397"><a href="#cb7-397" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>옵션 교체주기가 1개월로, 그간 지수의 하락이 누적된다면 손실이 과도하게 커질 수 있음 (유동성 리스크)</span>
<span id="cb7-398"><a href="#cb7-398" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-399"><a href="#cb7-399" aria-hidden="true" tabindex="-1"></a><span class="fu">### 코스피200 변동성지수 (V-Kospi200 index)</span></span>
<span id="cb7-400"><a href="#cb7-400" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-401"><a href="#cb7-401" aria-hidden="true" tabindex="-1"></a>**코스피200 변동성 지수**란 주식 시장의 **변동성을 측정하는 지표**입니다. 코스피200 옵션 가격 기반의 내재변동성을 이용하여 산출되며, 향후 30일간 시장 변동성에 대한 투자자들의 기대를 나타내는 지수입니다.</span>
<span id="cb7-402"><a href="#cb7-402" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-403"><a href="#cb7-403" aria-hidden="true" tabindex="-1"></a><span class="fu">#### 주요 특징</span></span>
<span id="cb7-404"><a href="#cb7-404" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-405"><a href="#cb7-405" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**시장 심리 반영**: 투자자들의 불안 심리를 반영하며, '공포 지수(Fear Index)'라고도 불림</span>
<span id="cb7-406"><a href="#cb7-406" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**옵션 가격 기반**: 코스피200 옵션 가격 기반의 내재변동성을 통해 산출되며, 여기에는 투자자들의 기대가 반영</span>
<span id="cb7-407"><a href="#cb7-407" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-408"><a href="#cb7-408" aria-hidden="true" tabindex="-1"></a>***그래프1 : 일별 코스피200지수 및 코스피200 변동성지수***</span>
<span id="cb7-409"><a href="#cb7-409" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-410"><a href="#cb7-410" aria-hidden="true" tabindex="-1"></a><span class="al">![](image/vkospi.png)</span>{fig-align="center" width="70%"}</span>
<span id="cb7-411"><a href="#cb7-411" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-412"><a href="#cb7-412" aria-hidden="true" tabindex="-1"></a><span class="fu">### 코스피200 위클리옵션</span></span>
<span id="cb7-413"><a href="#cb7-413" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-414"><a href="#cb7-414" aria-hidden="true" tabindex="-1"></a>**코스피200 위클리옵션**이란 코스피200 지수를 기초자산으로 하는 **주간 단위의 옵션 거래 상품**을 말합니다. '19년 상장되었으며 기존의 월 단위 만기가 도래하는 옵션과는 달리, 매주 월/목요일에 만기가 도래하는 단기 옵션입니다.</span>
<span id="cb7-415"><a href="#cb7-415" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-416"><a href="#cb7-416" aria-hidden="true" tabindex="-1"></a><span class="fu">#### 주요 특징</span></span>
<span id="cb7-417"><a href="#cb7-417" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-418"><a href="#cb7-418" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**세밀한 거래 지원**: 매주 월/목요일에 만기가 도래하여 단기적인 시장 변동에 대한 투자 및 위험 관리에 유리</span>
<span id="cb7-419"><a href="#cb7-419" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**다양한 투자 전략 활용:** 단기적인 시장 예측을 기반으로 다양한 투자 전략을 구사할 수 있습니다.</span>
<span id="cb7-420"><a href="#cb7-420" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-421"><a href="#cb7-421" aria-hidden="true" tabindex="-1"></a><span class="fu">## 3. 전략 소개 및 구현</span></span>
<span id="cb7-422"><a href="#cb7-422" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-423"><a href="#cb7-423" aria-hidden="true" tabindex="-1"></a><span class="fu">### 전략 개요</span></span>
<span id="cb7-424"><a href="#cb7-424" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-425"><a href="#cb7-425" aria-hidden="true" tabindex="-1"></a>변동성 조정 위클리 양매도(Volatility Adjusted Weekly Short strangle, VWss) 전략이란, 기존에 널리 활용되던 **월별 OTM 5% 양매도 전략**에 아래 두가지 방법을 결합한 전략을 의미합니다.</span>
<span id="cb7-426"><a href="#cb7-426" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-427"><a href="#cb7-427" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>옵션의 교체주기를 "매월" -<span class="sc">\&gt;</span> "매주" 단위로 세분화</span>
<span id="cb7-428"><a href="#cb7-428" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>행사가격의 범위를 고정하는 것이 아니라 매 옵션 매도시점마다 시장 변동성을 고려하여 조정</span>
<span id="cb7-429"><a href="#cb7-429" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-430"><a href="#cb7-430" aria-hidden="true" tabindex="-1"></a>따라서, 기존과 달리 **주단위로 옵션을 교체하며, 행사가격의 범위는 교체시점에 매번 달라지게 됩니다.** 이를 위해 코스피200위클리옵션**을 사용하고, 변동성 지표는** 내재변동성 기반의 V-Kospi200지수를 사용<span class="sc">\*\*</span>하여 구현할 계획입니다.</span>
<span id="cb7-431"><a href="#cb7-431" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-432"><a href="#cb7-432" aria-hidden="true" tabindex="-1"></a><span class="fu">### 행사가격 범위 설정방법</span></span>
<span id="cb7-433"><a href="#cb7-433" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-434"><a href="#cb7-434" aria-hidden="true" tabindex="-1"></a>행사가격의 상하단은 **옵션 매도시점의 "전일 V-Kospi200 종가"를 참조하여 설정**할 예정입니다. V-Kospi200는 향후 30일간 코스피200 지수의 변동성을 수치화한 지표로서, 현재시점에서 변동성을 잘 예측할 수 있는 수단이기 때문입니다.</span>
<span id="cb7-435"><a href="#cb7-435" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-436"><a href="#cb7-436" aria-hidden="true" tabindex="-1"></a>다만, 본 전략에서 옵션 매도포지션의 유지기간은 약 7일이므로 지수 종가(연율)를 주단위 기간에 맞도록 환산하여 행사가격의 상하단을 산출하였습니다.</span>
<span id="cb7-437"><a href="#cb7-437" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-438"><a href="#cb7-438" aria-hidden="true" tabindex="-1"></a>$$\sigma_{Target}\;=\;\frac{VKospi200_{(T-1)}\times\sqrt{Calendar\;days}}{\sqrt{365}}$$</span>
<span id="cb7-439"><a href="#cb7-439" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-440"><a href="#cb7-440" aria-hidden="true" tabindex="-1"></a>$$Call\;strike\;=\;Kospi200_{(T)}\times (1+\sigma_{Target})\;rounded\;up\;to\;2.5pt$$</span>
<span id="cb7-441"><a href="#cb7-441" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-442"><a href="#cb7-442" aria-hidden="true" tabindex="-1"></a>$$Put\;strike\;=\;Kospi200_{(T)}\times (1-\sigma_{Target})\;rounded\;down\;to\;2.5pt$$</span>
<span id="cb7-443"><a href="#cb7-443" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-444"><a href="#cb7-444" aria-hidden="true" tabindex="-1"></a>이렇게 행사가격을 설정하면 V-Kospi200가 15pt일 때 월환산 변동성이 약 5%(주환산 2.5%)가 됩니다. 즉,</span>
<span id="cb7-445"><a href="#cb7-445" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-446"><a href="#cb7-446" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>시장의 예상 변동성(V-Kospi200)이 연 15% 이상 -<span class="sc">\&gt;</span> 행사가격 범위를 기존보다 넓게 설정하여 손실 가능성 축소</span>
<span id="cb7-447"><a href="#cb7-447" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>시장의 예상 변동성이 연 15% 미만 -<span class="sc">\&gt;</span> 행사가격 범위를 기존보다 좁게 설정하여 프리미엄 수익 극대화</span>
<span id="cb7-448"><a href="#cb7-448" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-449"><a href="#cb7-449" aria-hidden="true" tabindex="-1"></a>::: callout</span>
<span id="cb7-450"><a href="#cb7-450" aria-hidden="true" tabindex="-1"></a>본 전략은 위클리옵션을 사용하므로 향후 1주일 변동성이 필요합니다. 따라서, 30일 변동성을 나타내는 V-Kospi200은 만기 mismatch가 있지만, 단기간의 예측치에는 큰 차이가 없고 이외의 대안(e.g. 7-day VIX)이 없어 V-Kospi200를 그대로 사용하였습니다.</span>
<span id="cb7-451"><a href="#cb7-451" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb7-452"><a href="#cb7-452" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-453"><a href="#cb7-453" aria-hidden="true" tabindex="-1"></a><span class="fu">### 포트폴리오 구성 방법</span></span>
<span id="cb7-454"><a href="#cb7-454" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-455"><a href="#cb7-455" aria-hidden="true" tabindex="-1"></a>먼저, 편의를 위해 세금/수수료/호가스프레드 등의 거래비용은 없으며 종가에 원하는 수량만큼 거래할 수 있는 **완전자본시장을 가정**하도록 하겠습니다. 전략 구현을 위한 포트폴리오(투자원금 100억원) 구성 과정은 아래와 같습니다.</span>
<span id="cb7-456"><a href="#cb7-456" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-457"><a href="#cb7-457" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>전일 V-Kospi200 지수를 주단위로 환산하여 예상변동성($\hat\sigma=(VKospi200\times \sqrt{day})/\sqrt{365}$) 산출</span>
<span id="cb7-458"><a href="#cb7-458" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>예상변동성을 당일 Kospi200지수에 적용하여 행사가격 상하단(ATM $\pm\hat\sigma$을 2.5pt 단위로 올림/내림) 산출</span>
<span id="cb7-459"><a href="#cb7-459" aria-hidden="true" tabindex="-1"></a><span class="ss">3.  </span>당일 Kospi200지수 및 승수(25만)를 적용, 옵션 매도수량($Q_{sell}=nominal/(kospi200\times multiplier)$) 산출</span>
<span id="cb7-460"><a href="#cb7-460" aria-hidden="true" tabindex="-1"></a><span class="ss">4.  </span>행사가격 상단 콜옵션, 하단 풋옵션 매도 ($Premium=(call price+put price)\times Q_{sell}\times multiplier$)</span>
<span id="cb7-461"><a href="#cb7-461" aria-hidden="true" tabindex="-1"></a><span class="ss">5.  </span>원금과 매도수익을 다음주 만기일까지 MMF에 투자 ($Interest=(nominal+Premium)\times MMF \times \frac{day}{365}$)</span>
<span id="cb7-462"><a href="#cb7-462" aria-hidden="true" tabindex="-1"></a><span class="ss">6.  </span>다음주 만기일이 되면, 권리행사 손실을 포함하여 최종손익 산출($Revenue=Premium+Interest-Exercise$)</span>
<span id="cb7-463"><a href="#cb7-463" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>Kospi200 <span class="sc">\&gt;</span> 행사가격 상단, 콜옵션에서 손실 발생($Exercise=(Kospi200-Strike_{call})\times multiplier$)</span>
<span id="cb7-464"><a href="#cb7-464" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>Kospi200 <span class="sc">\&lt;</span> 행사가격 하단, 풋옵션에서 손실 발생($Exercise=(Strike_{put}-Kospi200)\times multiplier$)</span>
<span id="cb7-465"><a href="#cb7-465" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>이외의 경우, 권리행사되지 않아 옵션 포지션 청산($Exercise=0$)</span>
<span id="cb7-466"><a href="#cb7-466" aria-hidden="true" tabindex="-1"></a><span class="ss">7.  </span>주간 최종손익을 정산($nominal_{new}=nominal_{old}+Revenue$)하고, 투자종료시점까지 1. \~ 6. 과정을 반복</span>
<span id="cb7-467"><a href="#cb7-467" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-468"><a href="#cb7-468" aria-hidden="true" tabindex="-1"></a><span class="fu">## 3. Backtesting</span></span>
<span id="cb7-469"><a href="#cb7-469" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-470"><a href="#cb7-470" aria-hidden="true" tabindex="-1"></a><span class="fu">### 데이터 수집 및 전처리, 포트폴리오 구현</span></span>
<span id="cb7-471"><a href="#cb7-471" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-472"><a href="#cb7-472" aria-hidden="true" tabindex="-1"></a>과거 5개년(2020\~2024) 코스피200 등의 지수/옵션 가격, 금리를 수집하였으며, 출처는 아래와 같습니다.</span>
<span id="cb7-473"><a href="#cb7-473" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-474"><a href="#cb7-474" aria-hidden="true" tabindex="-1"></a><span class="in">```         </span></span>
<span id="cb7-475"><a href="#cb7-475" aria-hidden="true" tabindex="-1"></a><span class="in">한국거래소 정보데이터시스템(data.krx.co.kr) : 코스피200 및 V-Kospi200지수</span></span>
<span id="cb7-476"><a href="#cb7-476" aria-hidden="true" tabindex="-1"></a><span class="in">한국거래소 OpenAPI(openapi.krx.co.kr) : 코스피200옵션 및 위클리옵션 종목별 가격</span></span>
<span id="cb7-477"><a href="#cb7-477" aria-hidden="true" tabindex="-1"></a><span class="in">한국은행 경제통계시스템(ecos.bok.or.kr) : 일별 MMF(7일) 금리</span></span>
<span id="cb7-478"><a href="#cb7-478" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb7-479"><a href="#cb7-479" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-480"><a href="#cb7-480" aria-hidden="true" tabindex="-1"></a>::: {.callout-note title="한국거래소 OpenAPI를 활용한 데이터 수집 예시"}</span>
<span id="cb7-481"><a href="#cb7-481" aria-hidden="true" tabindex="-1"></a><span class="al">![](image/krxopenapi1.png)</span>{fig-align="center" width="60%"}</span>
<span id="cb7-482"><a href="#cb7-482" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-483"><a href="#cb7-483" aria-hidden="true" tabindex="-1"></a>API 호출시 json 데이터를 수집할 수 있으며, 이를 Dataframe(python) 및 tibble(r)로 변환하여 활용하였습니다.</span>
<span id="cb7-484"><a href="#cb7-484" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-487"><a href="#cb7-487" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb7-488"><a href="#cb7-488" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> requests<span class="op">;</span> <span class="im">import</span> json</span>
<span id="cb7-489"><a href="#cb7-489" aria-hidden="true" tabindex="-1"></a>url <span class="op">=</span> <span class="st">'http://data-dbg.krx.co.kr/svc/sample/apis/drv/opt_bydd_trd?basDd=20250312'</span></span>
<span id="cb7-490"><a href="#cb7-490" aria-hidden="true" tabindex="-1"></a>headers <span class="op">=</span> {<span class="st">'AUTH_KEY'</span>: <span class="st">'74D1B99DFBF345BBA3FB4476510A4BED4C78D13A'</span>}</span>
<span id="cb7-491"><a href="#cb7-491" aria-hidden="true" tabindex="-1"></a>res <span class="op">=</span> requests.get(url<span class="op">=</span>url, headers<span class="op">=</span>headers)<span class="op">;</span> res.text</span>
<span id="cb7-492"><a href="#cb7-492" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb7-493"><a href="#cb7-493" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb7-494"><a href="#cb7-494" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-495"><a href="#cb7-495" aria-hidden="true" tabindex="-1"></a>수집한 데이터는 **R을 이용하여 전처리**하였으며, 두개의 데이터셋으로 요약하였습니다.</span>
<span id="cb7-496"><a href="#cb7-496" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-497"><a href="#cb7-497" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>**포트폴리오 기본 정보** : 옵션 만기일(매주), 옵션 보유일, MMF금리, Kospi200, 전일 V-K200, 거래대상옵션 정보</span>
<span id="cb7-498"><a href="#cb7-498" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-501"><a href="#cb7-501" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb7-502"><a href="#cb7-502" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb7-503"><a href="#cb7-503" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(<span class="fu">head</span>(target_info))</span>
<span id="cb7-504"><a href="#cb7-504" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb7-505"><a href="#cb7-505" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-506"><a href="#cb7-506" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**거래대상옵션 정보** : 포트폴리오 기본 정보에 대응되는 거래대상옵션의 종가, 거래량(0인 경우 제외)</span>
<span id="cb7-507"><a href="#cb7-507" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-510"><a href="#cb7-510" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb7-511"><a href="#cb7-511" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb7-512"><a href="#cb7-512" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(<span class="fu">head</span>(target_options))</span>
<span id="cb7-513"><a href="#cb7-513" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb7-514"><a href="#cb7-514" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-515"><a href="#cb7-515" aria-hidden="true" tabindex="-1"></a>이를 통해 매도수량, 프리미엄, 이자수익, 권리행사손실 등을 산출하여 **포트폴리오를 구현**하였습니다.</span>
<span id="cb7-516"><a href="#cb7-516" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-519"><a href="#cb7-519" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb7-520"><a href="#cb7-520" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb7-521"><a href="#cb7-521" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(portfolio <span class="sc">%&gt;%</span> <span class="fu">select</span>(BAS_DD,VOL,SELL_AMT,PREMIUM,INTEREST,EXERCISE,REVENUE,RATE) <span class="sc">%&gt;%</span> <span class="fu">head</span>())</span>
<span id="cb7-522"><a href="#cb7-522" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb7-523"><a href="#cb7-523" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-524"><a href="#cb7-524" aria-hidden="true" tabindex="-1"></a>\newpage</span>
<span id="cb7-525"><a href="#cb7-525" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-526"><a href="#cb7-526" aria-hidden="true" tabindex="-1"></a>::: {.callout-important title="변동성 조정 방법에 따른 행사가격 범위 추이(과거 5년)"}</span>
<span id="cb7-527"><a href="#cb7-527" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-528"><a href="#cb7-528" aria-hidden="true" tabindex="-1"></a>V-Kospi200과 연동한 행사가격의 범위는 지난 5년간 **1.6% \~ 8.7%까지 광범위하게 형성**되었습니다.</span>
<span id="cb7-529"><a href="#cb7-529" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-530"><a href="#cb7-530" aria-hidden="true" tabindex="-1"></a>코스피200이 급등락하는 경우 범위가 넓게 형성되고 보합장에서는 좁게 형성되는 추이를 확인할 수 있으며, 이를 월환산($\times\sqrt{4}$)하여 기존 5%와 비교하면 **지수의 상황에 따라 유동적으로 조절되고 있음**을 의미합니다.</span>
<span id="cb7-531"><a href="#cb7-531" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-532"><a href="#cb7-532" aria-hidden="true" tabindex="-1"></a>\</span>
<span id="cb7-533"><a href="#cb7-533" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-534"><a href="#cb7-534" aria-hidden="true" tabindex="-1"></a>***그래프2 : 월평균 코스피200지수(적색) 및 행사가격 범위(청색)***</span>
<span id="cb7-535"><a href="#cb7-535" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-538"><a href="#cb7-538" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb7-539"><a href="#cb7-539" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb7-540"><a href="#cb7-540" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb7-541"><a href="#cb7-541" aria-hidden="true" tabindex="-1"></a>graph3</span>
<span id="cb7-542"><a href="#cb7-542" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb7-543"><a href="#cb7-543" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-544"><a href="#cb7-544" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb7-545"><a href="#cb7-545" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-546"><a href="#cb7-546" aria-hidden="true" tabindex="-1"></a>\newpage</span>
<span id="cb7-547"><a href="#cb7-547" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-548"><a href="#cb7-548" aria-hidden="true" tabindex="-1"></a><span class="fu">### Backtesting 성과</span></span>
<span id="cb7-549"><a href="#cb7-549" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-550"><a href="#cb7-550" aria-hidden="true" tabindex="-1"></a>**지난 5년간(2020\~2024) VW양매도와 코스피200지수 / OTM 5% 양매도를 비교**해보았습니다.</span>
<span id="cb7-551"><a href="#cb7-551" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-552"><a href="#cb7-552" aria-hidden="true" tabindex="-1"></a>***표1 : 연도별 변동성 조정 위클리 양매도 포트폴리오 및 코스피200지수 성과***</span>
<span id="cb7-553"><a href="#cb7-553" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-556"><a href="#cb7-556" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb7-557"><a href="#cb7-557" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb7-558"><a href="#cb7-558" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(table1)</span>
<span id="cb7-559"><a href="#cb7-559" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb7-560"><a href="#cb7-560" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-561"><a href="#cb7-561" aria-hidden="true" tabindex="-1"></a>***표2 : 연도별 일반 양매도 포트폴리오 및 코스피200지수 성과***</span>
<span id="cb7-562"><a href="#cb7-562" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-565"><a href="#cb7-565" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb7-566"><a href="#cb7-566" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb7-567"><a href="#cb7-567" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(table2)</span>
<span id="cb7-568"><a href="#cb7-568" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb7-569"><a href="#cb7-569" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-570"><a href="#cb7-570" aria-hidden="true" tabindex="-1"></a>::: callout</span>
<span id="cb7-571"><a href="#cb7-571" aria-hidden="true" tabindex="-1"></a>**YEAR** : 산출대상 연도 / **Expiry** : 옵션만기 횟수 (프리미엄 수익 발생 횟수)</span>
<span id="cb7-572"><a href="#cb7-572" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-573"><a href="#cb7-573" aria-hidden="true" tabindex="-1"></a>**NoExercise** : 옵션만기일에 행사되지 않은 비율 (손실이 발생하지 않은 거래일 비율)</span>
<span id="cb7-574"><a href="#cb7-574" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-575"><a href="#cb7-575" aria-hidden="true" tabindex="-1"></a>**Premium** : 평균 옵션 프리미엄 수익 (만원) / **Interest** : 원금 및 프리미엄에서 발생한 평균 이자수익 (만원)</span>
<span id="cb7-576"><a href="#cb7-576" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-577"><a href="#cb7-577" aria-hidden="true" tabindex="-1"></a>**Loss** : 옵션권리행사로 인한 평균 손실 (미행사 포함) / **Revenue** : 평균 이익 (Premium + Interest - Loss)</span>
<span id="cb7-578"><a href="#cb7-578" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-579"><a href="#cb7-579" aria-hidden="true" tabindex="-1"></a>**Return** : 포트폴리오의 연환산 수익률 / **Return_K200** : 코스피200지수의 연환산 수익률</span>
<span id="cb7-580"><a href="#cb7-580" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb7-581"><a href="#cb7-581" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-582"><a href="#cb7-582" aria-hidden="true" tabindex="-1"></a>**변동성 조정 위클리 양매도 포트폴리오**의 주요 성과는 다음과 같습니다.</span>
<span id="cb7-583"><a href="#cb7-583" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-584"><a href="#cb7-584" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>옵션 매도주기 축소(월간 $\rightarrow$ 주간) : **현금흐름 개선 및 프리미엄 수익 극대화**</span>
<span id="cb7-585"><a href="#cb7-585" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-586"><a href="#cb7-586" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>VW양매도 포트폴리오는 연평균 50회의 수익이 발생하는 반면, 일반 양매도 포트폴리오는 12회(월1회) 발생.</span>
<span id="cb7-587"><a href="#cb7-587" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>1회 발생 수익은 4배 미만으로 감소하여 평균 수익이 증가하였고, 수익주기가 짧아지면서 현금유동성 개선</span>
<span id="cb7-588"><a href="#cb7-588" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-589"><a href="#cb7-589" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>행사가격 범위 조정(5% $\rightarrow$ $\sigma$연동) : **포트폴리오 안정성 증가 및 리스크 축소**</span>
<span id="cb7-590"><a href="#cb7-590" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-591"><a href="#cb7-591" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>일반 양매도 전략의 손실발생비율(권리행사비율)은 시장 상황에 따라 0\~50%까지 큰 폭으로 변동</span>
<span id="cb7-592"><a href="#cb7-592" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>반면, 본 포트폴리오는 행사가격 범위를 변동성 수준에 조정하므로 비율이 10\~30%수준으로 안정화</span>
<span id="cb7-593"><a href="#cb7-593" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>손실에 대한 예측가능성 및 포트폴리오 변동성이 개선되었으며 1회 손실도 감내 가능한 수준으로 축소</span>
<span id="cb7-594"><a href="#cb7-594" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-595"><a href="#cb7-595" aria-hidden="true" tabindex="-1"></a><span class="ss">3.  </span>**소결 : VW양매도 전략은 수익률, 리스크 측면에서 코스피200지수 및 일반 양매도 전략을 Outperform**</span>
<span id="cb7-596"><a href="#cb7-596" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-597"><a href="#cb7-597" aria-hidden="true" tabindex="-1"></a>\newpage</span>
<span id="cb7-598"><a href="#cb7-598" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-599"><a href="#cb7-599" aria-hidden="true" tabindex="-1"></a>***그래프3, 4 : 지난 5년 및 3년간 코스피200지수, VW양매도, 5%양매도 누적수익률 및 초과수익***</span>
<span id="cb7-600"><a href="#cb7-600" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-603"><a href="#cb7-603" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb7-604"><a href="#cb7-604" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb7-605"><a href="#cb7-605" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb7-606"><a href="#cb7-606" aria-hidden="true" tabindex="-1"></a>graph1</span>
<span id="cb7-607"><a href="#cb7-607" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb7-608"><a href="#cb7-608" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-611"><a href="#cb7-611" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb7-612"><a href="#cb7-612" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb7-613"><a href="#cb7-613" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb7-614"><a href="#cb7-614" aria-hidden="true" tabindex="-1"></a>graph2</span>
<span id="cb7-615"><a href="#cb7-615" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb7-616"><a href="#cb7-616" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-617"><a href="#cb7-617" aria-hidden="true" tabindex="-1"></a>***표3 : 연도별 VW양매도, 일반 양매도, 코스피200지수의 수익률 및 변동성(월간수익률의 연환산)***</span>
<span id="cb7-618"><a href="#cb7-618" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-621"><a href="#cb7-621" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb7-622"><a href="#cb7-622" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb7-623"><a href="#cb7-623" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb7-624"><a href="#cb7-624" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(table3)</span>
<span id="cb7-625"><a href="#cb7-625" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb7-626"><a href="#cb7-626" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-627"><a href="#cb7-627" aria-hidden="true" tabindex="-1"></a>그래프와 표를 통해 **VW양매도 전략**이 타 전략 대비 **안정적이고 높은 수익을 실현**하였음을 확인할 수 있었습니다.</span>
<span id="cb7-628"><a href="#cb7-628" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-629"><a href="#cb7-629" aria-hidden="true" tabindex="-1"></a><span class="fu">### 한계점</span></span>
<span id="cb7-630"><a href="#cb7-630" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-631"><a href="#cb7-631" aria-hidden="true" tabindex="-1"></a>그러나, **행사가격 범위가 전일 V-Kospi200 지수에 따라 결정**되므로 옵션 매도일 및 보유기간 중 V-Kospi200 지수가 급등락하는 경우 **시장 변동성을 적절히 반영되지 않을 가능성**이 있습니다.</span>
<span id="cb7-632"><a href="#cb7-632" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-633"><a href="#cb7-633" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>당일 장중 지수를 사용할 수 있겠으나 종가보다 신뢰성이 높다고 보기 어렵고, 당일 종가는 매도시점에서 확인 불가</span>
<span id="cb7-634"><a href="#cb7-634" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>보유기간 중 V-Kospi200의 변동에 따라 옵션 행사가격을 리밸런싱하면 보다 정확히 변동성을 반영할 수 있으나, 잦은 거래로 인해 수반되는 비용이 급증</span>
<span id="cb7-635"><a href="#cb7-635" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>시장 변동성이 적절히 반영되지 않는 경우, 프리미엄 수익성이 낮아지고 옵션 권리행사 위험이 증가할 수 있음</span>
<span id="cb7-636"><a href="#cb7-636" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-637"><a href="#cb7-637" aria-hidden="true" tabindex="-1"></a>또한, **실제로 VW양매도 포트폴리오를 운영**한다면 **거래비용 및 유동성 등의 한계점**으로 인해 보완해야할 점이 있으며 이 과정에서 초과수익률 등의 **성과가 다소 희석**될 것으로 예상됩니다.</span>
<span id="cb7-638"><a href="#cb7-638" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-639"><a href="#cb7-639" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>수수료/유동성 등으로 인해 자주 옵션을 매도하는 전략 특성상 거래비용 상승이 수반됨</span>
<span id="cb7-640"><a href="#cb7-640" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>월물 옵션 대비 위클리옵션의 유동성이 낮아, 변동성 확대 국면에서 원하는 위클리옵션의 거래가 없을 수 있음</span>
<span id="cb7-641"><a href="#cb7-641" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-642"><a href="#cb7-642" aria-hidden="true" tabindex="-1"></a><span class="fu">## 4. 포트폴리오 검증 ('25.3.13 ~ 4.10)</span></span>
<span id="cb7-643"><a href="#cb7-643" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-644"><a href="#cb7-644" aria-hidden="true" tabindex="-1"></a>포트폴리오의 성과 검증을 위해 **'25년 3월 옵션만기일부터 1개월간의 성과를 측정**해보겠습니다.</span>
<span id="cb7-645"><a href="#cb7-645" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-646"><a href="#cb7-646" aria-hidden="true" tabindex="-1"></a>**Backtesting과 동일한 방식으로 진행**하였으며, 날짜 등 일부를 제외하고 동일 코드를 재사용하였습니다.</span>
<span id="cb7-647"><a href="#cb7-647" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-650"><a href="#cb7-650" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb7-651"><a href="#cb7-651" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb7-652"><a href="#cb7-652" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: true</span></span>
<span id="cb7-653"><a href="#cb7-653" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb7-654"><a href="#cb7-654" aria-hidden="true" tabindex="-1"></a><span class="co">#| error: false</span></span>
<span id="cb7-655"><a href="#cb7-655" aria-hidden="true" tabindex="-1"></a><span class="co">#| output: false</span></span>
<span id="cb7-656"><a href="#cb7-656" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-657"><a href="#cb7-657" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list=</span><span class="fu">ls</span>())</span>
<span id="cb7-658"><a href="#cb7-658" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb7-659"><a href="#cb7-659" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(knitr)</span>
<span id="cb7-660"><a href="#cb7-660" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb7-661"><a href="#cb7-661" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-662"><a href="#cb7-662" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. 원본데이터 준비</span></span>
<span id="cb7-663"><a href="#cb7-663" aria-hidden="true" tabindex="-1"></a>options_raw <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/options_data_test.csv"</span>) <span class="sc">%&gt;%</span> <span class="fu">tibble</span>()</span>
<span id="cb7-664"><a href="#cb7-664" aria-hidden="true" tabindex="-1"></a>idx_raw <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/idx_data_test.csv"</span>) <span class="sc">%&gt;%</span> <span class="fu">tibble</span>()</span>
<span id="cb7-665"><a href="#cb7-665" aria-hidden="true" tabindex="-1"></a>mmf_raw <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/mmf_test.csv"</span>) <span class="sc">%&gt;%</span> <span class="fu">tibble</span>()</span>
<span id="cb7-666"><a href="#cb7-666" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-667"><a href="#cb7-667" aria-hidden="true" tabindex="-1"></a><span class="co"># 2-1. 데이터 전처리 : KRX openAPI 옵션데이터 전처리</span></span>
<span id="cb7-668"><a href="#cb7-668" aria-hidden="true" tabindex="-1"></a>options <span class="ot">&lt;-</span> options_raw <span class="sc">%&gt;%</span> </span>
<span id="cb7-669"><a href="#cb7-669" aria-hidden="true" tabindex="-1"></a>  <span class="co"># K200, WK200 이외의 옵션 제외</span></span>
<span id="cb7-670"><a href="#cb7-670" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">substr</span>(PROD_NM,<span class="dv">1</span>,<span class="dv">3</span>)<span class="sc">==</span><span class="st">"코스피"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb7-671"><a href="#cb7-671" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 종가가 없는 경우 익일 기준가격(이론가격) 사용</span></span>
<span id="cb7-672"><a href="#cb7-672" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">PRICE =</span> <span class="fu">as.double</span>(<span class="fu">if_else</span>(TDD_CLSPRC<span class="sc">==</span><span class="st">"-"</span>,NXTDD_BAS_PRC,TDD_CLSPRC))) <span class="sc">%&gt;%</span> </span>
<span id="cb7-673"><a href="#cb7-673" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>(PRICE) <span class="sc">%&gt;%</span> </span>
<span id="cb7-674"><a href="#cb7-674" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(BAS_DD,ISU_NM,PRICE,ACC_TRDVOL) <span class="sc">%&gt;%</span> </span>
<span id="cb7-675"><a href="#cb7-675" aria-hidden="true" tabindex="-1"></a>  <span class="fu">separate</span>(ISU_NM, <span class="at">into=</span><span class="fu">c</span>(<span class="st">"PROD"</span>,<span class="st">"RGHT"</span>,<span class="st">"EXP"</span>,<span class="st">"EXER_PRC"</span>), <span class="at">sep=</span><span class="st">' '</span>) <span class="sc">%&gt;%</span></span>
<span id="cb7-676"><a href="#cb7-676" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">EXER_PRC=</span><span class="fu">as.double</span>(EXER_PRC),</span>
<span id="cb7-677"><a href="#cb7-677" aria-hidden="true" tabindex="-1"></a>         <span class="at">EXPMM=</span><span class="fu">if_else</span>(PROD<span class="sc">==</span><span class="st">"코스피200"</span>,<span class="fu">substr</span>(EXP,<span class="dv">3</span>,<span class="dv">6</span>),<span class="fu">substr</span>(EXP,<span class="dv">1</span>,<span class="dv">4</span>)),</span>
<span id="cb7-678"><a href="#cb7-678" aria-hidden="true" tabindex="-1"></a>         <span class="at">EXPWW=</span><span class="fu">if_else</span>(PROD<span class="sc">==</span><span class="st">"코스피200"</span>,<span class="dv">2</span>,<span class="fu">as.integer</span>(<span class="fu">substr</span>(EXP,<span class="dv">6</span>,<span class="dv">6</span>)))) <span class="sc">%&gt;%</span> </span>
<span id="cb7-679"><a href="#cb7-679" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(EXER_PRC<span class="sc">&gt;</span><span class="fu">min</span>(idx_raw<span class="sc">$</span>KOSPI200)<span class="sc">*</span><span class="fl">0.85</span>,</span>
<span id="cb7-680"><a href="#cb7-680" aria-hidden="true" tabindex="-1"></a>         EXER_PRC<span class="sc">&lt;</span><span class="fu">max</span>(idx_raw<span class="sc">$</span>KOSPI200)<span class="sc">*</span><span class="fl">1.15</span>,</span>
<span id="cb7-681"><a href="#cb7-681" aria-hidden="true" tabindex="-1"></a>         PROD<span class="sc">!=</span><span class="st">"코스피위클리M"</span>) <span class="sc">%&gt;%</span> <span class="co"># 월요일 만기 위클리옵션 제외</span></span>
<span id="cb7-682"><a href="#cb7-682" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">PRIOR=</span><span class="fu">as.integer</span>(EXPMM)<span class="sc">*</span><span class="dv">10</span><span class="sc">+</span>EXPWW) <span class="co"># 만기가 짧은 순으로 우선순위 부여</span></span>
<span id="cb7-683"><a href="#cb7-683" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-684"><a href="#cb7-684" aria-hidden="true" tabindex="-1"></a><span class="co"># 2-2. 데이터 전처리 : 옵션 만기일 데이터 생성</span></span>
<span id="cb7-685"><a href="#cb7-685" aria-hidden="true" tabindex="-1"></a>target_date <span class="ot">&lt;-</span> options <span class="sc">%&gt;%</span> </span>
<span id="cb7-686"><a href="#cb7-686" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(.,BAS_DD, PRIOR) <span class="sc">%&gt;%</span> </span>
<span id="cb7-687"><a href="#cb7-687" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(PRIOR, <span class="fu">desc</span>(BAS_DD)) <span class="sc">%&gt;%</span> </span>
<span id="cb7-688"><a href="#cb7-688" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(PRIOR) <span class="sc">%&gt;%</span> </span>
<span id="cb7-689"><a href="#cb7-689" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-690"><a href="#cb7-690" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb7-691"><a href="#cb7-691" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(BAS_DD) <span class="sc">%&gt;%</span> </span>
<span id="cb7-692"><a href="#cb7-692" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(BAS_DD)) <span class="sc">%&gt;%</span> </span>
<span id="cb7-693"><a href="#cb7-693" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(BAS_DD<span class="sc">&lt;</span><span class="dv">20250411</span>)</span>
<span id="cb7-694"><a href="#cb7-694" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-695"><a href="#cb7-695" aria-hidden="true" tabindex="-1"></a><span class="co"># 2-3. 데이터 전처리 : KRX 정보데이터시스템 K200 및 V-K200지수 전처리</span></span>
<span id="cb7-696"><a href="#cb7-696" aria-hidden="true" tabindex="-1"></a>idx_data <span class="ot">&lt;-</span> idx_raw <span class="sc">%&gt;%</span></span>
<span id="cb7-697"><a href="#cb7-697" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(BAS_DD) <span class="sc">%&gt;%</span> </span>
<span id="cb7-698"><a href="#cb7-698" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">LAG_K200=</span><span class="fu">lag</span>(KOSPI200),</span>
<span id="cb7-699"><a href="#cb7-699" aria-hidden="true" tabindex="-1"></a>         <span class="at">LAG_VK200=</span><span class="fu">lag</span>(VKOSPI200))</span>
<span id="cb7-700"><a href="#cb7-700" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-701"><a href="#cb7-701" aria-hidden="true" tabindex="-1"></a>K200_portfolio<span class="ot">=</span>idx_data <span class="sc">%&gt;%</span> </span>
<span id="cb7-702"><a href="#cb7-702" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(mmf_raw, <span class="at">by=</span><span class="st">"BAS_DD"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-703"><a href="#cb7-703" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">RATE=</span>(KOSPI200<span class="sc">-</span>LAG_K200)<span class="sc">/</span>LAG_K200,</span>
<span id="cb7-704"><a href="#cb7-704" aria-hidden="true" tabindex="-1"></a>         <span class="at">YEAR =</span> <span class="fu">substr</span>(BAS_DD, <span class="dv">1</span>, <span class="dv">4</span>),</span>
<span id="cb7-705"><a href="#cb7-705" aria-hidden="true" tabindex="-1"></a>         <span class="at">YM =</span> <span class="fu">ym</span>(<span class="fu">substr</span>(BAS_DD, <span class="dv">1</span>, <span class="dv">6</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb7-706"><a href="#cb7-706" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(YEAR) <span class="sc">%&gt;%</span></span>
<span id="cb7-707"><a href="#cb7-707" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">is.na</span>(RATE)<span class="sc">==</span><span class="cn">FALSE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-708"><a href="#cb7-708" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">RATE_K200 =</span> <span class="fu">prod</span>(<span class="dv">1</span> <span class="sc">+</span> RATE),</span>
<span id="cb7-709"><a href="#cb7-709" aria-hidden="true" tabindex="-1"></a>            <span class="at">MMF =</span> <span class="fu">mean</span>(MMF)<span class="sc">/</span><span class="dv">100</span>,</span>
<span id="cb7-710"><a href="#cb7-710" aria-hidden="true" tabindex="-1"></a>            <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb7-711"><a href="#cb7-711" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb7-712"><a href="#cb7-712" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-713"><a href="#cb7-713" aria-hidden="true" tabindex="-1"></a><span class="co"># 3-1. 포트폴리오 구성 : VW양매도 포트폴리오 기초정보 생성</span></span>
<span id="cb7-714"><a href="#cb7-714" aria-hidden="true" tabindex="-1"></a>target_info <span class="ot">&lt;-</span> target_date <span class="sc">%&gt;%</span> </span>
<span id="cb7-715"><a href="#cb7-715" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(options, <span class="at">by=</span><span class="st">"BAS_DD"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-716"><a href="#cb7-716" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(BAS_DD,PRIOR) <span class="sc">%&gt;%</span> </span>
<span id="cb7-717"><a href="#cb7-717" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(BAS_DD),PRIOR) <span class="sc">%&gt;%</span> </span>
<span id="cb7-718"><a href="#cb7-718" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(BAS_DD) <span class="sc">%&gt;%</span> </span>
<span id="cb7-719"><a href="#cb7-719" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 만기가 도래하는 옵션을 제외하고 우선순위가 높은 옵션 선택</span></span>
<span id="cb7-720"><a href="#cb7-720" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">2</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-721"><a href="#cb7-721" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb7-722"><a href="#cb7-722" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(BAS_DD)) <span class="sc">%&gt;%</span> </span>
<span id="cb7-723"><a href="#cb7-723" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(idx_data, <span class="at">by=</span><span class="st">"BAS_DD"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-724"><a href="#cb7-724" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(mmf_raw, <span class="at">by=</span><span class="st">"BAS_DD"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-725"><a href="#cb7-725" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 옵션 보유기간 및 단기금리(MMF) 계산</span></span>
<span id="cb7-726"><a href="#cb7-726" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">DIFF_DAY=</span><span class="fu">as.integer</span>(<span class="fu">ymd</span>(<span class="fu">lag</span>(BAS_DD))<span class="sc">-</span><span class="fu">ymd</span>(BAS_DD)),</span>
<span id="cb7-727"><a href="#cb7-727" aria-hidden="true" tabindex="-1"></a>         <span class="at">MMF=</span>MMF<span class="sc">*</span><span class="fl">0.01</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-728"><a href="#cb7-728" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 옵션 보유기간에 해당하는 시장기대변동성 계산(V-K200활용)</span></span>
<span id="cb7-729"><a href="#cb7-729" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">VOL=</span>LAG_VK200<span class="sc">*</span><span class="fu">sqrt</span>(DIFF_DAY)<span class="sc">/</span><span class="fu">sqrt</span>(<span class="dv">365</span>)<span class="sc">/</span><span class="dv">100</span>) <span class="sc">%&gt;%</span></span>
<span id="cb7-730"><a href="#cb7-730" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 변동성에 따른 옵션 행사가격 상단(2.5단위 올림) 및 하단(2.5단위 내림) 계산</span></span>
<span id="cb7-731"><a href="#cb7-731" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">TARGET_C_K=</span><span class="fu">ceiling</span>(KOSPI200<span class="sc">*</span>(<span class="dv">1</span><span class="sc">+</span>VOL)<span class="sc">*</span><span class="fl">0.4</span>)<span class="sc">/</span><span class="fl">0.4</span>,</span>
<span id="cb7-732"><a href="#cb7-732" aria-hidden="true" tabindex="-1"></a>         <span class="at">TARGET_P_K=</span><span class="fu">floor</span>(KOSPI200<span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span>VOL)<span class="sc">*</span><span class="fl">0.4</span>)<span class="sc">/</span><span class="fl">0.4</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-733"><a href="#cb7-733" aria-hidden="true" tabindex="-1"></a>  <span class="co"># drop_na(DIFF_DAY) %&gt;% </span></span>
<span id="cb7-734"><a href="#cb7-734" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(BAS_DD,VOL,DIFF_DAY,MMF,KOSPI200,LAG_VK200,PRIOR,TARGET_C_K,TARGET_P_K)</span>
<span id="cb7-735"><a href="#cb7-735" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-736"><a href="#cb7-736" aria-hidden="true" tabindex="-1"></a><span class="co"># 3-2. 포트폴리오 구성 : VW양매도 포트폴리오 거래대상 옵션 정보 생성</span></span>
<span id="cb7-737"><a href="#cb7-737" aria-hidden="true" tabindex="-1"></a>target_options <span class="ot">&lt;-</span> target_info <span class="sc">%&gt;%</span> </span>
<span id="cb7-738"><a href="#cb7-738" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(BAS_DD, PRIOR, TARGET_C_K, TARGET_P_K) <span class="sc">%&gt;%</span> </span>
<span id="cb7-739"><a href="#cb7-739" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols=</span><span class="fu">c</span>(<span class="st">"TARGET_C_K"</span>,<span class="st">"TARGET_P_K"</span>),<span class="at">names_to =</span> <span class="st">"GRP"</span>, <span class="at">values_to =</span> <span class="st">"EXER_PRC"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-740"><a href="#cb7-740" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">RGHT=</span><span class="fu">substr</span>(GRP,<span class="dv">8</span>,<span class="dv">8</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb7-741"><a href="#cb7-741" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(options,<span class="at">by=</span><span class="fu">c</span>(<span class="st">"BAS_DD"</span>,<span class="st">"PRIOR"</span>,<span class="st">"RGHT"</span>,<span class="st">"EXER_PRC"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb7-742"><a href="#cb7-742" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(BAS_DD,GRP,PRICE,ACC_TRDVOL) <span class="sc">%&gt;%</span> </span>
<span id="cb7-743"><a href="#cb7-743" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> <span class="st">"GRP"</span>, <span class="at">values_from =</span> <span class="fu">c</span>(<span class="st">"PRICE"</span>,<span class="st">"ACC_TRDVOL"</span>))</span>
<span id="cb7-744"><a href="#cb7-744" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-745"><a href="#cb7-745" aria-hidden="true" tabindex="-1"></a><span class="co"># 원금 100억원 가정</span></span>
<span id="cb7-746"><a href="#cb7-746" aria-hidden="true" tabindex="-1"></a>cash <span class="ot">=</span> <span class="dv">10000</span><span class="sc">*</span><span class="dv">10000</span><span class="sc">*</span><span class="dv">100</span></span>
<span id="cb7-747"><a href="#cb7-747" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-748"><a href="#cb7-748" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. 포트폴리오 구현 : VW양매도 전략을 구현하여 일자별 손익 계산</span></span>
<span id="cb7-749"><a href="#cb7-749" aria-hidden="true" tabindex="-1"></a>portfolio <span class="ot">&lt;-</span> target_info <span class="sc">%&gt;%</span> </span>
<span id="cb7-750"><a href="#cb7-750" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(target_options,<span class="at">by=</span><span class="st">"BAS_DD"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-751"><a href="#cb7-751" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(BAS_DD) <span class="sc">%&gt;%</span> </span>
<span id="cb7-752"><a href="#cb7-752" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 원금에 따른 옵션 매도수량 계산</span></span>
<span id="cb7-753"><a href="#cb7-753" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">SELL_AMT=</span>cash<span class="sc">/</span><span class="dv">250000</span><span class="sc">/</span>KOSPI200) <span class="sc">%&gt;%</span> </span>
<span id="cb7-754"><a href="#cb7-754" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 옵션 프리미엄(매도수익)) 계산</span></span>
<span id="cb7-755"><a href="#cb7-755" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">PREMIUM=</span>SELL_AMT<span class="sc">*</span>(PRICE_TARGET_C_K<span class="sc">+</span>PRICE_TARGET_P_K)<span class="sc">*</span><span class="dv">250000</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-756"><a href="#cb7-756" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 원금 및 프리미엄의 MMF 이자수익 및 권리행사손실 계산</span></span>
<span id="cb7-757"><a href="#cb7-757" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">INTEREST=</span>(cash<span class="sc">+</span><span class="fu">replace_na</span>(PREMIUM,<span class="dv">0</span>))<span class="sc">*</span>MMF<span class="sc">*</span>DIFF_DAY<span class="sc">/</span><span class="dv">365</span>,</span>
<span id="cb7-758"><a href="#cb7-758" aria-hidden="true" tabindex="-1"></a>         <span class="at">EXERCISE=</span>(<span class="fu">if_else</span>(<span class="fu">lead</span>(KOSPI200)<span class="sc">-</span>TARGET_C_K<span class="sc">&gt;</span><span class="dv">0</span>,<span class="fu">lead</span>(KOSPI200)<span class="sc">-</span>TARGET_C_K,<span class="dv">0</span>)<span class="sc">+</span></span>
<span id="cb7-759"><a href="#cb7-759" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">if_else</span>(TARGET_P_K<span class="sc">-</span><span class="fu">lead</span>(KOSPI200)<span class="sc">&gt;</span><span class="dv">0</span>,TARGET_P_K<span class="sc">-</span><span class="fu">lead</span>(KOSPI200),<span class="dv">0</span>))<span class="sc">*</span><span class="dv">250000</span><span class="sc">*</span>SELL_AMT) <span class="sc">%&gt;%</span> </span>
<span id="cb7-760"><a href="#cb7-760" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 주단위 포트폴리오 손익 계산(원금 100억 가정, 당일 투자시 다음주 실현손익을 의미)</span></span>
<span id="cb7-761"><a href="#cb7-761" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">REVENUE=</span>PREMIUM<span class="sc">+</span>INTEREST<span class="sc">-</span>EXERCISE) <span class="sc">%&gt;%</span> </span>
<span id="cb7-762"><a href="#cb7-762" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 거래대상 옵션이 상장되어있지 않은 경우, MMF수익만 고려</span></span>
<span id="cb7-763"><a href="#cb7-763" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">REVENUE=</span><span class="fu">if_else</span>(<span class="fu">is.na</span>(REVENUE),INTEREST,REVENUE)) <span class="sc">%&gt;%</span> </span>
<span id="cb7-764"><a href="#cb7-764" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">RATE=</span>REVENUE<span class="sc">/</span>cash,</span>
<span id="cb7-765"><a href="#cb7-765" aria-hidden="true" tabindex="-1"></a>         <span class="at">Group=</span><span class="st">"Vol-adj. Weekly"</span>)  <span class="co"># 주단위 포트폴리오 수익률</span></span>
<span id="cb7-766"><a href="#cb7-766" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-767"><a href="#cb7-767" aria-hidden="true" tabindex="-1"></a><span class="co"># 5. 비교군 포트폴리오 생성 : 월별 5% OTM 양매도 전략</span></span>
<span id="cb7-768"><a href="#cb7-768" aria-hidden="true" tabindex="-1"></a>options2 <span class="ot">&lt;-</span> options <span class="sc">%&gt;%</span> </span>
<span id="cb7-769"><a href="#cb7-769" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(PROD<span class="sc">==</span><span class="st">"코스피200"</span>)</span>
<span id="cb7-770"><a href="#cb7-770" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-771"><a href="#cb7-771" aria-hidden="true" tabindex="-1"></a><span class="co"># 옵션 만기일(매달) 생성</span></span>
<span id="cb7-772"><a href="#cb7-772" aria-hidden="true" tabindex="-1"></a>target_date2 <span class="ot">&lt;-</span> options2 <span class="sc">%&gt;%</span> </span>
<span id="cb7-773"><a href="#cb7-773" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(.,BAS_DD, PRIOR) <span class="sc">%&gt;%</span> </span>
<span id="cb7-774"><a href="#cb7-774" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(PRIOR, <span class="fu">desc</span>(BAS_DD)) <span class="sc">%&gt;%</span> </span>
<span id="cb7-775"><a href="#cb7-775" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(PRIOR) <span class="sc">%&gt;%</span> </span>
<span id="cb7-776"><a href="#cb7-776" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-777"><a href="#cb7-777" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb7-778"><a href="#cb7-778" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(BAS_DD) <span class="sc">%&gt;%</span> </span>
<span id="cb7-779"><a href="#cb7-779" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(BAS_DD)) <span class="sc">%&gt;%</span> </span>
<span id="cb7-780"><a href="#cb7-780" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(BAS_DD<span class="sc">&lt;</span><span class="dv">20250411</span>)</span>
<span id="cb7-781"><a href="#cb7-781" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-782"><a href="#cb7-782" aria-hidden="true" tabindex="-1"></a><span class="co"># 일반 양매도 포트폴리오 기본 정보 생성</span></span>
<span id="cb7-783"><a href="#cb7-783" aria-hidden="true" tabindex="-1"></a>target_info2 <span class="ot">&lt;-</span> target_date2 <span class="sc">%&gt;%</span> </span>
<span id="cb7-784"><a href="#cb7-784" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(options2, <span class="at">by=</span><span class="st">"BAS_DD"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-785"><a href="#cb7-785" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(BAS_DD,PRIOR) <span class="sc">%&gt;%</span> </span>
<span id="cb7-786"><a href="#cb7-786" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(BAS_DD),PRIOR) <span class="sc">%&gt;%</span> </span>
<span id="cb7-787"><a href="#cb7-787" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(BAS_DD) <span class="sc">%&gt;%</span> </span>
<span id="cb7-788"><a href="#cb7-788" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 만기가 도래하는 옵션을 제외하고 우선순위가 높은 옵션 선택</span></span>
<span id="cb7-789"><a href="#cb7-789" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">2</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-790"><a href="#cb7-790" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb7-791"><a href="#cb7-791" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(BAS_DD)) <span class="sc">%&gt;%</span> </span>
<span id="cb7-792"><a href="#cb7-792" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(idx_data, <span class="at">by=</span><span class="st">"BAS_DD"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-793"><a href="#cb7-793" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(mmf_raw, <span class="at">by=</span><span class="st">"BAS_DD"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-794"><a href="#cb7-794" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 옵션 보유기간 및 단기금리(MMF) 계산</span></span>
<span id="cb7-795"><a href="#cb7-795" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">DIFF_DAY=</span><span class="fu">as.integer</span>(<span class="fu">ymd</span>(<span class="fu">lag</span>(BAS_DD))<span class="sc">-</span><span class="fu">ymd</span>(BAS_DD)),</span>
<span id="cb7-796"><a href="#cb7-796" aria-hidden="true" tabindex="-1"></a>         <span class="at">MMF=</span>MMF<span class="sc">*</span><span class="fl">0.01</span>,</span>
<span id="cb7-797"><a href="#cb7-797" aria-hidden="true" tabindex="-1"></a>         <span class="at">VOL=</span><span class="fl">0.05</span>) <span class="sc">%&gt;%</span></span>
<span id="cb7-798"><a href="#cb7-798" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 변동성에 따른 옵션 행사가격 상단(2.5단위 올림) 및 하단(2.5단위 내림) 계산</span></span>
<span id="cb7-799"><a href="#cb7-799" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">TARGET_C_K=</span><span class="fu">ceiling</span>(KOSPI200<span class="sc">*</span>(<span class="dv">1</span><span class="sc">+</span>VOL)<span class="sc">*</span><span class="fl">0.4</span>)<span class="sc">/</span><span class="fl">0.4</span>,</span>
<span id="cb7-800"><a href="#cb7-800" aria-hidden="true" tabindex="-1"></a>         <span class="at">TARGET_P_K=</span><span class="fu">floor</span>(KOSPI200<span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span>VOL)<span class="sc">*</span><span class="fl">0.4</span>)<span class="sc">/</span><span class="fl">0.4</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-801"><a href="#cb7-801" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">DIFF_DAY=</span><span class="fu">if_else</span>(<span class="fu">is.na</span>(DIFF_DAY),<span class="dv">28</span>,DIFF_DAY)) <span class="sc">%&gt;%</span> </span>
<span id="cb7-802"><a href="#cb7-802" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(BAS_DD,VOL,DIFF_DAY,MMF,KOSPI200,LAG_VK200,PRIOR,TARGET_C_K,TARGET_P_K)</span>
<span id="cb7-803"><a href="#cb7-803" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-804"><a href="#cb7-804" aria-hidden="true" tabindex="-1"></a><span class="co"># 일반 양매도 포트폴리오 거래대상 옵션</span></span>
<span id="cb7-805"><a href="#cb7-805" aria-hidden="true" tabindex="-1"></a>target_options2 <span class="ot">&lt;-</span> target_info2 <span class="sc">%&gt;%</span> </span>
<span id="cb7-806"><a href="#cb7-806" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(BAS_DD, PRIOR, TARGET_C_K, TARGET_P_K) <span class="sc">%&gt;%</span> </span>
<span id="cb7-807"><a href="#cb7-807" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols=</span><span class="fu">c</span>(<span class="st">"TARGET_C_K"</span>,<span class="st">"TARGET_P_K"</span>),<span class="at">names_to =</span> <span class="st">"GRP"</span>, <span class="at">values_to =</span> <span class="st">"EXER_PRC"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-808"><a href="#cb7-808" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">RGHT=</span><span class="fu">substr</span>(GRP,<span class="dv">8</span>,<span class="dv">8</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb7-809"><a href="#cb7-809" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(options2,<span class="at">by=</span><span class="fu">c</span>(<span class="st">"BAS_DD"</span>,<span class="st">"PRIOR"</span>,<span class="st">"RGHT"</span>,<span class="st">"EXER_PRC"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb7-810"><a href="#cb7-810" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(BAS_DD,GRP,PRICE,ACC_TRDVOL) <span class="sc">%&gt;%</span> </span>
<span id="cb7-811"><a href="#cb7-811" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> <span class="st">"GRP"</span>, <span class="at">values_from =</span> <span class="fu">c</span>(<span class="st">"PRICE"</span>,<span class="st">"ACC_TRDVOL"</span>))</span>
<span id="cb7-812"><a href="#cb7-812" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-813"><a href="#cb7-813" aria-hidden="true" tabindex="-1"></a><span class="co"># 일반 양매도 포트폴리오 구현</span></span>
<span id="cb7-814"><a href="#cb7-814" aria-hidden="true" tabindex="-1"></a>portfolio2 <span class="ot">&lt;-</span> target_info2 <span class="sc">%&gt;%</span> </span>
<span id="cb7-815"><a href="#cb7-815" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(target_options2,<span class="at">by=</span><span class="st">"BAS_DD"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-816"><a href="#cb7-816" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(BAS_DD) <span class="sc">%&gt;%</span> </span>
<span id="cb7-817"><a href="#cb7-817" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 원금에 따른 옵션 매도수량 계산</span></span>
<span id="cb7-818"><a href="#cb7-818" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">SELL_AMT=</span>cash<span class="sc">/</span><span class="dv">250000</span><span class="sc">/</span>KOSPI200) <span class="sc">%&gt;%</span> </span>
<span id="cb7-819"><a href="#cb7-819" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 옵션 프리미엄(매도수익)) 계산</span></span>
<span id="cb7-820"><a href="#cb7-820" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">PREMIUM=</span>SELL_AMT<span class="sc">*</span>(PRICE_TARGET_C_K<span class="sc">+</span>PRICE_TARGET_P_K)<span class="sc">*</span><span class="dv">250000</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-821"><a href="#cb7-821" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 원금 및 프리미엄의 MMF 이자수익 및 권리행사손실 계산</span></span>
<span id="cb7-822"><a href="#cb7-822" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">INTEREST=</span>(cash<span class="sc">+</span><span class="fu">replace_na</span>(PREMIUM,<span class="dv">0</span>))<span class="sc">*</span>MMF<span class="sc">*</span>DIFF_DAY<span class="sc">/</span><span class="dv">365</span>,</span>
<span id="cb7-823"><a href="#cb7-823" aria-hidden="true" tabindex="-1"></a>         <span class="at">EXERCISE=</span>(<span class="fu">if_else</span>(<span class="fu">lead</span>(KOSPI200)<span class="sc">-</span>TARGET_C_K<span class="sc">&gt;</span><span class="dv">0</span>,<span class="fu">lead</span>(KOSPI200)<span class="sc">-</span>TARGET_C_K,<span class="dv">0</span>)<span class="sc">+</span></span>
<span id="cb7-824"><a href="#cb7-824" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">if_else</span>(TARGET_P_K<span class="sc">-</span><span class="fu">lead</span>(KOSPI200)<span class="sc">&gt;</span><span class="dv">0</span>,TARGET_P_K<span class="sc">-</span><span class="fu">lead</span>(KOSPI200),<span class="dv">0</span>))<span class="sc">*</span><span class="dv">250000</span><span class="sc">*</span>SELL_AMT) <span class="sc">%&gt;%</span> </span>
<span id="cb7-825"><a href="#cb7-825" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">EXERCISE=</span><span class="fu">if_else</span>(<span class="fu">is.na</span>(EXERCISE),<span class="dv">0</span>,EXERCISE)) <span class="sc">%&gt;%</span> </span>
<span id="cb7-826"><a href="#cb7-826" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 주단위 포트폴리오 손익 계산(원금 100억 가정, 당일 투자시 다음주 실현손익을 의미)</span></span>
<span id="cb7-827"><a href="#cb7-827" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">REVENUE=</span>PREMIUM<span class="sc">+</span>INTEREST<span class="sc">-</span>EXERCISE) <span class="sc">%&gt;%</span> </span>
<span id="cb7-828"><a href="#cb7-828" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 거래대상 옵션이 상장되어있지 않은 경우, MMF수익만 고려</span></span>
<span id="cb7-829"><a href="#cb7-829" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">REVENUE=</span><span class="fu">if_else</span>(<span class="fu">is.na</span>(REVENUE),INTEREST,REVENUE)) <span class="sc">%&gt;%</span> </span>
<span id="cb7-830"><a href="#cb7-830" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">RATE=</span>REVENUE<span class="sc">/</span>cash,</span>
<span id="cb7-831"><a href="#cb7-831" aria-hidden="true" tabindex="-1"></a>         <span class="at">Group=</span><span class="st">"Monthly"</span>) <span class="co"># 주단위 포트폴리오 수익률</span></span>
<span id="cb7-832"><a href="#cb7-832" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-833"><a href="#cb7-833" aria-hidden="true" tabindex="-1"></a>portfolio <span class="ot">&lt;-</span> portfolio <span class="sc">%&gt;%</span> <span class="fu">filter</span>(BAS_DD<span class="sc">!=</span><span class="dv">20250410</span>)</span>
<span id="cb7-834"><a href="#cb7-834" aria-hidden="true" tabindex="-1"></a>portfolio2 <span class="ot">&lt;-</span> portfolio2 <span class="sc">%&gt;%</span> <span class="fu">filter</span>(BAS_DD<span class="sc">!=</span><span class="dv">20250410</span>)</span>
<span id="cb7-835"><a href="#cb7-835" aria-hidden="true" tabindex="-1"></a>portfolio3 <span class="ot">&lt;-</span> portfolio <span class="sc">%&gt;%</span> </span>
<span id="cb7-836"><a href="#cb7-836" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.numeric), sum)) <span class="sc">%&gt;%</span> </span>
<span id="cb7-837"><a href="#cb7-837" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Group=</span><span class="st">"Vol-adj. Weekly Sum"</span>)</span>
<span id="cb7-838"><a href="#cb7-838" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-839"><a href="#cb7-839" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-840"><a href="#cb7-840" aria-hidden="true" tabindex="-1"></a><span class="co"># 요약표 4 : 검증 자료</span></span>
<span id="cb7-841"><a href="#cb7-841" aria-hidden="true" tabindex="-1"></a>table4 <span class="ot">&lt;-</span> portfolio <span class="sc">%&gt;%</span></span>
<span id="cb7-842"><a href="#cb7-842" aria-hidden="true" tabindex="-1"></a>  <span class="fu">union_all</span>(portfolio2) <span class="sc">%&gt;%</span></span>
<span id="cb7-843"><a href="#cb7-843" aria-hidden="true" tabindex="-1"></a>  <span class="fu">union_all</span>(portfolio3) <span class="sc">%&gt;%</span> </span>
<span id="cb7-844"><a href="#cb7-844" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(BAS_DD, Group) <span class="sc">%&gt;%</span></span>
<span id="cb7-845"><a href="#cb7-845" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">Premium =</span> <span class="fu">round</span>(<span class="fu">mean</span>(PREMIUM)<span class="sc">/</span><span class="dv">10000</span>,<span class="dv">0</span>),</span>
<span id="cb7-846"><a href="#cb7-846" aria-hidden="true" tabindex="-1"></a>            <span class="at">Interest =</span> <span class="fu">round</span>(<span class="fu">mean</span>(INTEREST)<span class="sc">/</span><span class="dv">10000</span>,<span class="dv">0</span>),</span>
<span id="cb7-847"><a href="#cb7-847" aria-hidden="true" tabindex="-1"></a>            <span class="at">Loss =</span> <span class="fu">round</span>(<span class="fu">mean</span>(EXERCISE)<span class="sc">/</span><span class="dv">10000</span>,<span class="dv">0</span>),</span>
<span id="cb7-848"><a href="#cb7-848" aria-hidden="true" tabindex="-1"></a>            <span class="at">Revenue =</span> <span class="fu">round</span>(<span class="fu">mean</span>(REVENUE)<span class="sc">/</span><span class="dv">10000</span>,<span class="dv">0</span>),</span>
<span id="cb7-849"><a href="#cb7-849" aria-hidden="true" tabindex="-1"></a>            <span class="at">Return =</span> <span class="fu">round</span>(<span class="fu">prod</span>(<span class="dv">1</span> <span class="sc">+</span> RATE)<span class="sc">-</span><span class="dv">1</span>,<span class="dv">2</span>),</span>
<span id="cb7-850"><a href="#cb7-850" aria-hidden="true" tabindex="-1"></a>            <span class="at">.groups =</span> <span class="st">"drop"</span>)</span>
<span id="cb7-851"><a href="#cb7-851" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-852"><a href="#cb7-852" aria-hidden="true" tabindex="-1"></a><span class="co"># 그래프 4 : 검증기간중 코스피200지수 추이</span></span>
<span id="cb7-853"><a href="#cb7-853" aria-hidden="true" tabindex="-1"></a>graph4 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(idx_raw, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">ymd</span>(BAS_DD))) <span class="sc">+</span></span>
<span id="cb7-854"><a href="#cb7-854" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> KOSPI200, <span class="at">color =</span> <span class="st">"KOSPI200"</span>), <span class="at">size =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb7-855"><a href="#cb7-855" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> (VKOSPI200 <span class="sc">-</span> <span class="dv">19</span>) <span class="sc">/</span> <span class="dv">26</span> <span class="sc">*</span> <span class="dv">60</span> <span class="sc">+</span> <span class="dv">300</span>, <span class="at">color =</span> <span class="st">"VKOSPI200"</span>), <span class="at">size =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb7-856"><a href="#cb7-856" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fu">ymd</span>(<span class="fu">c</span>(<span class="st">"20250313"</span>, <span class="st">"20250320"</span>, <span class="st">"20250327"</span>, <span class="st">"20250403"</span>,<span class="st">"20250410"</span>)),</span>
<span id="cb7-857"><a href="#cb7-857" aria-hidden="true" tabindex="-1"></a>             <span class="at">linetype =</span> <span class="st">"dotted"</span>, <span class="at">color =</span> <span class="st">"grey40"</span>) <span class="sc">+</span></span>
<span id="cb7-858"><a href="#cb7-858" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">name =</span> <span class="st">"KOSPI200"</span>,<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">300</span>, <span class="dv">360</span>),</span>
<span id="cb7-859"><a href="#cb7-859" aria-hidden="true" tabindex="-1"></a>                     <span class="at">sec.axis =</span> <span class="fu">sec_axis</span>(</span>
<span id="cb7-860"><a href="#cb7-860" aria-hidden="true" tabindex="-1"></a>                       <span class="sc">~</span> (.<span class="sc">-</span><span class="dv">300</span>) <span class="sc">/</span> <span class="dv">60</span> <span class="sc">*</span> <span class="dv">26</span> <span class="sc">+</span> <span class="dv">19</span>, <span class="at">name =</span> <span class="st">"VKOSPI200"</span>)) <span class="sc">+</span></span>
<span id="cb7-861"><a href="#cb7-861" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"KOSPI200"</span> <span class="ot">=</span> <span class="st">"blue"</span>, <span class="st">"VKOSPI200"</span> <span class="ot">=</span> <span class="st">"red"</span>),</span>
<span id="cb7-862"><a href="#cb7-862" aria-hidden="true" tabindex="-1"></a>                     <span class="at">guide =</span> <span class="fu">guide_legend</span>(<span class="at">direction =</span> <span class="st">"horizontal"</span>)) <span class="sc">+</span></span>
<span id="cb7-863"><a href="#cb7-863" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Kospi200 &amp; V-Kospi200 indices"</span>,<span class="at">x =</span> <span class="cn">NULL</span>,<span class="at">color =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb7-864"><a href="#cb7-864" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb7-865"><a href="#cb7-865" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_date</span>(<span class="at">date_breaks =</span> <span class="st">"3 days"</span>, <span class="at">date_labels =</span> <span class="st">"%m-%d"</span>) <span class="sc">+</span></span>
<span id="cb7-866"><a href="#cb7-866" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>),</span>
<span id="cb7-867"><a href="#cb7-867" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">0.95</span>))</span>
<span id="cb7-868"><a href="#cb7-868" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb7-869"><a href="#cb7-869" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-870"><a href="#cb7-870" aria-hidden="true" tabindex="-1"></a>***표4 : 검증기간('25.3.13 ~ 4.10) VW양매도 및 일반 양매도 전략 성과***</span>
<span id="cb7-871"><a href="#cb7-871" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-874"><a href="#cb7-874" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb7-875"><a href="#cb7-875" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb7-876"><a href="#cb7-876" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb7-877"><a href="#cb7-877" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(table4)</span>
<span id="cb7-878"><a href="#cb7-878" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb7-879"><a href="#cb7-879" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-880"><a href="#cb7-880" aria-hidden="true" tabindex="-1"></a>**검증기간 중 VW양매도 전략은 옵션을 4회 매도하였고, 일반 양매도는 1회 매도**하였습니다.</span>
<span id="cb7-881"><a href="#cb7-881" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-882"><a href="#cb7-882" aria-hidden="true" tabindex="-1"></a>VW양매도 전략의 **프리미엄이 4회 발생하면서 수익성은 개선**되었지만, 세번째 매도시기에 **큰 손실이 발생하면서 순이익이 악화**되었습니다. 벡테스팅 결과와 비교할 때 **상반된 결과**입니다.</span>
<span id="cb7-883"><a href="#cb7-883" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-884"><a href="#cb7-884" aria-hidden="true" tabindex="-1"></a>그 **원인은 최근 트럼프 행정부의 관세 부과 정책의 영향**으로, 증시가 이례적으로 급등락한 데에서 찾을 수 있었습니다.</span>
<span id="cb7-885"><a href="#cb7-885" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-886"><a href="#cb7-886" aria-hidden="true" tabindex="-1"></a>\newpage</span>
<span id="cb7-887"><a href="#cb7-887" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-888"><a href="#cb7-888" aria-hidden="true" tabindex="-1"></a>***그래프5 : 검증기간('25.3.13 ~ 4.10) Kospi200 및 V-Kospi200 지수 추이***</span>
<span id="cb7-891"><a href="#cb7-891" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb7-892"><a href="#cb7-892" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb7-893"><a href="#cb7-893" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb7-894"><a href="#cb7-894" aria-hidden="true" tabindex="-1"></a>graph4</span>
<span id="cb7-895"><a href="#cb7-895" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb7-896"><a href="#cb7-896" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-897"><a href="#cb7-897" aria-hidden="true" tabindex="-1"></a>먼저, **3.27일 예상변동성(V-K200)이 낮아 행사가격 범위가 좁게 형성**되어 VW양매도 전략이 실행되었고, 이후 관세 정책 영향으로 지수가 급락하면서 **큰 손실이 발생**하게 되었습니다.</span>
<span id="cb7-898"><a href="#cb7-898" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-899"><a href="#cb7-899" aria-hidden="true" tabindex="-1"></a>반면 **월별 전략은 만기 직전에 관세가 연기**되면서 **증시가 회복**하였고(304 &gt; 325), 손실을 피하게 되었습니다. </span>
<span id="cb7-900"><a href="#cb7-900" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-901"><a href="#cb7-901" aria-hidden="true" tabindex="-1"></a>다소 아쉬운 결과이나, **VW양매도 전략의 한계점과 특수한 상황에서는 오히려 불리하다는 점**을 알 수 있었습니다.</span>
<span id="cb7-902"><a href="#cb7-902" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-903"><a href="#cb7-903" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>VW양매도 전략은 **시장 변동성이 적절히 반영되지 않을 가능성**이 있고, 이 경우 예기치 못한 손실이 발생할 수 있음</span>
<span id="cb7-904"><a href="#cb7-904" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**옵션 만기가 짧은 것은 일반적**으로 수익성, 유동성 등에서 **장점**이 있으나, **증시가 급락 후 회복하는 상황에서는 만기가 긴 옵션이 유리**할 수 있음</span>
<span id="cb7-905"><a href="#cb7-905" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-906"><a href="#cb7-906" aria-hidden="true" tabindex="-1"></a>\newpage</span>
<span id="cb7-907"><a href="#cb7-907" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-908"><a href="#cb7-908" aria-hidden="true" tabindex="-1"></a><span class="fu">## 5. Appendix : Python, R code</span></span>
<span id="cb7-909"><a href="#cb7-909" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-910"><a href="#cb7-910" aria-hidden="true" tabindex="-1"></a><span class="fu">### Pyhon code : 데이터 수집 및 전처리</span></span>
<span id="cb7-911"><a href="#cb7-911" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-914"><a href="#cb7-914" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb7-915"><a href="#cb7-915" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb7-916"><a href="#cb7-916" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb7-917"><a href="#cb7-917" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> requests</span>
<span id="cb7-918"><a href="#cb7-918" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb7-919"><a href="#cb7-919" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb7-920"><a href="#cb7-920" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> aiohttp</span>
<span id="cb7-921"><a href="#cb7-921" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> asyncio</span>
<span id="cb7-922"><a href="#cb7-922" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-923"><a href="#cb7-923" aria-hidden="true" tabindex="-1"></a><span class="co"># KRX OpenAPI 예시</span></span>
<span id="cb7-924"><a href="#cb7-924" aria-hidden="true" tabindex="-1"></a>url <span class="op">=</span> <span class="st">'http://data-dbg.krx.co.kr/svc/sample/apis/drv/opt_bydd_trd?basDd=20250312'</span></span>
<span id="cb7-925"><a href="#cb7-925" aria-hidden="true" tabindex="-1"></a>headers <span class="op">=</span> {<span class="st">'AUTH_KEY'</span>: <span class="st">'74D1B99DFBF345BBA3FB4476510A4BED4C78D13A'</span>}</span>
<span id="cb7-926"><a href="#cb7-926" aria-hidden="true" tabindex="-1"></a>res <span class="op">=</span> requests.get(url<span class="op">=</span>url, headers<span class="op">=</span>headers)</span>
<span id="cb7-927"><a href="#cb7-927" aria-hidden="true" tabindex="-1"></a>res.text</span>
<span id="cb7-928"><a href="#cb7-928" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-929"><a href="#cb7-929" aria-hidden="true" tabindex="-1"></a><span class="co"># KRX OpenAPI를 이용한 옵션 데이터 수집 (네트워크 병렬 처리)</span></span>
<span id="cb7-930"><a href="#cb7-930" aria-hidden="true" tabindex="-1"></a>idx_data <span class="op">=</span> pd.read_csv(<span class="st">'data/idx_data.csv'</span>)</span>
<span id="cb7-931"><a href="#cb7-931" aria-hidden="true" tabindex="-1"></a>url <span class="op">=</span> <span class="st">'http://data-dbg.krx.co.kr/svc/apis/drv/opt_bydd_trd?basDd='</span></span>
<span id="cb7-932"><a href="#cb7-932" aria-hidden="true" tabindex="-1"></a>key <span class="op">=</span> <span class="st">'BDFA640BBCE84C4B8A465EA024D50D6F3FD909FF'</span></span>
<span id="cb7-933"><a href="#cb7-933" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-934"><a href="#cb7-934" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> fetch(session, url, bas_dd):</span>
<span id="cb7-935"><a href="#cb7-935" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="cf">with</span> session.get(url <span class="op">+</span> bas_dd, headers<span class="op">=</span>{<span class="st">'AUTH_KEY'</span>: key}) <span class="im">as</span> response:</span>
<span id="cb7-936"><a href="#cb7-936" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="cf">await</span> response.json()</span>
<span id="cb7-937"><a href="#cb7-937" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-938"><a href="#cb7-938" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> fetch_all(bas_dd_list, url):</span>
<span id="cb7-939"><a href="#cb7-939" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="cf">with</span> aiohttp.ClientSession() <span class="im">as</span> session:</span>
<span id="cb7-940"><a href="#cb7-940" aria-hidden="true" tabindex="-1"></a>        tasks <span class="op">=</span> [fetch(session, url, <span class="bu">str</span>(bas_dd)) <span class="cf">for</span> bas_dd <span class="kw">in</span> bas_dd_list]</span>
<span id="cb7-941"><a href="#cb7-941" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="cf">await</span> asyncio.gather(<span class="op">*</span>tasks)</span>
<span id="cb7-942"><a href="#cb7-942" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-943"><a href="#cb7-943" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> main():</span>
<span id="cb7-944"><a href="#cb7-944" aria-hidden="true" tabindex="-1"></a>    bas_dd_list <span class="op">=</span> idx_data[<span class="st">'BAS_DD'</span>].astype(<span class="bu">str</span>).tolist()</span>
<span id="cb7-945"><a href="#cb7-945" aria-hidden="true" tabindex="-1"></a>    responses <span class="op">=</span> <span class="cf">await</span> fetch_all(bas_dd_list, url)</span>
<span id="cb7-946"><a href="#cb7-946" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-947"><a href="#cb7-947" aria-hidden="true" tabindex="-1"></a>    data_list <span class="op">=</span> [pd.json_normalize(res[<span class="st">'OutBlock_1'</span>]) <span class="cf">for</span> res <span class="kw">in</span> responses <span class="cf">if</span> <span class="st">'OutBlock_1'</span> <span class="kw">in</span> res <span class="kw">and</span> res[<span class="st">'OutBlock_1'</span>]]</span>
<span id="cb7-948"><a href="#cb7-948" aria-hidden="true" tabindex="-1"></a>    options <span class="op">=</span> pd.concat(data_list, axis<span class="op">=</span><span class="dv">0</span>, ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb7-949"><a href="#cb7-949" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-950"><a href="#cb7-950" aria-hidden="true" tabindex="-1"></a>    <span class="co"># CSV 저장</span></span>
<span id="cb7-951"><a href="#cb7-951" aria-hidden="true" tabindex="-1"></a>    options.to_csv(<span class="st">"options_data.csv"</span>, encoding<span class="op">=</span><span class="st">"utf-8-sig"</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb7-952"><a href="#cb7-952" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"complete"</span>)</span>
<span id="cb7-953"><a href="#cb7-953" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb7-954"><a href="#cb7-954" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-955"><a href="#cb7-955" aria-hidden="true" tabindex="-1"></a><span class="fu">### R code 1 : 데이터 가공, Backtesting</span></span>
<span id="cb7-956"><a href="#cb7-956" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-959"><a href="#cb7-959" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb7-960"><a href="#cb7-960" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb7-961"><a href="#cb7-961" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb7-962"><a href="#cb7-962" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb7-963"><a href="#cb7-963" aria-hidden="true" tabindex="-1"></a><span class="co">#| error: false</span></span>
<span id="cb7-964"><a href="#cb7-964" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-965"><a href="#cb7-965" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list=</span><span class="fu">ls</span>())</span>
<span id="cb7-966"><a href="#cb7-966" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb7-967"><a href="#cb7-967" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(knitr)</span>
<span id="cb7-968"><a href="#cb7-968" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb7-969"><a href="#cb7-969" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-970"><a href="#cb7-970" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. 원본데이터 준비</span></span>
<span id="cb7-971"><a href="#cb7-971" aria-hidden="true" tabindex="-1"></a>options_raw <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/options_data.csv"</span>) <span class="sc">%&gt;%</span> <span class="fu">tibble</span>()</span>
<span id="cb7-972"><a href="#cb7-972" aria-hidden="true" tabindex="-1"></a>idx_raw <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/idx_data.csv"</span>) <span class="sc">%&gt;%</span> <span class="fu">tibble</span>()</span>
<span id="cb7-973"><a href="#cb7-973" aria-hidden="true" tabindex="-1"></a>mmf_raw <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/mmf.csv"</span>) <span class="sc">%&gt;%</span> <span class="fu">tibble</span>()</span>
<span id="cb7-974"><a href="#cb7-974" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-975"><a href="#cb7-975" aria-hidden="true" tabindex="-1"></a><span class="co"># 2-1. 데이터 전처리 : KRX openAPI 옵션데이터 전처리</span></span>
<span id="cb7-976"><a href="#cb7-976" aria-hidden="true" tabindex="-1"></a>options <span class="ot">&lt;-</span> options_raw <span class="sc">%&gt;%</span> </span>
<span id="cb7-977"><a href="#cb7-977" aria-hidden="true" tabindex="-1"></a>  <span class="co"># K200, WK200 이외의 옵션 제외</span></span>
<span id="cb7-978"><a href="#cb7-978" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">substr</span>(PROD_NM,<span class="dv">1</span>,<span class="dv">3</span>)<span class="sc">==</span><span class="st">"코스피"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb7-979"><a href="#cb7-979" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 종가가 없는 경우 익일 기준가격(이론가격) 사용</span></span>
<span id="cb7-980"><a href="#cb7-980" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">PRICE =</span> <span class="fu">as.double</span>(<span class="fu">if_else</span>(TDD_CLSPRC<span class="sc">==</span><span class="st">"-"</span>,NXTDD_BAS_PRC,TDD_CLSPRC))) <span class="sc">%&gt;%</span> </span>
<span id="cb7-981"><a href="#cb7-981" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>(PRICE) <span class="sc">%&gt;%</span> </span>
<span id="cb7-982"><a href="#cb7-982" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(BAS_DD,ISU_NM,PRICE,ACC_TRDVOL) <span class="sc">%&gt;%</span> </span>
<span id="cb7-983"><a href="#cb7-983" aria-hidden="true" tabindex="-1"></a>  <span class="fu">separate</span>(ISU_NM, <span class="at">into=</span><span class="fu">c</span>(<span class="st">"PROD"</span>,<span class="st">"RGHT"</span>,<span class="st">"EXP"</span>,<span class="st">"EXER_PRC"</span>), <span class="at">sep=</span><span class="st">' '</span>) <span class="sc">%&gt;%</span></span>
<span id="cb7-984"><a href="#cb7-984" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">EXER_PRC=</span><span class="fu">as.double</span>(EXER_PRC),</span>
<span id="cb7-985"><a href="#cb7-985" aria-hidden="true" tabindex="-1"></a>         <span class="at">EXPMM=</span><span class="fu">if_else</span>(PROD<span class="sc">==</span><span class="st">"코스피200"</span>,<span class="fu">substr</span>(EXP,<span class="dv">3</span>,<span class="dv">6</span>),<span class="fu">substr</span>(EXP,<span class="dv">1</span>,<span class="dv">4</span>)),</span>
<span id="cb7-986"><a href="#cb7-986" aria-hidden="true" tabindex="-1"></a>         <span class="at">EXPWW=</span><span class="fu">if_else</span>(PROD<span class="sc">==</span><span class="st">"코스피200"</span>,<span class="dv">2</span>,<span class="fu">as.integer</span>(<span class="fu">substr</span>(EXP,<span class="dv">6</span>,<span class="dv">6</span>)))) <span class="sc">%&gt;%</span> </span>
<span id="cb7-987"><a href="#cb7-987" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(EXER_PRC<span class="sc">&gt;</span><span class="fu">min</span>(idx_raw<span class="sc">$</span>KOSPI200)<span class="sc">*</span><span class="fl">0.85</span>,</span>
<span id="cb7-988"><a href="#cb7-988" aria-hidden="true" tabindex="-1"></a>         EXER_PRC<span class="sc">&lt;</span><span class="fu">max</span>(idx_raw<span class="sc">$</span>KOSPI200)<span class="sc">*</span><span class="fl">1.15</span>,</span>
<span id="cb7-989"><a href="#cb7-989" aria-hidden="true" tabindex="-1"></a>         PROD<span class="sc">!=</span><span class="st">"코스피위클리M"</span>) <span class="sc">%&gt;%</span> <span class="co"># 월요일 만기 위클리옵션 제외</span></span>
<span id="cb7-990"><a href="#cb7-990" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">PRIOR=</span><span class="fu">as.integer</span>(EXPMM)<span class="sc">*</span><span class="dv">10</span><span class="sc">+</span>EXPWW) <span class="co"># 만기가 짧은 순으로 우선순위 부여</span></span>
<span id="cb7-991"><a href="#cb7-991" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-992"><a href="#cb7-992" aria-hidden="true" tabindex="-1"></a><span class="co"># 2-2. 데이터 전처리 : 옵션 만기일 데이터 생성</span></span>
<span id="cb7-993"><a href="#cb7-993" aria-hidden="true" tabindex="-1"></a>target_date <span class="ot">&lt;-</span> options <span class="sc">%&gt;%</span> </span>
<span id="cb7-994"><a href="#cb7-994" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(.,BAS_DD, PRIOR) <span class="sc">%&gt;%</span> </span>
<span id="cb7-995"><a href="#cb7-995" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(PRIOR, <span class="fu">desc</span>(BAS_DD)) <span class="sc">%&gt;%</span> </span>
<span id="cb7-996"><a href="#cb7-996" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(PRIOR) <span class="sc">%&gt;%</span> </span>
<span id="cb7-997"><a href="#cb7-997" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-998"><a href="#cb7-998" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb7-999"><a href="#cb7-999" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(BAS_DD) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1000"><a href="#cb7-1000" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(BAS_DD)) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1001"><a href="#cb7-1001" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(BAS_DD<span class="sc">&lt;</span><span class="dv">20241231</span>, BAS_DD<span class="sc">&gt;</span><span class="dv">20200101</span>)</span>
<span id="cb7-1002"><a href="#cb7-1002" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-1003"><a href="#cb7-1003" aria-hidden="true" tabindex="-1"></a><span class="co"># 2-3. 데이터 전처리 : KRX 정보데이터시스템 K200 및 V-K200지수 전처리</span></span>
<span id="cb7-1004"><a href="#cb7-1004" aria-hidden="true" tabindex="-1"></a>idx_data <span class="ot">&lt;-</span> idx_raw <span class="sc">%&gt;%</span></span>
<span id="cb7-1005"><a href="#cb7-1005" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(BAS_DD) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1006"><a href="#cb7-1006" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">LAG_K200=</span><span class="fu">lag</span>(KOSPI200),</span>
<span id="cb7-1007"><a href="#cb7-1007" aria-hidden="true" tabindex="-1"></a>         <span class="at">LAG_VK200=</span><span class="fu">lag</span>(VKOSPI200))</span>
<span id="cb7-1008"><a href="#cb7-1008" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-1009"><a href="#cb7-1009" aria-hidden="true" tabindex="-1"></a>K200_portfolio<span class="ot">=</span>idx_data <span class="sc">%&gt;%</span> </span>
<span id="cb7-1010"><a href="#cb7-1010" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(mmf_raw, <span class="at">by=</span><span class="st">"BAS_DD"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1011"><a href="#cb7-1011" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">RATE=</span>(KOSPI200<span class="sc">-</span>LAG_K200)<span class="sc">/</span>LAG_K200,</span>
<span id="cb7-1012"><a href="#cb7-1012" aria-hidden="true" tabindex="-1"></a>         <span class="at">YEAR =</span> <span class="fu">substr</span>(BAS_DD, <span class="dv">1</span>, <span class="dv">4</span>),</span>
<span id="cb7-1013"><a href="#cb7-1013" aria-hidden="true" tabindex="-1"></a>         <span class="at">YM =</span> <span class="fu">ym</span>(<span class="fu">substr</span>(BAS_DD, <span class="dv">1</span>, <span class="dv">6</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb7-1014"><a href="#cb7-1014" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(YEAR, YM) <span class="sc">%&gt;%</span></span>
<span id="cb7-1015"><a href="#cb7-1015" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">RATE_K200 =</span> <span class="fu">if_else</span>(<span class="fu">is.na</span>(<span class="fu">prod</span>(<span class="dv">1</span> <span class="sc">+</span> RATE)),<span class="dv">0</span>,<span class="fu">prod</span>(<span class="dv">1</span> <span class="sc">+</span> RATE)),</span>
<span id="cb7-1016"><a href="#cb7-1016" aria-hidden="true" tabindex="-1"></a>            <span class="at">MMF =</span> <span class="fu">mean</span>(MMF)<span class="sc">/</span><span class="dv">100</span>,</span>
<span id="cb7-1017"><a href="#cb7-1017" aria-hidden="true" tabindex="-1"></a>            <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb7-1018"><a href="#cb7-1018" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb7-1019"><a href="#cb7-1019" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-1020"><a href="#cb7-1020" aria-hidden="true" tabindex="-1"></a><span class="co"># 3-1. 포트폴리오 구성 : VW양매도 포트폴리오 기초정보 생성</span></span>
<span id="cb7-1021"><a href="#cb7-1021" aria-hidden="true" tabindex="-1"></a>target_info <span class="ot">&lt;-</span> target_date <span class="sc">%&gt;%</span> </span>
<span id="cb7-1022"><a href="#cb7-1022" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(options, <span class="at">by=</span><span class="st">"BAS_DD"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1023"><a href="#cb7-1023" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(BAS_DD,PRIOR) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1024"><a href="#cb7-1024" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(BAS_DD),PRIOR) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1025"><a href="#cb7-1025" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(BAS_DD) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1026"><a href="#cb7-1026" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 만기가 도래하는 옵션을 제외하고 우선순위가 높은 옵션 선택</span></span>
<span id="cb7-1027"><a href="#cb7-1027" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">2</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1028"><a href="#cb7-1028" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb7-1029"><a href="#cb7-1029" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(BAS_DD)) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1030"><a href="#cb7-1030" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(idx_data, <span class="at">by=</span><span class="st">"BAS_DD"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1031"><a href="#cb7-1031" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(mmf_raw, <span class="at">by=</span><span class="st">"BAS_DD"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1032"><a href="#cb7-1032" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 옵션 보유기간 및 단기금리(MMF) 계산</span></span>
<span id="cb7-1033"><a href="#cb7-1033" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">DIFF_DAY=</span><span class="fu">as.integer</span>(<span class="fu">ymd</span>(<span class="fu">lag</span>(BAS_DD))<span class="sc">-</span><span class="fu">ymd</span>(BAS_DD)),</span>
<span id="cb7-1034"><a href="#cb7-1034" aria-hidden="true" tabindex="-1"></a>         <span class="at">MMF=</span>MMF<span class="sc">*</span><span class="fl">0.01</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1035"><a href="#cb7-1035" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 옵션 보유기간에 해당하는 시장기대변동성 계산(V-K200활용)</span></span>
<span id="cb7-1036"><a href="#cb7-1036" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">VOL=</span>LAG_VK200<span class="sc">*</span><span class="fu">sqrt</span>(DIFF_DAY)<span class="sc">/</span><span class="fu">sqrt</span>(<span class="dv">365</span>)<span class="sc">/</span><span class="dv">100</span>) <span class="sc">%&gt;%</span></span>
<span id="cb7-1037"><a href="#cb7-1037" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 변동성에 따른 옵션 행사가격 상단(2.5단위 올림) 및 하단(2.5단위 내림) 계산</span></span>
<span id="cb7-1038"><a href="#cb7-1038" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">TARGET_C_K=</span><span class="fu">ceiling</span>(KOSPI200<span class="sc">*</span>(<span class="dv">1</span><span class="sc">+</span>VOL)<span class="sc">*</span><span class="fl">0.4</span>)<span class="sc">/</span><span class="fl">0.4</span>,</span>
<span id="cb7-1039"><a href="#cb7-1039" aria-hidden="true" tabindex="-1"></a>         <span class="at">TARGET_P_K=</span><span class="fu">floor</span>(KOSPI200<span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span>VOL)<span class="sc">*</span><span class="fl">0.4</span>)<span class="sc">/</span><span class="fl">0.4</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1040"><a href="#cb7-1040" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>(DIFF_DAY) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1041"><a href="#cb7-1041" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(BAS_DD,VOL,DIFF_DAY,MMF,KOSPI200,LAG_VK200,PRIOR,TARGET_C_K,TARGET_P_K)</span>
<span id="cb7-1042"><a href="#cb7-1042" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-1043"><a href="#cb7-1043" aria-hidden="true" tabindex="-1"></a><span class="co"># 3-2. 포트폴리오 구성 : VW양매도 포트폴리오 거래대상 옵션 정보 생성</span></span>
<span id="cb7-1044"><a href="#cb7-1044" aria-hidden="true" tabindex="-1"></a>target_options <span class="ot">&lt;-</span> target_info <span class="sc">%&gt;%</span> </span>
<span id="cb7-1045"><a href="#cb7-1045" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(BAS_DD, PRIOR, TARGET_C_K, TARGET_P_K) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1046"><a href="#cb7-1046" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols=</span><span class="fu">c</span>(<span class="st">"TARGET_C_K"</span>,<span class="st">"TARGET_P_K"</span>),<span class="at">names_to =</span> <span class="st">"GRP"</span>, <span class="at">values_to =</span> <span class="st">"EXER_PRC"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1047"><a href="#cb7-1047" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">RGHT=</span><span class="fu">substr</span>(GRP,<span class="dv">8</span>,<span class="dv">8</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1048"><a href="#cb7-1048" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(options,<span class="at">by=</span><span class="fu">c</span>(<span class="st">"BAS_DD"</span>,<span class="st">"PRIOR"</span>,<span class="st">"RGHT"</span>,<span class="st">"EXER_PRC"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb7-1049"><a href="#cb7-1049" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(BAS_DD,GRP,PRICE,ACC_TRDVOL) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1050"><a href="#cb7-1050" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> <span class="st">"GRP"</span>, <span class="at">values_from =</span> <span class="fu">c</span>(<span class="st">"PRICE"</span>,<span class="st">"ACC_TRDVOL"</span>))</span>
<span id="cb7-1051"><a href="#cb7-1051" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-1052"><a href="#cb7-1052" aria-hidden="true" tabindex="-1"></a><span class="co"># 원금 100억원 가정</span></span>
<span id="cb7-1053"><a href="#cb7-1053" aria-hidden="true" tabindex="-1"></a>cash <span class="ot">=</span> <span class="dv">10000</span><span class="sc">*</span><span class="dv">10000</span><span class="sc">*</span><span class="dv">100</span></span>
<span id="cb7-1054"><a href="#cb7-1054" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-1055"><a href="#cb7-1055" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. 포트폴리오 구현 : VW양매도 전략을 구현하여 일자별 손익 계산</span></span>
<span id="cb7-1056"><a href="#cb7-1056" aria-hidden="true" tabindex="-1"></a>portfolio <span class="ot">&lt;-</span> target_info <span class="sc">%&gt;%</span> </span>
<span id="cb7-1057"><a href="#cb7-1057" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(target_options,<span class="at">by=</span><span class="st">"BAS_DD"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1058"><a href="#cb7-1058" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(BAS_DD) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1059"><a href="#cb7-1059" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 원금에 따른 옵션 매도수량 계산</span></span>
<span id="cb7-1060"><a href="#cb7-1060" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">SELL_AMT=</span>cash<span class="sc">/</span><span class="dv">250000</span><span class="sc">/</span>KOSPI200) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1061"><a href="#cb7-1061" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 옵션 프리미엄(매도수익)) 계산</span></span>
<span id="cb7-1062"><a href="#cb7-1062" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">PREMIUM=</span>SELL_AMT<span class="sc">*</span>(PRICE_TARGET_C_K<span class="sc">+</span>PRICE_TARGET_P_K)<span class="sc">*</span><span class="dv">250000</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1063"><a href="#cb7-1063" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 원금 및 프리미엄의 MMF 이자수익 및 권리행사손실 계산</span></span>
<span id="cb7-1064"><a href="#cb7-1064" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">INTEREST=</span>(cash<span class="sc">+</span><span class="fu">replace_na</span>(PREMIUM,<span class="dv">0</span>))<span class="sc">*</span>MMF<span class="sc">*</span>DIFF_DAY<span class="sc">/</span><span class="dv">365</span>,</span>
<span id="cb7-1065"><a href="#cb7-1065" aria-hidden="true" tabindex="-1"></a>         <span class="at">EXERCISE=</span>(<span class="fu">if_else</span>(<span class="fu">lead</span>(KOSPI200)<span class="sc">-</span>TARGET_C_K<span class="sc">&gt;</span><span class="dv">0</span>,<span class="fu">lead</span>(KOSPI200)<span class="sc">-</span>TARGET_C_K,<span class="dv">0</span>)<span class="sc">+</span></span>
<span id="cb7-1066"><a href="#cb7-1066" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">if_else</span>(TARGET_P_K<span class="sc">-</span><span class="fu">lead</span>(KOSPI200)<span class="sc">&gt;</span><span class="dv">0</span>,TARGET_P_K<span class="sc">-</span><span class="fu">lead</span>(KOSPI200),<span class="dv">0</span>))<span class="sc">*</span><span class="dv">250000</span><span class="sc">*</span>SELL_AMT) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1067"><a href="#cb7-1067" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 주단위 포트폴리오 손익 계산(원금 100억 가정, 당일 투자시 다음주 실현손익을 의미)</span></span>
<span id="cb7-1068"><a href="#cb7-1068" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">REVENUE=</span>PREMIUM<span class="sc">+</span>INTEREST<span class="sc">-</span>EXERCISE) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1069"><a href="#cb7-1069" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 거래대상 옵션이 상장되어있지 않은 경우, MMF수익만 고려</span></span>
<span id="cb7-1070"><a href="#cb7-1070" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">REVENUE=</span><span class="fu">if_else</span>(<span class="fu">is.na</span>(REVENUE),INTEREST,REVENUE)) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1071"><a href="#cb7-1071" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">RATE=</span>REVENUE<span class="sc">/</span>cash)  <span class="co"># 주단위 포트폴리오 수익률</span></span>
<span id="cb7-1072"><a href="#cb7-1072" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-1073"><a href="#cb7-1073" aria-hidden="true" tabindex="-1"></a><span class="co"># 5. 비교군 포트폴리오 생성 : 월별 5% OTM 양매도 전략</span></span>
<span id="cb7-1074"><a href="#cb7-1074" aria-hidden="true" tabindex="-1"></a>options2 <span class="ot">&lt;-</span> options <span class="sc">%&gt;%</span> </span>
<span id="cb7-1075"><a href="#cb7-1075" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(PROD<span class="sc">==</span><span class="st">"코스피200"</span>)</span>
<span id="cb7-1076"><a href="#cb7-1076" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-1077"><a href="#cb7-1077" aria-hidden="true" tabindex="-1"></a><span class="co"># 옵션 만기일(매달) 생성</span></span>
<span id="cb7-1078"><a href="#cb7-1078" aria-hidden="true" tabindex="-1"></a>target_date2 <span class="ot">&lt;-</span> options2 <span class="sc">%&gt;%</span> </span>
<span id="cb7-1079"><a href="#cb7-1079" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(.,BAS_DD, PRIOR) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1080"><a href="#cb7-1080" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(PRIOR, <span class="fu">desc</span>(BAS_DD)) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1081"><a href="#cb7-1081" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(PRIOR) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1082"><a href="#cb7-1082" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1083"><a href="#cb7-1083" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb7-1084"><a href="#cb7-1084" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(BAS_DD) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1085"><a href="#cb7-1085" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(BAS_DD)) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1086"><a href="#cb7-1086" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(BAS_DD<span class="sc">&lt;</span><span class="dv">20241231</span>, BAS_DD<span class="sc">&gt;</span><span class="dv">20200101</span>)</span>
<span id="cb7-1087"><a href="#cb7-1087" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-1088"><a href="#cb7-1088" aria-hidden="true" tabindex="-1"></a><span class="co"># 일반 양매도 포트폴리오 기본 정보 생성</span></span>
<span id="cb7-1089"><a href="#cb7-1089" aria-hidden="true" tabindex="-1"></a>target_info2 <span class="ot">&lt;-</span> target_date2 <span class="sc">%&gt;%</span> </span>
<span id="cb7-1090"><a href="#cb7-1090" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(options2, <span class="at">by=</span><span class="st">"BAS_DD"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1091"><a href="#cb7-1091" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(BAS_DD,PRIOR) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1092"><a href="#cb7-1092" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(BAS_DD),PRIOR) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1093"><a href="#cb7-1093" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(BAS_DD) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1094"><a href="#cb7-1094" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 만기가 도래하는 옵션을 제외하고 우선순위가 높은 옵션 선택</span></span>
<span id="cb7-1095"><a href="#cb7-1095" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">2</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1096"><a href="#cb7-1096" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb7-1097"><a href="#cb7-1097" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(BAS_DD)) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1098"><a href="#cb7-1098" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(idx_data, <span class="at">by=</span><span class="st">"BAS_DD"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1099"><a href="#cb7-1099" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(mmf_raw, <span class="at">by=</span><span class="st">"BAS_DD"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1100"><a href="#cb7-1100" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 옵션 보유기간 및 단기금리(MMF) 계산</span></span>
<span id="cb7-1101"><a href="#cb7-1101" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">DIFF_DAY=</span><span class="fu">as.integer</span>(<span class="fu">ymd</span>(<span class="fu">lag</span>(BAS_DD))<span class="sc">-</span><span class="fu">ymd</span>(BAS_DD)),</span>
<span id="cb7-1102"><a href="#cb7-1102" aria-hidden="true" tabindex="-1"></a>         <span class="at">MMF=</span>MMF<span class="sc">*</span><span class="fl">0.01</span>,</span>
<span id="cb7-1103"><a href="#cb7-1103" aria-hidden="true" tabindex="-1"></a>         <span class="at">VOL=</span><span class="fl">0.05</span>) <span class="sc">%&gt;%</span></span>
<span id="cb7-1104"><a href="#cb7-1104" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 변동성에 따른 옵션 행사가격 상단(2.5단위 올림) 및 하단(2.5단위 내림) 계산</span></span>
<span id="cb7-1105"><a href="#cb7-1105" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">TARGET_C_K=</span><span class="fu">ceiling</span>(KOSPI200<span class="sc">*</span>(<span class="dv">1</span><span class="sc">+</span>VOL)<span class="sc">*</span><span class="fl">0.4</span>)<span class="sc">/</span><span class="fl">0.4</span>,</span>
<span id="cb7-1106"><a href="#cb7-1106" aria-hidden="true" tabindex="-1"></a>         <span class="at">TARGET_P_K=</span><span class="fu">floor</span>(KOSPI200<span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span>VOL)<span class="sc">*</span><span class="fl">0.4</span>)<span class="sc">/</span><span class="fl">0.4</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1107"><a href="#cb7-1107" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">DIFF_DAY=</span><span class="fu">if_else</span>(<span class="fu">is.na</span>(DIFF_DAY),<span class="dv">28</span>,DIFF_DAY)) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1108"><a href="#cb7-1108" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(BAS_DD,VOL,DIFF_DAY,MMF,KOSPI200,LAG_VK200,PRIOR,TARGET_C_K,TARGET_P_K)</span>
<span id="cb7-1109"><a href="#cb7-1109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-1110"><a href="#cb7-1110" aria-hidden="true" tabindex="-1"></a><span class="co"># 일반 양매도 포트폴리오 거래대상 옵션</span></span>
<span id="cb7-1111"><a href="#cb7-1111" aria-hidden="true" tabindex="-1"></a>target_options2 <span class="ot">&lt;-</span> target_info2 <span class="sc">%&gt;%</span> </span>
<span id="cb7-1112"><a href="#cb7-1112" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(BAS_DD, PRIOR, TARGET_C_K, TARGET_P_K) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1113"><a href="#cb7-1113" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols=</span><span class="fu">c</span>(<span class="st">"TARGET_C_K"</span>,<span class="st">"TARGET_P_K"</span>),<span class="at">names_to =</span> <span class="st">"GRP"</span>, <span class="at">values_to =</span> <span class="st">"EXER_PRC"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1114"><a href="#cb7-1114" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">RGHT=</span><span class="fu">substr</span>(GRP,<span class="dv">8</span>,<span class="dv">8</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1115"><a href="#cb7-1115" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(options2,<span class="at">by=</span><span class="fu">c</span>(<span class="st">"BAS_DD"</span>,<span class="st">"PRIOR"</span>,<span class="st">"RGHT"</span>,<span class="st">"EXER_PRC"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb7-1116"><a href="#cb7-1116" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(BAS_DD,GRP,PRICE,ACC_TRDVOL) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1117"><a href="#cb7-1117" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> <span class="st">"GRP"</span>, <span class="at">values_from =</span> <span class="fu">c</span>(<span class="st">"PRICE"</span>,<span class="st">"ACC_TRDVOL"</span>))</span>
<span id="cb7-1118"><a href="#cb7-1118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-1119"><a href="#cb7-1119" aria-hidden="true" tabindex="-1"></a><span class="co"># 일반 양매도 포트폴리오 구현</span></span>
<span id="cb7-1120"><a href="#cb7-1120" aria-hidden="true" tabindex="-1"></a>portfolio2 <span class="ot">&lt;-</span> target_info2 <span class="sc">%&gt;%</span> </span>
<span id="cb7-1121"><a href="#cb7-1121" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(target_options2,<span class="at">by=</span><span class="st">"BAS_DD"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1122"><a href="#cb7-1122" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(BAS_DD) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1123"><a href="#cb7-1123" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 원금에 따른 옵션 매도수량 계산</span></span>
<span id="cb7-1124"><a href="#cb7-1124" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">SELL_AMT=</span>cash<span class="sc">/</span><span class="dv">250000</span><span class="sc">/</span>KOSPI200) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1125"><a href="#cb7-1125" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 옵션 프리미엄(매도수익)) 계산</span></span>
<span id="cb7-1126"><a href="#cb7-1126" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">PREMIUM=</span>SELL_AMT<span class="sc">*</span>(PRICE_TARGET_C_K<span class="sc">+</span>PRICE_TARGET_P_K)<span class="sc">*</span><span class="dv">250000</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1127"><a href="#cb7-1127" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 원금 및 프리미엄의 MMF 이자수익 및 권리행사손실 계산</span></span>
<span id="cb7-1128"><a href="#cb7-1128" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">INTEREST=</span>(cash<span class="sc">+</span><span class="fu">replace_na</span>(PREMIUM,<span class="dv">0</span>))<span class="sc">*</span>MMF<span class="sc">*</span>DIFF_DAY<span class="sc">/</span><span class="dv">365</span>,</span>
<span id="cb7-1129"><a href="#cb7-1129" aria-hidden="true" tabindex="-1"></a>         <span class="at">EXERCISE=</span>(<span class="fu">if_else</span>(<span class="fu">lead</span>(KOSPI200)<span class="sc">-</span>TARGET_C_K<span class="sc">&gt;</span><span class="dv">0</span>,<span class="fu">lead</span>(KOSPI200)<span class="sc">-</span>TARGET_C_K,<span class="dv">0</span>)<span class="sc">+</span></span>
<span id="cb7-1130"><a href="#cb7-1130" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">if_else</span>(TARGET_P_K<span class="sc">-</span><span class="fu">lead</span>(KOSPI200)<span class="sc">&gt;</span><span class="dv">0</span>,TARGET_P_K<span class="sc">-</span><span class="fu">lead</span>(KOSPI200),<span class="dv">0</span>))<span class="sc">*</span><span class="dv">250000</span><span class="sc">*</span>SELL_AMT) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1131"><a href="#cb7-1131" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">EXERCISE=</span><span class="fu">if_else</span>(<span class="fu">is.na</span>(EXERCISE),<span class="dv">0</span>,EXERCISE)) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1132"><a href="#cb7-1132" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 주단위 포트폴리오 손익 계산(원금 100억 가정, 당일 투자시 다음주 실현손익을 의미)</span></span>
<span id="cb7-1133"><a href="#cb7-1133" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">REVENUE=</span>PREMIUM<span class="sc">+</span>INTEREST<span class="sc">-</span>EXERCISE) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1134"><a href="#cb7-1134" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 거래대상 옵션이 상장되어있지 않은 경우, MMF수익만 고려</span></span>
<span id="cb7-1135"><a href="#cb7-1135" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">REVENUE=</span><span class="fu">if_else</span>(<span class="fu">is.na</span>(REVENUE),INTEREST,REVENUE)) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1136"><a href="#cb7-1136" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">RATE=</span>REVENUE<span class="sc">/</span>cash) <span class="co"># 주단위 포트폴리오 수익률</span></span>
<span id="cb7-1137"><a href="#cb7-1137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-1138"><a href="#cb7-1138" aria-hidden="true" tabindex="-1"></a><span class="co"># 6. 성과분석 : VW양매도 포트폴리오</span></span>
<span id="cb7-1139"><a href="#cb7-1139" aria-hidden="true" tabindex="-1"></a>performance <span class="ot">&lt;-</span> portfolio <span class="sc">%&gt;%</span></span>
<span id="cb7-1140"><a href="#cb7-1140" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>(PREMIUM, EXERCISE) <span class="sc">%&gt;%</span></span>
<span id="cb7-1141"><a href="#cb7-1141" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">YEAR =</span> <span class="fu">substr</span>(BAS_DD, <span class="dv">1</span>, <span class="dv">4</span>),</span>
<span id="cb7-1142"><a href="#cb7-1142" aria-hidden="true" tabindex="-1"></a>         <span class="at">YM =</span> <span class="fu">ym</span>(<span class="fu">substr</span>(BAS_DD, <span class="dv">1</span>, <span class="dv">6</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb7-1143"><a href="#cb7-1143" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(YEAR, YM) <span class="sc">%&gt;%</span></span>
<span id="cb7-1144"><a href="#cb7-1144" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">PREMIUM =</span> <span class="fu">sum</span>(PREMIUM),</span>
<span id="cb7-1145"><a href="#cb7-1145" aria-hidden="true" tabindex="-1"></a>            <span class="at">INTEREST =</span> <span class="fu">sum</span>(INTEREST),</span>
<span id="cb7-1146"><a href="#cb7-1146" aria-hidden="true" tabindex="-1"></a>            <span class="at">EXERCISE =</span> <span class="fu">sum</span>(EXERCISE),</span>
<span id="cb7-1147"><a href="#cb7-1147" aria-hidden="true" tabindex="-1"></a>            <span class="at">REVENUE =</span> <span class="fu">sum</span>(REVENUE),</span>
<span id="cb7-1148"><a href="#cb7-1148" aria-hidden="true" tabindex="-1"></a>            <span class="at">RATE =</span> <span class="fu">prod</span>(<span class="dv">1</span> <span class="sc">+</span> RATE),</span>
<span id="cb7-1149"><a href="#cb7-1149" aria-hidden="true" tabindex="-1"></a>            <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb7-1150"><a href="#cb7-1150" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb7-1151"><a href="#cb7-1151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-1152"><a href="#cb7-1152" aria-hidden="true" tabindex="-1"></a><span class="co"># 6. 성과분석 : 일반 양매도 포트폴리오</span></span>
<span id="cb7-1153"><a href="#cb7-1153" aria-hidden="true" tabindex="-1"></a>performance2 <span class="ot">&lt;-</span> portfolio2 <span class="sc">%&gt;%</span></span>
<span id="cb7-1154"><a href="#cb7-1154" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>(PREMIUM, EXERCISE) <span class="sc">%&gt;%</span></span>
<span id="cb7-1155"><a href="#cb7-1155" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">YEAR =</span> <span class="fu">substr</span>(BAS_DD, <span class="dv">1</span>, <span class="dv">4</span>),</span>
<span id="cb7-1156"><a href="#cb7-1156" aria-hidden="true" tabindex="-1"></a>         <span class="at">YM =</span> <span class="fu">ym</span>(<span class="fu">substr</span>(BAS_DD, <span class="dv">1</span>, <span class="dv">6</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb7-1157"><a href="#cb7-1157" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(YEAR, YM) <span class="sc">%&gt;%</span></span>
<span id="cb7-1158"><a href="#cb7-1158" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">PREMIUM =</span> <span class="fu">sum</span>(PREMIUM),</span>
<span id="cb7-1159"><a href="#cb7-1159" aria-hidden="true" tabindex="-1"></a>            <span class="at">INTEREST =</span> <span class="fu">sum</span>(INTEREST),</span>
<span id="cb7-1160"><a href="#cb7-1160" aria-hidden="true" tabindex="-1"></a>            <span class="at">EXERCISE =</span> <span class="fu">sum</span>(EXERCISE),</span>
<span id="cb7-1161"><a href="#cb7-1161" aria-hidden="true" tabindex="-1"></a>            <span class="at">REVENUE =</span> <span class="fu">sum</span>(REVENUE),</span>
<span id="cb7-1162"><a href="#cb7-1162" aria-hidden="true" tabindex="-1"></a>            <span class="at">RATE =</span> <span class="fu">prod</span>(<span class="dv">1</span> <span class="sc">+</span> RATE),</span>
<span id="cb7-1163"><a href="#cb7-1163" aria-hidden="true" tabindex="-1"></a>            <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb7-1164"><a href="#cb7-1164" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb7-1165"><a href="#cb7-1165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-1166"><a href="#cb7-1166" aria-hidden="true" tabindex="-1"></a><span class="co"># 시각화 등</span></span>
<span id="cb7-1167"><a href="#cb7-1167" aria-hidden="true" tabindex="-1"></a>graph1_1 <span class="ot">&lt;-</span> performance <span class="sc">%&gt;%</span></span>
<span id="cb7-1168"><a href="#cb7-1168" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(YM) <span class="sc">%&gt;%</span></span>
<span id="cb7-1169"><a href="#cb7-1169" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(K200_portfolio,<span class="at">by=</span><span class="fu">c</span>(<span class="st">"YEAR"</span>,<span class="st">"YM"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1170"><a href="#cb7-1170" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">CUM_RATE =</span> <span class="fu">cumprod</span>(RATE) <span class="sc">*</span> <span class="dv">100</span> <span class="sc">-</span> <span class="dv">100</span>,</span>
<span id="cb7-1171"><a href="#cb7-1171" aria-hidden="true" tabindex="-1"></a>         <span class="at">CUM_RATE_K200 =</span> <span class="fu">cumprod</span>(RATE_K200) <span class="sc">*</span> <span class="dv">100</span> <span class="sc">-</span> <span class="dv">100</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1172"><a href="#cb7-1172" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(<span class="fu">tibble</span>(<span class="at">YM=</span><span class="fu">ym</span>(<span class="dv">201912</span>),<span class="at">CUM_RATE=</span><span class="dv">0</span>,<span class="at">CUM_RATE_K200=</span><span class="dv">0</span>))</span>
<span id="cb7-1173"><a href="#cb7-1173" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-1174"><a href="#cb7-1174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-1175"><a href="#cb7-1175" aria-hidden="true" tabindex="-1"></a>graph1_2 <span class="ot">&lt;-</span> performance2 <span class="sc">%&gt;%</span></span>
<span id="cb7-1176"><a href="#cb7-1176" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(YM) <span class="sc">%&gt;%</span></span>
<span id="cb7-1177"><a href="#cb7-1177" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(K200_portfolio,<span class="at">by=</span><span class="fu">c</span>(<span class="st">"YEAR"</span>,<span class="st">"YM"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1178"><a href="#cb7-1178" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">CUM_RATE =</span> <span class="fu">cumprod</span>(RATE) <span class="sc">*</span> <span class="dv">100</span> <span class="sc">-</span> <span class="dv">100</span>,</span>
<span id="cb7-1179"><a href="#cb7-1179" aria-hidden="true" tabindex="-1"></a>         <span class="at">CUM_RATE_K200 =</span> <span class="fu">cumprod</span>(RATE_K200) <span class="sc">*</span> <span class="dv">100</span> <span class="sc">-</span> <span class="dv">100</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1180"><a href="#cb7-1180" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(<span class="fu">tibble</span>(<span class="at">YM=</span><span class="fu">ym</span>(<span class="dv">201912</span>),<span class="at">CUM_RATE=</span><span class="dv">0</span>,<span class="at">CUM_RATE_K200=</span><span class="dv">0</span>))</span>
<span id="cb7-1181"><a href="#cb7-1181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-1182"><a href="#cb7-1182" aria-hidden="true" tabindex="-1"></a>graph1_3 <span class="ot">&lt;-</span> graph1_1 <span class="sc">%&gt;%</span></span>
<span id="cb7-1183"><a href="#cb7-1183" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(graph1_2, <span class="at">by =</span> <span class="st">"YM"</span>, <span class="at">suffix =</span> <span class="fu">c</span>(<span class="st">"_1"</span>, <span class="st">"_2"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb7-1184"><a href="#cb7-1184" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">REVENUE_DIFF =</span> (REVENUE_1 <span class="sc">-</span> REVENUE_2) <span class="sc">/</span> <span class="fl">1e8</span>)</span>
<span id="cb7-1185"><a href="#cb7-1185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-1186"><a href="#cb7-1186" aria-hidden="true" tabindex="-1"></a>graph2_1 <span class="ot">&lt;-</span> performance <span class="sc">%&gt;%</span></span>
<span id="cb7-1187"><a href="#cb7-1187" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(YM) <span class="sc">%&gt;%</span></span>
<span id="cb7-1188"><a href="#cb7-1188" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(K200_portfolio,<span class="at">by=</span><span class="fu">c</span>(<span class="st">"YEAR"</span>,<span class="st">"YM"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1189"><a href="#cb7-1189" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">as.integer</span>(YEAR) <span class="sc">&gt;</span> <span class="dv">2021</span>) <span class="sc">%&gt;%</span></span>
<span id="cb7-1190"><a href="#cb7-1190" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">CUM_RATE =</span> <span class="fu">cumprod</span>(RATE) <span class="sc">*</span> <span class="dv">100</span> <span class="sc">-</span> <span class="dv">100</span>,</span>
<span id="cb7-1191"><a href="#cb7-1191" aria-hidden="true" tabindex="-1"></a>         <span class="at">CUM_RATE_K200 =</span> <span class="fu">cumprod</span>(RATE_K200) <span class="sc">*</span> <span class="dv">100</span> <span class="sc">-</span> <span class="dv">100</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1192"><a href="#cb7-1192" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(<span class="fu">tibble</span>(<span class="at">YM=</span><span class="fu">ym</span>(<span class="dv">202112</span>),<span class="at">CUM_RATE=</span><span class="dv">0</span>,<span class="at">CUM_RATE_K200=</span><span class="dv">0</span>))</span>
<span id="cb7-1193"><a href="#cb7-1193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-1194"><a href="#cb7-1194" aria-hidden="true" tabindex="-1"></a>graph2_2 <span class="ot">&lt;-</span> performance2 <span class="sc">%&gt;%</span></span>
<span id="cb7-1195"><a href="#cb7-1195" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(YM) <span class="sc">%&gt;%</span></span>
<span id="cb7-1196"><a href="#cb7-1196" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(K200_portfolio,<span class="at">by=</span><span class="fu">c</span>(<span class="st">"YEAR"</span>,<span class="st">"YM"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1197"><a href="#cb7-1197" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">as.integer</span>(YEAR) <span class="sc">&gt;</span> <span class="dv">2021</span>) <span class="sc">%&gt;%</span></span>
<span id="cb7-1198"><a href="#cb7-1198" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">CUM_RATE =</span> <span class="fu">cumprod</span>(RATE) <span class="sc">*</span> <span class="dv">100</span> <span class="sc">-</span> <span class="dv">100</span>,</span>
<span id="cb7-1199"><a href="#cb7-1199" aria-hidden="true" tabindex="-1"></a>         <span class="at">CUM_RATE_K200 =</span> <span class="fu">cumprod</span>(RATE_K200) <span class="sc">*</span> <span class="dv">100</span> <span class="sc">-</span> <span class="dv">100</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1200"><a href="#cb7-1200" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(<span class="fu">tibble</span>(<span class="at">YM=</span><span class="fu">ym</span>(<span class="dv">202112</span>),<span class="at">CUM_RATE=</span><span class="dv">0</span>,<span class="at">CUM_RATE_K200=</span><span class="dv">0</span>))</span>
<span id="cb7-1201"><a href="#cb7-1201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-1202"><a href="#cb7-1202" aria-hidden="true" tabindex="-1"></a>graph2_3 <span class="ot">&lt;-</span> graph2_1 <span class="sc">%&gt;%</span></span>
<span id="cb7-1203"><a href="#cb7-1203" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(graph2_2, <span class="at">by =</span> <span class="st">"YM"</span>, <span class="at">suffix =</span> <span class="fu">c</span>(<span class="st">"_1"</span>, <span class="st">"_2"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb7-1204"><a href="#cb7-1204" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">REVENUE_DIFF =</span> (REVENUE_1 <span class="sc">-</span> REVENUE_2) <span class="sc">/</span> <span class="fl">1e8</span>)</span>
<span id="cb7-1205"><a href="#cb7-1205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-1206"><a href="#cb7-1206" aria-hidden="true" tabindex="-1"></a>graph3_1 <span class="ot">&lt;-</span> portfolio <span class="sc">%&gt;%</span></span>
<span id="cb7-1207"><a href="#cb7-1207" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">YM =</span> <span class="fu">ym</span>(<span class="fu">substr</span>(BAS_DD, <span class="dv">1</span>, <span class="dv">6</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb7-1208"><a href="#cb7-1208" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(YM) <span class="sc">%&gt;%</span></span>
<span id="cb7-1209"><a href="#cb7-1209" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">TargetVol=</span><span class="fu">mean</span>(VOL),</span>
<span id="cb7-1210"><a href="#cb7-1210" aria-hidden="true" tabindex="-1"></a>            <span class="at">Kospi200=</span><span class="fu">mean</span>(KOSPI200)) <span class="sc">%&gt;%</span> <span class="fu">ungroup</span>()</span>
<span id="cb7-1211"><a href="#cb7-1211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-1212"><a href="#cb7-1212" aria-hidden="true" tabindex="-1"></a>graph1<span class="ot">=</span><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb7-1213"><a href="#cb7-1213" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> graph1_1, <span class="fu">aes</span>(<span class="at">x =</span> YM, <span class="at">y =</span> CUM_RATE, <span class="at">color =</span> <span class="st">"Vol-adj. Weekly"</span>), <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb7-1214"><a href="#cb7-1214" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> graph1_1, <span class="fu">aes</span>(<span class="at">x =</span> YM, <span class="at">y =</span> CUM_RATE, <span class="at">color =</span> <span class="st">"Vol-adj. Weekly"</span>), <span class="at">shape =</span> <span class="dv">16</span>, <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb7-1215"><a href="#cb7-1215" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> graph1_2, <span class="fu">aes</span>(<span class="at">x =</span> YM, <span class="at">y =</span> CUM_RATE, <span class="at">color =</span> <span class="st">"5% OTM Monthly"</span>), <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb7-1216"><a href="#cb7-1216" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> graph1_2, <span class="fu">aes</span>(<span class="at">x =</span> YM, <span class="at">y =</span> CUM_RATE, <span class="at">color =</span> <span class="st">"5% OTM Monthly"</span>), <span class="at">shape =</span> <span class="dv">16</span>, <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb7-1217"><a href="#cb7-1217" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> graph1_1, <span class="fu">aes</span>(<span class="at">x =</span> YM, <span class="at">y =</span> CUM_RATE_K200, <span class="at">color =</span> <span class="st">"Kospi 200"</span>), <span class="at">size =</span> <span class="dv">1</span>, <span class="at">alpha=</span><span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb7-1218"><a href="#cb7-1218" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> graph1_1, <span class="fu">aes</span>(<span class="at">x =</span> YM, <span class="at">y =</span> CUM_RATE_K200, <span class="at">color =</span> <span class="st">"Kospi 200"</span>), <span class="at">shape =</span> <span class="dv">16</span>, <span class="at">size =</span> <span class="dv">2</span>,<span class="at">alpha=</span><span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb7-1219"><a href="#cb7-1219" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">data =</span> graph1_3, <span class="fu">aes</span>(<span class="at">x =</span> YM, <span class="at">y =</span> REVENUE_DIFF <span class="sc">*</span> <span class="dv">3</span>),</span>
<span id="cb7-1220"><a href="#cb7-1220" aria-hidden="true" tabindex="-1"></a>           <span class="at">stat =</span> <span class="st">"identity"</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>, <span class="at">fill =</span> <span class="st">"gray"</span>) <span class="sc">+</span></span>
<span id="cb7-1221"><a href="#cb7-1221" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_date</span>(<span class="at">date_breaks =</span> <span class="st">"1 year"</span>, <span class="at">date_labels =</span> <span class="st">"%Y"</span>) <span class="sc">+</span></span>
<span id="cb7-1222"><a href="#cb7-1222" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">30</span>, <span class="dv">50</span>), <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="dv">30</span>, <span class="dv">50</span>, <span class="dv">10</span>), <span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">number_format</span>(<span class="at">accuracy =</span> <span class="fl">0.1</span>),</span>
<span id="cb7-1223"><a href="#cb7-1223" aria-hidden="true" tabindex="-1"></a>                     <span class="at">sec.axis =</span> <span class="fu">sec_axis</span>(<span class="sc">~</span> . <span class="sc">/</span> <span class="dv">3</span>, <span class="at">name =</span> <span class="st">"Overperform (100M)"</span>, <span class="at">breaks =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">10</span>, <span class="sc">-</span><span class="dv">5</span>, <span class="dv">0</span>, <span class="dv">5</span>, <span class="dv">10</span>), <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"-10"</span>, <span class="st">"-5"</span>, <span class="st">"0"</span>, <span class="st">"5"</span>, <span class="st">"10"</span>))) <span class="sc">+</span></span>
<span id="cb7-1224"><a href="#cb7-1224" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Vol-adj. Weekly"</span> <span class="ot">=</span> <span class="st">"red"</span>, <span class="st">"5% OTM Monthly"</span> <span class="ot">=</span> <span class="st">"blue"</span>, <span class="st">"Kospi 200"</span> <span class="ot">=</span> <span class="st">"Green"</span>)) <span class="sc">+</span></span>
<span id="cb7-1225"><a href="#cb7-1225" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="cn">NULL</span>, <span class="at">y =</span> <span class="st">"Cumulative Return (%)"</span>, <span class="at">color =</span> <span class="st">""</span>) <span class="sc">+</span></span>
<span id="cb7-1226"><a href="#cb7-1226" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb7-1227"><a href="#cb7-1227" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="fu">c</span>(<span class="fl">0.4</span>, <span class="fl">0.93</span>), <span class="at">legend.direction =</span> <span class="st">"horizontal"</span>)</span>
<span id="cb7-1228"><a href="#cb7-1228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-1229"><a href="#cb7-1229" aria-hidden="true" tabindex="-1"></a>graph2<span class="ot">=</span><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb7-1230"><a href="#cb7-1230" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> graph2_1, <span class="fu">aes</span>(<span class="at">x =</span> YM, <span class="at">y =</span> CUM_RATE, <span class="at">color =</span> <span class="st">"Vol-adj. Weekly"</span>), <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb7-1231"><a href="#cb7-1231" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> graph2_1, <span class="fu">aes</span>(<span class="at">x =</span> YM, <span class="at">y =</span> CUM_RATE, <span class="at">color =</span> <span class="st">"Vol-adj. Weekly"</span>), <span class="at">shape =</span> <span class="dv">16</span>, <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb7-1232"><a href="#cb7-1232" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> graph2_2, <span class="fu">aes</span>(<span class="at">x =</span> YM, <span class="at">y =</span> CUM_RATE, <span class="at">color =</span> <span class="st">"5% OTM Monthly"</span>), <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb7-1233"><a href="#cb7-1233" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> graph2_2, <span class="fu">aes</span>(<span class="at">x =</span> YM, <span class="at">y =</span> CUM_RATE, <span class="at">color =</span> <span class="st">"5% OTM Monthly"</span>), <span class="at">shape =</span> <span class="dv">16</span>, <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb7-1234"><a href="#cb7-1234" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> graph2_1, <span class="fu">aes</span>(<span class="at">x =</span> YM, <span class="at">y =</span> CUM_RATE_K200, <span class="at">color =</span> <span class="st">"Kospi 200"</span>), <span class="at">size =</span> <span class="dv">1</span>, <span class="at">alpha=</span><span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb7-1235"><a href="#cb7-1235" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> graph2_1, <span class="fu">aes</span>(<span class="at">x =</span> YM, <span class="at">y =</span> CUM_RATE_K200, <span class="at">color =</span> <span class="st">"Kospi 200"</span>), <span class="at">shape =</span> <span class="dv">16</span>, <span class="at">size =</span> <span class="dv">2</span>,<span class="at">alpha=</span><span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb7-1236"><a href="#cb7-1236" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">data =</span> graph2_3, <span class="fu">aes</span>(<span class="at">x =</span> YM, <span class="at">y =</span> REVENUE_DIFF <span class="sc">*</span> <span class="dv">3</span>),</span>
<span id="cb7-1237"><a href="#cb7-1237" aria-hidden="true" tabindex="-1"></a>           <span class="at">stat =</span> <span class="st">"identity"</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>, <span class="at">fill =</span> <span class="st">"gray"</span>) <span class="sc">+</span></span>
<span id="cb7-1238"><a href="#cb7-1238" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_date</span>(<span class="at">date_breaks =</span> <span class="st">"1 year"</span>, <span class="at">date_labels =</span> <span class="st">"%Y"</span>) <span class="sc">+</span></span>
<span id="cb7-1239"><a href="#cb7-1239" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">30</span>, <span class="dv">20</span>), <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="dv">30</span>, <span class="dv">30</span>, <span class="dv">10</span>), <span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">number_format</span>(<span class="at">accuracy =</span> <span class="fl">0.1</span>),</span>
<span id="cb7-1240"><a href="#cb7-1240" aria-hidden="true" tabindex="-1"></a>                     <span class="at">sec.axis =</span> <span class="fu">sec_axis</span>(<span class="sc">~</span> . <span class="sc">/</span> <span class="dv">3</span>, <span class="at">name =</span> <span class="st">"Overperform (100M)"</span>, <span class="at">breaks =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">10</span>, <span class="sc">-</span><span class="dv">5</span>, <span class="dv">0</span>, <span class="dv">5</span>, <span class="dv">10</span>), <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"-10"</span>, <span class="st">"-5"</span>, <span class="st">"0"</span>, <span class="st">"5"</span>, <span class="st">"10"</span>))) <span class="sc">+</span></span>
<span id="cb7-1241"><a href="#cb7-1241" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Vol-adj. Weekly"</span> <span class="ot">=</span> <span class="st">"red"</span>, <span class="st">"5% OTM Monthly"</span> <span class="ot">=</span> <span class="st">"blue"</span>, <span class="st">"Kospi 200"</span> <span class="ot">=</span> <span class="st">"Green"</span>)) <span class="sc">+</span></span>
<span id="cb7-1242"><a href="#cb7-1242" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="cn">NULL</span>, <span class="at">y =</span> <span class="st">"Cumulative Return (%)"</span>, <span class="at">color =</span> <span class="st">""</span>) <span class="sc">+</span></span>
<span id="cb7-1243"><a href="#cb7-1243" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb7-1244"><a href="#cb7-1244" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="fu">c</span>(<span class="fl">0.4</span>, <span class="fl">0.93</span>), <span class="at">legend.direction =</span> <span class="st">"horizontal"</span>)</span>
<span id="cb7-1245"><a href="#cb7-1245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-1246"><a href="#cb7-1246" aria-hidden="true" tabindex="-1"></a>graph3<span class="ot">=</span><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb7-1247"><a href="#cb7-1247" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> graph3_1, <span class="fu">aes</span>(<span class="at">x =</span> YM, <span class="at">y =</span> Kospi200, <span class="at">color =</span> <span class="st">"Kospi 200"</span>), <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb7-1248"><a href="#cb7-1248" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> graph3_1, <span class="fu">aes</span>(<span class="at">x =</span> YM, <span class="at">y =</span> Kospi200, <span class="at">color =</span> <span class="st">"Kospi 200"</span>), <span class="at">shape =</span> <span class="dv">16</span>, <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb7-1249"><a href="#cb7-1249" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">data =</span> graph3_1, <span class="fu">aes</span>(<span class="at">x =</span> YM, <span class="at">y =</span> TargetVol <span class="sc">*</span> <span class="dv">7000</span>),</span>
<span id="cb7-1250"><a href="#cb7-1250" aria-hidden="true" tabindex="-1"></a>           <span class="at">stat =</span> <span class="st">"identity"</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>, <span class="at">fill =</span> <span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb7-1251"><a href="#cb7-1251" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">200</span>, <span class="at">size=</span><span class="fl">0.5</span>, <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">alpha=</span><span class="fl">0.5</span>)<span class="sc">+</span></span>
<span id="cb7-1252"><a href="#cb7-1252" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_date</span>(<span class="at">date_breaks =</span> <span class="st">"1 year"</span>, <span class="at">date_labels =</span> <span class="st">"%Y"</span>) <span class="sc">+</span></span>
<span id="cb7-1253"><a href="#cb7-1253" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">500</span>), <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">100</span>, <span class="dv">500</span>, <span class="dv">100</span>),</span>
<span id="cb7-1254"><a href="#cb7-1254" aria-hidden="true" tabindex="-1"></a>                     <span class="at">sec.axis =</span> <span class="fu">sec_axis</span>(<span class="sc">~</span> . <span class="sc">/</span> <span class="dv">7000</span>, <span class="at">name =</span> <span class="st">"Strike Range(Monthly)"</span>, <span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.025</span>,<span class="fl">0.05</span>,<span class="fl">0.075</span>, <span class="fl">0.1</span>), <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"0"</span>,<span class="st">"5%"</span>, <span class="st">"10%"</span>,<span class="st">"15%"</span>, <span class="st">"20%"</span>))) <span class="sc">+</span></span>
<span id="cb7-1255"><a href="#cb7-1255" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Kospi 200"</span> <span class="ot">=</span> <span class="st">"red"</span>)) <span class="sc">+</span></span>
<span id="cb7-1256"><a href="#cb7-1256" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="cn">NULL</span>, <span class="at">y =</span> <span class="st">"Kospi 200"</span>, <span class="at">color =</span> <span class="st">""</span>) <span class="sc">+</span></span>
<span id="cb7-1257"><a href="#cb7-1257" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb7-1258"><a href="#cb7-1258" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="fu">c</span>(<span class="fl">0.1</span>, <span class="fl">0.93</span>), <span class="at">legend.direction =</span> <span class="st">"horizontal"</span>)</span>
<span id="cb7-1259"><a href="#cb7-1259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-1260"><a href="#cb7-1260" aria-hidden="true" tabindex="-1"></a><span class="co"># 요약표 1 : VW포트폴리오</span></span>
<span id="cb7-1261"><a href="#cb7-1261" aria-hidden="true" tabindex="-1"></a>table1 <span class="ot">&lt;-</span> portfolio <span class="sc">%&gt;%</span></span>
<span id="cb7-1262"><a href="#cb7-1262" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>(PREMIUM, EXERCISE) <span class="sc">%&gt;%</span></span>
<span id="cb7-1263"><a href="#cb7-1263" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">YEAR =</span> <span class="fu">substr</span>(BAS_DD, <span class="dv">1</span>, <span class="dv">4</span>),</span>
<span id="cb7-1264"><a href="#cb7-1264" aria-hidden="true" tabindex="-1"></a>         <span class="at">CNT=</span><span class="dv">1</span>,</span>
<span id="cb7-1265"><a href="#cb7-1265" aria-hidden="true" tabindex="-1"></a>         <span class="at">NO=</span><span class="fu">if_else</span>(EXERCISE<span class="sc">==</span><span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">0</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb7-1266"><a href="#cb7-1266" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(YEAR) <span class="sc">%&gt;%</span></span>
<span id="cb7-1267"><a href="#cb7-1267" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">Expiry =</span> <span class="fu">sum</span>(CNT),</span>
<span id="cb7-1268"><a href="#cb7-1268" aria-hidden="true" tabindex="-1"></a>            <span class="at">NoExercise =</span> <span class="fu">round</span>(<span class="fu">sum</span>(NO)<span class="sc">/</span><span class="fu">sum</span>(CNT),<span class="dv">2</span>),</span>
<span id="cb7-1269"><a href="#cb7-1269" aria-hidden="true" tabindex="-1"></a>            <span class="at">Premium =</span> <span class="fu">round</span>(<span class="fu">mean</span>(PREMIUM)<span class="sc">/</span><span class="dv">10000</span>,<span class="dv">0</span>),</span>
<span id="cb7-1270"><a href="#cb7-1270" aria-hidden="true" tabindex="-1"></a>            <span class="at">Interest =</span> <span class="fu">round</span>(<span class="fu">mean</span>(INTEREST)<span class="sc">/</span><span class="dv">10000</span>,<span class="dv">0</span>),</span>
<span id="cb7-1271"><a href="#cb7-1271" aria-hidden="true" tabindex="-1"></a>            <span class="at">Loss =</span> <span class="fu">round</span>(<span class="fu">mean</span>(EXERCISE)<span class="sc">/</span><span class="dv">10000</span>,<span class="dv">0</span>),</span>
<span id="cb7-1272"><a href="#cb7-1272" aria-hidden="true" tabindex="-1"></a>            <span class="at">Revenue =</span> <span class="fu">round</span>(<span class="fu">mean</span>(REVENUE)<span class="sc">/</span><span class="dv">10000</span>,<span class="dv">0</span>),</span>
<span id="cb7-1273"><a href="#cb7-1273" aria-hidden="true" tabindex="-1"></a>            <span class="at">Return =</span> <span class="fu">round</span>(<span class="fu">prod</span>(<span class="dv">1</span> <span class="sc">+</span> RATE)<span class="sc">-</span><span class="dv">1</span>,<span class="dv">2</span>),</span>
<span id="cb7-1274"><a href="#cb7-1274" aria-hidden="true" tabindex="-1"></a>            <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1275"><a href="#cb7-1275" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(K200_portfolio <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(YEAR) <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="at">Return_K200=</span><span class="fu">round</span>(<span class="fu">prod</span>(RATE_K200)<span class="sc">-</span><span class="dv">1</span>,<span class="dv">2</span>)),</span>
<span id="cb7-1276"><a href="#cb7-1276" aria-hidden="true" tabindex="-1"></a>            <span class="at">by=</span><span class="st">"YEAR"</span>)</span>
<span id="cb7-1277"><a href="#cb7-1277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-1278"><a href="#cb7-1278" aria-hidden="true" tabindex="-1"></a><span class="co"># 요약표 2 : 일반 포트폴리오</span></span>
<span id="cb7-1279"><a href="#cb7-1279" aria-hidden="true" tabindex="-1"></a>table2 <span class="ot">&lt;-</span> portfolio2 <span class="sc">%&gt;%</span></span>
<span id="cb7-1280"><a href="#cb7-1280" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>(PREMIUM, EXERCISE) <span class="sc">%&gt;%</span></span>
<span id="cb7-1281"><a href="#cb7-1281" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">YEAR =</span> <span class="fu">substr</span>(BAS_DD, <span class="dv">1</span>, <span class="dv">4</span>),</span>
<span id="cb7-1282"><a href="#cb7-1282" aria-hidden="true" tabindex="-1"></a>         <span class="at">CNT=</span><span class="dv">1</span>,</span>
<span id="cb7-1283"><a href="#cb7-1283" aria-hidden="true" tabindex="-1"></a>         <span class="at">NO=</span><span class="fu">if_else</span>(EXERCISE<span class="sc">==</span><span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">0</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb7-1284"><a href="#cb7-1284" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(YEAR) <span class="sc">%&gt;%</span></span>
<span id="cb7-1285"><a href="#cb7-1285" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">Expiry =</span> <span class="fu">sum</span>(CNT),</span>
<span id="cb7-1286"><a href="#cb7-1286" aria-hidden="true" tabindex="-1"></a>            <span class="at">NoExercise =</span> <span class="fu">round</span>(<span class="fu">sum</span>(NO)<span class="sc">/</span><span class="fu">sum</span>(CNT),<span class="dv">2</span>),</span>
<span id="cb7-1287"><a href="#cb7-1287" aria-hidden="true" tabindex="-1"></a>            <span class="at">Premium =</span> <span class="fu">round</span>(<span class="fu">mean</span>(PREMIUM)<span class="sc">/</span><span class="dv">10000</span>,<span class="dv">0</span>),</span>
<span id="cb7-1288"><a href="#cb7-1288" aria-hidden="true" tabindex="-1"></a>            <span class="at">Interest =</span> <span class="fu">round</span>(<span class="fu">mean</span>(INTEREST)<span class="sc">/</span><span class="dv">10000</span>,<span class="dv">0</span>),</span>
<span id="cb7-1289"><a href="#cb7-1289" aria-hidden="true" tabindex="-1"></a>            <span class="at">Loss =</span> <span class="fu">round</span>(<span class="fu">mean</span>(EXERCISE)<span class="sc">/</span><span class="dv">10000</span>,<span class="dv">0</span>),</span>
<span id="cb7-1290"><a href="#cb7-1290" aria-hidden="true" tabindex="-1"></a>            <span class="at">Revenue =</span> <span class="fu">round</span>(<span class="fu">mean</span>(REVENUE)<span class="sc">/</span><span class="dv">10000</span>,<span class="dv">0</span>),</span>
<span id="cb7-1291"><a href="#cb7-1291" aria-hidden="true" tabindex="-1"></a>            <span class="at">Return =</span> <span class="fu">round</span>(<span class="fu">prod</span>(<span class="dv">1</span> <span class="sc">+</span> RATE)<span class="sc">-</span><span class="dv">1</span>,<span class="dv">2</span>),</span>
<span id="cb7-1292"><a href="#cb7-1292" aria-hidden="true" tabindex="-1"></a>            <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1293"><a href="#cb7-1293" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(K200_portfolio <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(YEAR) <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="at">Return_K200=</span><span class="fu">round</span>(<span class="fu">prod</span>(RATE_K200)<span class="sc">-</span><span class="dv">1</span>,<span class="dv">2</span>)),</span>
<span id="cb7-1294"><a href="#cb7-1294" aria-hidden="true" tabindex="-1"></a>            <span class="at">by=</span><span class="st">"YEAR"</span>)</span>
<span id="cb7-1295"><a href="#cb7-1295" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-1296"><a href="#cb7-1296" aria-hidden="true" tabindex="-1"></a><span class="co"># 요약표 3 : 포트폴리오 변동성 비교</span></span>
<span id="cb7-1297"><a href="#cb7-1297" aria-hidden="true" tabindex="-1"></a>Vol1 <span class="ot">&lt;-</span> graph1_1 <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(YEAR) <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="at">Vol=</span><span class="fu">round</span>(<span class="fu">sd</span>(RATE)<span class="sc">*</span><span class="fu">sqrt</span>(<span class="dv">12</span>),<span class="dv">2</span>),</span>
<span id="cb7-1298"><a href="#cb7-1298" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">Vol_K200=</span><span class="fu">round</span>(<span class="fu">sd</span>(RATE_K200)<span class="sc">*</span><span class="fu">sqrt</span>(<span class="dv">12</span>),<span class="dv">2</span>))</span>
<span id="cb7-1299"><a href="#cb7-1299" aria-hidden="true" tabindex="-1"></a>Vol2 <span class="ot">&lt;-</span> graph1_2 <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(YEAR) <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="at">Vol=</span><span class="fu">round</span>(<span class="fu">sd</span>(RATE)<span class="sc">*</span><span class="fu">sqrt</span>(<span class="dv">12</span>),<span class="dv">2</span>))</span>
<span id="cb7-1300"><a href="#cb7-1300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-1301"><a href="#cb7-1301" aria-hidden="true" tabindex="-1"></a>table3 <span class="ot">&lt;-</span> table1 <span class="sc">%&gt;%</span> </span>
<span id="cb7-1302"><a href="#cb7-1302" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(YEAR,Return,Return_K200) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1303"><a href="#cb7-1303" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(Vol1, <span class="at">by=</span><span class="st">"YEAR"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1304"><a href="#cb7-1304" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Return_main=</span>Return,</span>
<span id="cb7-1305"><a href="#cb7-1305" aria-hidden="true" tabindex="-1"></a>         <span class="at">Vol_main=</span>Vol) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1306"><a href="#cb7-1306" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(YEAR, Return_main,Vol_main,Return_K200,Vol_K200) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1307"><a href="#cb7-1307" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(table2 <span class="sc">%&gt;%</span> </span>
<span id="cb7-1308"><a href="#cb7-1308" aria-hidden="true" tabindex="-1"></a>              <span class="fu">select</span>(YEAR,Return) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1309"><a href="#cb7-1309" aria-hidden="true" tabindex="-1"></a>              <span class="fu">left_join</span>(Vol2, <span class="at">by=</span><span class="st">"YEAR"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1310"><a href="#cb7-1310" aria-hidden="true" tabindex="-1"></a>              <span class="fu">mutate</span>(<span class="at">Return_sub=</span>Return,</span>
<span id="cb7-1311"><a href="#cb7-1311" aria-hidden="true" tabindex="-1"></a>                     <span class="at">Vol_sub=</span>Vol) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1312"><a href="#cb7-1312" aria-hidden="true" tabindex="-1"></a>              <span class="fu">select</span>(YEAR,Return_sub,Vol_sub), <span class="at">by=</span><span class="st">"YEAR"</span>)</span>
<span id="cb7-1313"><a href="#cb7-1313" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb7-1314"><a href="#cb7-1314" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-1315"><a href="#cb7-1315" aria-hidden="true" tabindex="-1"></a><span class="fu">### R code 2 : 전략 검증</span></span>
<span id="cb7-1316"><a href="#cb7-1316" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-1319"><a href="#cb7-1319" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb7-1320"><a href="#cb7-1320" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb7-1321"><a href="#cb7-1321" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb7-1322"><a href="#cb7-1322" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb7-1323"><a href="#cb7-1323" aria-hidden="true" tabindex="-1"></a><span class="co">#| error: false</span></span>
<span id="cb7-1324"><a href="#cb7-1324" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list=</span><span class="fu">ls</span>())</span>
<span id="cb7-1325"><a href="#cb7-1325" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb7-1326"><a href="#cb7-1326" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(knitr)</span>
<span id="cb7-1327"><a href="#cb7-1327" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb7-1328"><a href="#cb7-1328" aria-hidden="true" tabindex="-1"></a><span class="fu">setwd</span>(<span class="st">"homepage/study_25spring/data/"</span>)</span>
<span id="cb7-1329"><a href="#cb7-1329" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-1330"><a href="#cb7-1330" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. 원본데이터 준비</span></span>
<span id="cb7-1331"><a href="#cb7-1331" aria-hidden="true" tabindex="-1"></a>options_raw <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"options_data_test.csv"</span>) <span class="sc">%&gt;%</span> <span class="fu">tibble</span>()</span>
<span id="cb7-1332"><a href="#cb7-1332" aria-hidden="true" tabindex="-1"></a>idx_raw <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"idx_data_test.csv"</span>) <span class="sc">%&gt;%</span> <span class="fu">tibble</span>()</span>
<span id="cb7-1333"><a href="#cb7-1333" aria-hidden="true" tabindex="-1"></a>mmf_raw <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"mmf_test.csv"</span>) <span class="sc">%&gt;%</span> <span class="fu">tibble</span>()</span>
<span id="cb7-1334"><a href="#cb7-1334" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-1335"><a href="#cb7-1335" aria-hidden="true" tabindex="-1"></a><span class="co"># 2-1. 데이터 전처리 : KRX openAPI 옵션데이터 전처리</span></span>
<span id="cb7-1336"><a href="#cb7-1336" aria-hidden="true" tabindex="-1"></a>options <span class="ot">&lt;-</span> options_raw <span class="sc">%&gt;%</span> </span>
<span id="cb7-1337"><a href="#cb7-1337" aria-hidden="true" tabindex="-1"></a>  <span class="co"># K200, WK200 이외의 옵션 제외</span></span>
<span id="cb7-1338"><a href="#cb7-1338" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">substr</span>(PROD_NM,<span class="dv">1</span>,<span class="dv">3</span>)<span class="sc">==</span><span class="st">"코스피"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb7-1339"><a href="#cb7-1339" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 종가가 없는 경우 익일 기준가격(이론가격) 사용</span></span>
<span id="cb7-1340"><a href="#cb7-1340" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">PRICE =</span> <span class="fu">as.double</span>(<span class="fu">if_else</span>(TDD_CLSPRC<span class="sc">==</span><span class="st">"-"</span>,NXTDD_BAS_PRC,TDD_CLSPRC))) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1341"><a href="#cb7-1341" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>(PRICE) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1342"><a href="#cb7-1342" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(BAS_DD,ISU_NM,PRICE,ACC_TRDVOL) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1343"><a href="#cb7-1343" aria-hidden="true" tabindex="-1"></a>  <span class="fu">separate</span>(ISU_NM, <span class="at">into=</span><span class="fu">c</span>(<span class="st">"PROD"</span>,<span class="st">"RGHT"</span>,<span class="st">"EXP"</span>,<span class="st">"EXER_PRC"</span>), <span class="at">sep=</span><span class="st">' '</span>) <span class="sc">%&gt;%</span></span>
<span id="cb7-1344"><a href="#cb7-1344" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">EXER_PRC=</span><span class="fu">as.double</span>(EXER_PRC),</span>
<span id="cb7-1345"><a href="#cb7-1345" aria-hidden="true" tabindex="-1"></a>         <span class="at">EXPMM=</span><span class="fu">if_else</span>(PROD<span class="sc">==</span><span class="st">"코스피200"</span>,<span class="fu">substr</span>(EXP,<span class="dv">3</span>,<span class="dv">6</span>),<span class="fu">substr</span>(EXP,<span class="dv">1</span>,<span class="dv">4</span>)),</span>
<span id="cb7-1346"><a href="#cb7-1346" aria-hidden="true" tabindex="-1"></a>         <span class="at">EXPWW=</span><span class="fu">if_else</span>(PROD<span class="sc">==</span><span class="st">"코스피200"</span>,<span class="dv">2</span>,<span class="fu">as.integer</span>(<span class="fu">substr</span>(EXP,<span class="dv">6</span>,<span class="dv">6</span>)))) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1347"><a href="#cb7-1347" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(EXER_PRC<span class="sc">&gt;</span><span class="fu">min</span>(idx_raw<span class="sc">$</span>KOSPI200)<span class="sc">*</span><span class="fl">0.85</span>,</span>
<span id="cb7-1348"><a href="#cb7-1348" aria-hidden="true" tabindex="-1"></a>         EXER_PRC<span class="sc">&lt;</span><span class="fu">max</span>(idx_raw<span class="sc">$</span>KOSPI200)<span class="sc">*</span><span class="fl">1.15</span>,</span>
<span id="cb7-1349"><a href="#cb7-1349" aria-hidden="true" tabindex="-1"></a>         PROD<span class="sc">!=</span><span class="st">"코스피위클리M"</span>) <span class="sc">%&gt;%</span> <span class="co"># 월요일 만기 위클리옵션 제외</span></span>
<span id="cb7-1350"><a href="#cb7-1350" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">PRIOR=</span><span class="fu">as.integer</span>(EXPMM)<span class="sc">*</span><span class="dv">10</span><span class="sc">+</span>EXPWW) <span class="co"># 만기가 짧은 순으로 우선순위 부여</span></span>
<span id="cb7-1351"><a href="#cb7-1351" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-1352"><a href="#cb7-1352" aria-hidden="true" tabindex="-1"></a><span class="co"># 2-2. 데이터 전처리 : 옵션 만기일 데이터 생성</span></span>
<span id="cb7-1353"><a href="#cb7-1353" aria-hidden="true" tabindex="-1"></a>target_date <span class="ot">&lt;-</span> options <span class="sc">%&gt;%</span> </span>
<span id="cb7-1354"><a href="#cb7-1354" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(.,BAS_DD, PRIOR) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1355"><a href="#cb7-1355" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(PRIOR, <span class="fu">desc</span>(BAS_DD)) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1356"><a href="#cb7-1356" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(PRIOR) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1357"><a href="#cb7-1357" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1358"><a href="#cb7-1358" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb7-1359"><a href="#cb7-1359" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(BAS_DD) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1360"><a href="#cb7-1360" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(BAS_DD)) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1361"><a href="#cb7-1361" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(BAS_DD<span class="sc">&lt;</span><span class="dv">20250411</span>)</span>
<span id="cb7-1362"><a href="#cb7-1362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-1363"><a href="#cb7-1363" aria-hidden="true" tabindex="-1"></a><span class="co"># 2-3. 데이터 전처리 : KRX 정보데이터시스템 K200 및 V-K200지수 전처리</span></span>
<span id="cb7-1364"><a href="#cb7-1364" aria-hidden="true" tabindex="-1"></a>idx_data <span class="ot">&lt;-</span> idx_raw <span class="sc">%&gt;%</span></span>
<span id="cb7-1365"><a href="#cb7-1365" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(BAS_DD) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1366"><a href="#cb7-1366" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">LAG_K200=</span><span class="fu">lag</span>(KOSPI200),</span>
<span id="cb7-1367"><a href="#cb7-1367" aria-hidden="true" tabindex="-1"></a>         <span class="at">LAG_VK200=</span><span class="fu">lag</span>(VKOSPI200))</span>
<span id="cb7-1368"><a href="#cb7-1368" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-1369"><a href="#cb7-1369" aria-hidden="true" tabindex="-1"></a>K200_portfolio<span class="ot">=</span>idx_data <span class="sc">%&gt;%</span> </span>
<span id="cb7-1370"><a href="#cb7-1370" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(mmf_raw, <span class="at">by=</span><span class="st">"BAS_DD"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1371"><a href="#cb7-1371" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">RATE=</span>(KOSPI200<span class="sc">-</span>LAG_K200)<span class="sc">/</span>LAG_K200,</span>
<span id="cb7-1372"><a href="#cb7-1372" aria-hidden="true" tabindex="-1"></a>         <span class="at">YEAR =</span> <span class="fu">substr</span>(BAS_DD, <span class="dv">1</span>, <span class="dv">4</span>),</span>
<span id="cb7-1373"><a href="#cb7-1373" aria-hidden="true" tabindex="-1"></a>         <span class="at">YM =</span> <span class="fu">ym</span>(<span class="fu">substr</span>(BAS_DD, <span class="dv">1</span>, <span class="dv">6</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb7-1374"><a href="#cb7-1374" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(YEAR) <span class="sc">%&gt;%</span></span>
<span id="cb7-1375"><a href="#cb7-1375" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">is.na</span>(RATE)<span class="sc">==</span><span class="cn">FALSE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1376"><a href="#cb7-1376" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">RATE_K200 =</span> <span class="fu">prod</span>(<span class="dv">1</span> <span class="sc">+</span> RATE),</span>
<span id="cb7-1377"><a href="#cb7-1377" aria-hidden="true" tabindex="-1"></a>            <span class="at">MMF =</span> <span class="fu">mean</span>(MMF)<span class="sc">/</span><span class="dv">100</span>,</span>
<span id="cb7-1378"><a href="#cb7-1378" aria-hidden="true" tabindex="-1"></a>            <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb7-1379"><a href="#cb7-1379" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb7-1380"><a href="#cb7-1380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-1381"><a href="#cb7-1381" aria-hidden="true" tabindex="-1"></a><span class="co"># 3-1. 포트폴리오 구성 : VW양매도 포트폴리오 기초정보 생성</span></span>
<span id="cb7-1382"><a href="#cb7-1382" aria-hidden="true" tabindex="-1"></a>target_info <span class="ot">&lt;-</span> target_date <span class="sc">%&gt;%</span> </span>
<span id="cb7-1383"><a href="#cb7-1383" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(options, <span class="at">by=</span><span class="st">"BAS_DD"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1384"><a href="#cb7-1384" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(BAS_DD,PRIOR) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1385"><a href="#cb7-1385" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(BAS_DD),PRIOR) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1386"><a href="#cb7-1386" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(BAS_DD) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1387"><a href="#cb7-1387" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 만기가 도래하는 옵션을 제외하고 우선순위가 높은 옵션 선택</span></span>
<span id="cb7-1388"><a href="#cb7-1388" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">2</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1389"><a href="#cb7-1389" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb7-1390"><a href="#cb7-1390" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(BAS_DD)) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1391"><a href="#cb7-1391" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(idx_data, <span class="at">by=</span><span class="st">"BAS_DD"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1392"><a href="#cb7-1392" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(mmf_raw, <span class="at">by=</span><span class="st">"BAS_DD"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1393"><a href="#cb7-1393" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 옵션 보유기간 및 단기금리(MMF) 계산</span></span>
<span id="cb7-1394"><a href="#cb7-1394" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">DIFF_DAY=</span><span class="fu">as.integer</span>(<span class="fu">ymd</span>(<span class="fu">lag</span>(BAS_DD))<span class="sc">-</span><span class="fu">ymd</span>(BAS_DD)),</span>
<span id="cb7-1395"><a href="#cb7-1395" aria-hidden="true" tabindex="-1"></a>         <span class="at">MMF=</span>MMF<span class="sc">*</span><span class="fl">0.01</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1396"><a href="#cb7-1396" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 옵션 보유기간에 해당하는 시장기대변동성 계산(V-K200활용)</span></span>
<span id="cb7-1397"><a href="#cb7-1397" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">VOL=</span>LAG_VK200<span class="sc">*</span><span class="fu">sqrt</span>(DIFF_DAY)<span class="sc">/</span><span class="fu">sqrt</span>(<span class="dv">365</span>)<span class="sc">/</span><span class="dv">100</span>) <span class="sc">%&gt;%</span></span>
<span id="cb7-1398"><a href="#cb7-1398" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 변동성에 따른 옵션 행사가격 상단(2.5단위 올림) 및 하단(2.5단위 내림) 계산</span></span>
<span id="cb7-1399"><a href="#cb7-1399" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">TARGET_C_K=</span><span class="fu">ceiling</span>(KOSPI200<span class="sc">*</span>(<span class="dv">1</span><span class="sc">+</span>VOL)<span class="sc">*</span><span class="fl">0.4</span>)<span class="sc">/</span><span class="fl">0.4</span>,</span>
<span id="cb7-1400"><a href="#cb7-1400" aria-hidden="true" tabindex="-1"></a>         <span class="at">TARGET_P_K=</span><span class="fu">floor</span>(KOSPI200<span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span>VOL)<span class="sc">*</span><span class="fl">0.4</span>)<span class="sc">/</span><span class="fl">0.4</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1401"><a href="#cb7-1401" aria-hidden="true" tabindex="-1"></a>  <span class="co"># drop_na(DIFF_DAY) %&gt;% </span></span>
<span id="cb7-1402"><a href="#cb7-1402" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(BAS_DD,VOL,DIFF_DAY,MMF,KOSPI200,LAG_VK200,PRIOR,TARGET_C_K,TARGET_P_K)</span>
<span id="cb7-1403"><a href="#cb7-1403" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-1404"><a href="#cb7-1404" aria-hidden="true" tabindex="-1"></a><span class="co"># 3-2. 포트폴리오 구성 : VW양매도 포트폴리오 거래대상 옵션 정보 생성</span></span>
<span id="cb7-1405"><a href="#cb7-1405" aria-hidden="true" tabindex="-1"></a>target_options <span class="ot">&lt;-</span> target_info <span class="sc">%&gt;%</span> </span>
<span id="cb7-1406"><a href="#cb7-1406" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(BAS_DD, PRIOR, TARGET_C_K, TARGET_P_K) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1407"><a href="#cb7-1407" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols=</span><span class="fu">c</span>(<span class="st">"TARGET_C_K"</span>,<span class="st">"TARGET_P_K"</span>),<span class="at">names_to =</span> <span class="st">"GRP"</span>, <span class="at">values_to =</span> <span class="st">"EXER_PRC"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1408"><a href="#cb7-1408" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">RGHT=</span><span class="fu">substr</span>(GRP,<span class="dv">8</span>,<span class="dv">8</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1409"><a href="#cb7-1409" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(options,<span class="at">by=</span><span class="fu">c</span>(<span class="st">"BAS_DD"</span>,<span class="st">"PRIOR"</span>,<span class="st">"RGHT"</span>,<span class="st">"EXER_PRC"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb7-1410"><a href="#cb7-1410" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(BAS_DD,GRP,PRICE,ACC_TRDVOL) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1411"><a href="#cb7-1411" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> <span class="st">"GRP"</span>, <span class="at">values_from =</span> <span class="fu">c</span>(<span class="st">"PRICE"</span>,<span class="st">"ACC_TRDVOL"</span>))</span>
<span id="cb7-1412"><a href="#cb7-1412" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-1413"><a href="#cb7-1413" aria-hidden="true" tabindex="-1"></a><span class="co"># 원금 100억원 가정</span></span>
<span id="cb7-1414"><a href="#cb7-1414" aria-hidden="true" tabindex="-1"></a>cash <span class="ot">=</span> <span class="dv">10000</span><span class="sc">*</span><span class="dv">10000</span><span class="sc">*</span><span class="dv">100</span></span>
<span id="cb7-1415"><a href="#cb7-1415" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-1416"><a href="#cb7-1416" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. 포트폴리오 구현 : VW양매도 전략을 구현하여 일자별 손익 계산</span></span>
<span id="cb7-1417"><a href="#cb7-1417" aria-hidden="true" tabindex="-1"></a>portfolio <span class="ot">&lt;-</span> target_info <span class="sc">%&gt;%</span> </span>
<span id="cb7-1418"><a href="#cb7-1418" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(target_options,<span class="at">by=</span><span class="st">"BAS_DD"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1419"><a href="#cb7-1419" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(BAS_DD) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1420"><a href="#cb7-1420" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 원금에 따른 옵션 매도수량 계산</span></span>
<span id="cb7-1421"><a href="#cb7-1421" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">SELL_AMT=</span>cash<span class="sc">/</span><span class="dv">250000</span><span class="sc">/</span>KOSPI200) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1422"><a href="#cb7-1422" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 옵션 프리미엄(매도수익)) 계산</span></span>
<span id="cb7-1423"><a href="#cb7-1423" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">PREMIUM=</span>SELL_AMT<span class="sc">*</span>(PRICE_TARGET_C_K<span class="sc">+</span>PRICE_TARGET_P_K)<span class="sc">*</span><span class="dv">250000</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1424"><a href="#cb7-1424" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 원금 및 프리미엄의 MMF 이자수익 및 권리행사손실 계산</span></span>
<span id="cb7-1425"><a href="#cb7-1425" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">INTEREST=</span>(cash<span class="sc">+</span><span class="fu">replace_na</span>(PREMIUM,<span class="dv">0</span>))<span class="sc">*</span>MMF<span class="sc">*</span>DIFF_DAY<span class="sc">/</span><span class="dv">365</span>,</span>
<span id="cb7-1426"><a href="#cb7-1426" aria-hidden="true" tabindex="-1"></a>         <span class="at">EXERCISE=</span>(<span class="fu">if_else</span>(<span class="fu">lead</span>(KOSPI200)<span class="sc">-</span>TARGET_C_K<span class="sc">&gt;</span><span class="dv">0</span>,<span class="fu">lead</span>(KOSPI200)<span class="sc">-</span>TARGET_C_K,<span class="dv">0</span>)<span class="sc">+</span></span>
<span id="cb7-1427"><a href="#cb7-1427" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">if_else</span>(TARGET_P_K<span class="sc">-</span><span class="fu">lead</span>(KOSPI200)<span class="sc">&gt;</span><span class="dv">0</span>,TARGET_P_K<span class="sc">-</span><span class="fu">lead</span>(KOSPI200),<span class="dv">0</span>))<span class="sc">*</span><span class="dv">250000</span><span class="sc">*</span>SELL_AMT) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1428"><a href="#cb7-1428" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 주단위 포트폴리오 손익 계산(원금 100억 가정, 당일 투자시 다음주 실현손익을 의미)</span></span>
<span id="cb7-1429"><a href="#cb7-1429" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">REVENUE=</span>PREMIUM<span class="sc">+</span>INTEREST<span class="sc">-</span>EXERCISE) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1430"><a href="#cb7-1430" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 거래대상 옵션이 상장되어있지 않은 경우, MMF수익만 고려</span></span>
<span id="cb7-1431"><a href="#cb7-1431" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">REVENUE=</span><span class="fu">if_else</span>(<span class="fu">is.na</span>(REVENUE),INTEREST,REVENUE)) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1432"><a href="#cb7-1432" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">RATE=</span>REVENUE<span class="sc">/</span>cash,</span>
<span id="cb7-1433"><a href="#cb7-1433" aria-hidden="true" tabindex="-1"></a>         <span class="at">Group=</span><span class="st">"Vol-adj. Weekly"</span>)  <span class="co"># 주단위 포트폴리오 수익률</span></span>
<span id="cb7-1434"><a href="#cb7-1434" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-1435"><a href="#cb7-1435" aria-hidden="true" tabindex="-1"></a><span class="co"># 5. 비교군 포트폴리오 생성 : 월별 5% OTM 양매도 전략</span></span>
<span id="cb7-1436"><a href="#cb7-1436" aria-hidden="true" tabindex="-1"></a>options2 <span class="ot">&lt;-</span> options <span class="sc">%&gt;%</span> </span>
<span id="cb7-1437"><a href="#cb7-1437" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(PROD<span class="sc">==</span><span class="st">"코스피200"</span>)</span>
<span id="cb7-1438"><a href="#cb7-1438" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-1439"><a href="#cb7-1439" aria-hidden="true" tabindex="-1"></a><span class="co"># 옵션 만기일(매달) 생성</span></span>
<span id="cb7-1440"><a href="#cb7-1440" aria-hidden="true" tabindex="-1"></a>target_date2 <span class="ot">&lt;-</span> options2 <span class="sc">%&gt;%</span> </span>
<span id="cb7-1441"><a href="#cb7-1441" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(.,BAS_DD, PRIOR) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1442"><a href="#cb7-1442" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(PRIOR, <span class="fu">desc</span>(BAS_DD)) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1443"><a href="#cb7-1443" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(PRIOR) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1444"><a href="#cb7-1444" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1445"><a href="#cb7-1445" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb7-1446"><a href="#cb7-1446" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(BAS_DD) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1447"><a href="#cb7-1447" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(BAS_DD)) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1448"><a href="#cb7-1448" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(BAS_DD<span class="sc">&lt;</span><span class="dv">20250411</span>)</span>
<span id="cb7-1449"><a href="#cb7-1449" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-1450"><a href="#cb7-1450" aria-hidden="true" tabindex="-1"></a><span class="co"># 일반 양매도 포트폴리오 기본 정보 생성</span></span>
<span id="cb7-1451"><a href="#cb7-1451" aria-hidden="true" tabindex="-1"></a>target_info2 <span class="ot">&lt;-</span> target_date2 <span class="sc">%&gt;%</span> </span>
<span id="cb7-1452"><a href="#cb7-1452" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(options2, <span class="at">by=</span><span class="st">"BAS_DD"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1453"><a href="#cb7-1453" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(BAS_DD,PRIOR) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1454"><a href="#cb7-1454" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(BAS_DD),PRIOR) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1455"><a href="#cb7-1455" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(BAS_DD) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1456"><a href="#cb7-1456" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 만기가 도래하는 옵션을 제외하고 우선순위가 높은 옵션 선택</span></span>
<span id="cb7-1457"><a href="#cb7-1457" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">2</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1458"><a href="#cb7-1458" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb7-1459"><a href="#cb7-1459" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(BAS_DD)) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1460"><a href="#cb7-1460" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(idx_data, <span class="at">by=</span><span class="st">"BAS_DD"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1461"><a href="#cb7-1461" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(mmf_raw, <span class="at">by=</span><span class="st">"BAS_DD"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1462"><a href="#cb7-1462" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 옵션 보유기간 및 단기금리(MMF) 계산</span></span>
<span id="cb7-1463"><a href="#cb7-1463" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">DIFF_DAY=</span><span class="fu">as.integer</span>(<span class="fu">ymd</span>(<span class="fu">lag</span>(BAS_DD))<span class="sc">-</span><span class="fu">ymd</span>(BAS_DD)),</span>
<span id="cb7-1464"><a href="#cb7-1464" aria-hidden="true" tabindex="-1"></a>         <span class="at">MMF=</span>MMF<span class="sc">*</span><span class="fl">0.01</span>,</span>
<span id="cb7-1465"><a href="#cb7-1465" aria-hidden="true" tabindex="-1"></a>         <span class="at">VOL=</span><span class="fl">0.05</span>) <span class="sc">%&gt;%</span></span>
<span id="cb7-1466"><a href="#cb7-1466" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 변동성에 따른 옵션 행사가격 상단(2.5단위 올림) 및 하단(2.5단위 내림) 계산</span></span>
<span id="cb7-1467"><a href="#cb7-1467" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">TARGET_C_K=</span><span class="fu">ceiling</span>(KOSPI200<span class="sc">*</span>(<span class="dv">1</span><span class="sc">+</span>VOL)<span class="sc">*</span><span class="fl">0.4</span>)<span class="sc">/</span><span class="fl">0.4</span>,</span>
<span id="cb7-1468"><a href="#cb7-1468" aria-hidden="true" tabindex="-1"></a>         <span class="at">TARGET_P_K=</span><span class="fu">floor</span>(KOSPI200<span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span>VOL)<span class="sc">*</span><span class="fl">0.4</span>)<span class="sc">/</span><span class="fl">0.4</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1469"><a href="#cb7-1469" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">DIFF_DAY=</span><span class="fu">if_else</span>(<span class="fu">is.na</span>(DIFF_DAY),<span class="dv">28</span>,DIFF_DAY)) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1470"><a href="#cb7-1470" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(BAS_DD,VOL,DIFF_DAY,MMF,KOSPI200,LAG_VK200,PRIOR,TARGET_C_K,TARGET_P_K)</span>
<span id="cb7-1471"><a href="#cb7-1471" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-1472"><a href="#cb7-1472" aria-hidden="true" tabindex="-1"></a><span class="co"># 일반 양매도 포트폴리오 거래대상 옵션</span></span>
<span id="cb7-1473"><a href="#cb7-1473" aria-hidden="true" tabindex="-1"></a>target_options2 <span class="ot">&lt;-</span> target_info2 <span class="sc">%&gt;%</span> </span>
<span id="cb7-1474"><a href="#cb7-1474" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(BAS_DD, PRIOR, TARGET_C_K, TARGET_P_K) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1475"><a href="#cb7-1475" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols=</span><span class="fu">c</span>(<span class="st">"TARGET_C_K"</span>,<span class="st">"TARGET_P_K"</span>),<span class="at">names_to =</span> <span class="st">"GRP"</span>, <span class="at">values_to =</span> <span class="st">"EXER_PRC"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1476"><a href="#cb7-1476" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">RGHT=</span><span class="fu">substr</span>(GRP,<span class="dv">8</span>,<span class="dv">8</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1477"><a href="#cb7-1477" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(options2,<span class="at">by=</span><span class="fu">c</span>(<span class="st">"BAS_DD"</span>,<span class="st">"PRIOR"</span>,<span class="st">"RGHT"</span>,<span class="st">"EXER_PRC"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb7-1478"><a href="#cb7-1478" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(BAS_DD,GRP,PRICE,ACC_TRDVOL) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1479"><a href="#cb7-1479" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> <span class="st">"GRP"</span>, <span class="at">values_from =</span> <span class="fu">c</span>(<span class="st">"PRICE"</span>,<span class="st">"ACC_TRDVOL"</span>))</span>
<span id="cb7-1480"><a href="#cb7-1480" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-1481"><a href="#cb7-1481" aria-hidden="true" tabindex="-1"></a><span class="co"># 일반 양매도 포트폴리오 구현</span></span>
<span id="cb7-1482"><a href="#cb7-1482" aria-hidden="true" tabindex="-1"></a>portfolio2 <span class="ot">&lt;-</span> target_info2 <span class="sc">%&gt;%</span> </span>
<span id="cb7-1483"><a href="#cb7-1483" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(target_options2,<span class="at">by=</span><span class="st">"BAS_DD"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1484"><a href="#cb7-1484" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(BAS_DD) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1485"><a href="#cb7-1485" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 원금에 따른 옵션 매도수량 계산</span></span>
<span id="cb7-1486"><a href="#cb7-1486" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">SELL_AMT=</span>cash<span class="sc">/</span><span class="dv">250000</span><span class="sc">/</span>KOSPI200) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1487"><a href="#cb7-1487" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 옵션 프리미엄(매도수익)) 계산</span></span>
<span id="cb7-1488"><a href="#cb7-1488" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">PREMIUM=</span>SELL_AMT<span class="sc">*</span>(PRICE_TARGET_C_K<span class="sc">+</span>PRICE_TARGET_P_K)<span class="sc">*</span><span class="dv">250000</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1489"><a href="#cb7-1489" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 원금 및 프리미엄의 MMF 이자수익 및 권리행사손실 계산</span></span>
<span id="cb7-1490"><a href="#cb7-1490" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">INTEREST=</span>(cash<span class="sc">+</span><span class="fu">replace_na</span>(PREMIUM,<span class="dv">0</span>))<span class="sc">*</span>MMF<span class="sc">*</span>DIFF_DAY<span class="sc">/</span><span class="dv">365</span>,</span>
<span id="cb7-1491"><a href="#cb7-1491" aria-hidden="true" tabindex="-1"></a>         <span class="at">EXERCISE=</span>(<span class="fu">if_else</span>(<span class="fu">lead</span>(KOSPI200)<span class="sc">-</span>TARGET_C_K<span class="sc">&gt;</span><span class="dv">0</span>,<span class="fu">lead</span>(KOSPI200)<span class="sc">-</span>TARGET_C_K,<span class="dv">0</span>)<span class="sc">+</span></span>
<span id="cb7-1492"><a href="#cb7-1492" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">if_else</span>(TARGET_P_K<span class="sc">-</span><span class="fu">lead</span>(KOSPI200)<span class="sc">&gt;</span><span class="dv">0</span>,TARGET_P_K<span class="sc">-</span><span class="fu">lead</span>(KOSPI200),<span class="dv">0</span>))<span class="sc">*</span><span class="dv">250000</span><span class="sc">*</span>SELL_AMT) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1493"><a href="#cb7-1493" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">EXERCISE=</span><span class="fu">if_else</span>(<span class="fu">is.na</span>(EXERCISE),<span class="dv">0</span>,EXERCISE)) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1494"><a href="#cb7-1494" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 주단위 포트폴리오 손익 계산(원금 100억 가정, 당일 투자시 다음주 실현손익을 의미)</span></span>
<span id="cb7-1495"><a href="#cb7-1495" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">REVENUE=</span>PREMIUM<span class="sc">+</span>INTEREST<span class="sc">-</span>EXERCISE) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1496"><a href="#cb7-1496" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 거래대상 옵션이 상장되어있지 않은 경우, MMF수익만 고려</span></span>
<span id="cb7-1497"><a href="#cb7-1497" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">REVENUE=</span><span class="fu">if_else</span>(<span class="fu">is.na</span>(REVENUE),INTEREST,REVENUE)) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1498"><a href="#cb7-1498" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">RATE=</span>REVENUE<span class="sc">/</span>cash,</span>
<span id="cb7-1499"><a href="#cb7-1499" aria-hidden="true" tabindex="-1"></a>         <span class="at">Group=</span><span class="st">"Monthly"</span>) <span class="co"># 주단위 포트폴리오 수익률</span></span>
<span id="cb7-1500"><a href="#cb7-1500" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-1501"><a href="#cb7-1501" aria-hidden="true" tabindex="-1"></a>portfolio <span class="ot">&lt;-</span> portfolio <span class="sc">%&gt;%</span> <span class="fu">filter</span>(BAS_DD<span class="sc">!=</span><span class="dv">20250410</span>)</span>
<span id="cb7-1502"><a href="#cb7-1502" aria-hidden="true" tabindex="-1"></a>portfolio2 <span class="ot">&lt;-</span> portfolio2 <span class="sc">%&gt;%</span> <span class="fu">filter</span>(BAS_DD<span class="sc">!=</span><span class="dv">20250410</span>)</span>
<span id="cb7-1503"><a href="#cb7-1503" aria-hidden="true" tabindex="-1"></a>portfolio3 <span class="ot">&lt;-</span> portfolio <span class="sc">%&gt;%</span> </span>
<span id="cb7-1504"><a href="#cb7-1504" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.numeric), sum)) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1505"><a href="#cb7-1505" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Group=</span><span class="st">"Vol-adj. Weekly Sum"</span>)</span>
<span id="cb7-1506"><a href="#cb7-1506" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-1507"><a href="#cb7-1507" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-1508"><a href="#cb7-1508" aria-hidden="true" tabindex="-1"></a><span class="co"># 요약표 4 : 검증 자료</span></span>
<span id="cb7-1509"><a href="#cb7-1509" aria-hidden="true" tabindex="-1"></a>table4 <span class="ot">&lt;-</span> portfolio <span class="sc">%&gt;%</span></span>
<span id="cb7-1510"><a href="#cb7-1510" aria-hidden="true" tabindex="-1"></a>  <span class="fu">union_all</span>(portfolio2) <span class="sc">%&gt;%</span></span>
<span id="cb7-1511"><a href="#cb7-1511" aria-hidden="true" tabindex="-1"></a>  <span class="fu">union_all</span>(portfolio3) <span class="sc">%&gt;%</span> </span>
<span id="cb7-1512"><a href="#cb7-1512" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(BAS_DD, Group) <span class="sc">%&gt;%</span></span>
<span id="cb7-1513"><a href="#cb7-1513" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">Premium =</span> <span class="fu">round</span>(<span class="fu">mean</span>(PREMIUM)<span class="sc">/</span><span class="dv">10000</span>,<span class="dv">0</span>),</span>
<span id="cb7-1514"><a href="#cb7-1514" aria-hidden="true" tabindex="-1"></a>            <span class="at">Interest =</span> <span class="fu">round</span>(<span class="fu">mean</span>(INTEREST)<span class="sc">/</span><span class="dv">10000</span>,<span class="dv">0</span>),</span>
<span id="cb7-1515"><a href="#cb7-1515" aria-hidden="true" tabindex="-1"></a>            <span class="at">Loss =</span> <span class="fu">round</span>(<span class="fu">mean</span>(EXERCISE)<span class="sc">/</span><span class="dv">10000</span>,<span class="dv">0</span>),</span>
<span id="cb7-1516"><a href="#cb7-1516" aria-hidden="true" tabindex="-1"></a>            <span class="at">Revenue =</span> <span class="fu">round</span>(<span class="fu">mean</span>(REVENUE)<span class="sc">/</span><span class="dv">10000</span>,<span class="dv">0</span>),</span>
<span id="cb7-1517"><a href="#cb7-1517" aria-hidden="true" tabindex="-1"></a>            <span class="at">Return =</span> <span class="fu">round</span>(<span class="fu">prod</span>(<span class="dv">1</span> <span class="sc">+</span> RATE)<span class="sc">-</span><span class="dv">1</span>,<span class="dv">2</span>),</span>
<span id="cb7-1518"><a href="#cb7-1518" aria-hidden="true" tabindex="-1"></a>            <span class="at">.groups =</span> <span class="st">"drop"</span>)</span>
<span id="cb7-1519"><a href="#cb7-1519" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-1520"><a href="#cb7-1520" aria-hidden="true" tabindex="-1"></a><span class="co"># 그래프 4 : 검증기간중 코스피200지수 추이</span></span>
<span id="cb7-1521"><a href="#cb7-1521" aria-hidden="true" tabindex="-1"></a>graph4 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(idx_raw, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">ymd</span>(BAS_DD))) <span class="sc">+</span></span>
<span id="cb7-1522"><a href="#cb7-1522" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> KOSPI200, <span class="at">color =</span> <span class="st">"KOSPI200"</span>), <span class="at">size =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb7-1523"><a href="#cb7-1523" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> (VKOSPI200 <span class="sc">-</span> <span class="dv">19</span>) <span class="sc">/</span> <span class="dv">26</span> <span class="sc">*</span> <span class="dv">60</span> <span class="sc">+</span> <span class="dv">300</span>, <span class="at">color =</span> <span class="st">"VKOSPI200"</span>), <span class="at">size =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb7-1524"><a href="#cb7-1524" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fu">ymd</span>(<span class="fu">c</span>(<span class="st">"20250313"</span>, <span class="st">"20250320"</span>, <span class="st">"20250327"</span>, <span class="st">"20250403"</span>,<span class="st">"20250410"</span>)),</span>
<span id="cb7-1525"><a href="#cb7-1525" aria-hidden="true" tabindex="-1"></a>             <span class="at">linetype =</span> <span class="st">"dotted"</span>, <span class="at">color =</span> <span class="st">"grey40"</span>) <span class="sc">+</span></span>
<span id="cb7-1526"><a href="#cb7-1526" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">name =</span> <span class="st">"KOSPI200"</span>,<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">300</span>, <span class="dv">360</span>),</span>
<span id="cb7-1527"><a href="#cb7-1527" aria-hidden="true" tabindex="-1"></a>                     <span class="at">sec.axis =</span> <span class="fu">sec_axis</span>(</span>
<span id="cb7-1528"><a href="#cb7-1528" aria-hidden="true" tabindex="-1"></a>                       <span class="sc">~</span> (.<span class="sc">-</span><span class="dv">300</span>) <span class="sc">/</span> <span class="dv">60</span> <span class="sc">*</span> <span class="dv">26</span> <span class="sc">+</span> <span class="dv">19</span>, <span class="at">name =</span> <span class="st">"VKOSPI200"</span>)) <span class="sc">+</span></span>
<span id="cb7-1529"><a href="#cb7-1529" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"KOSPI200"</span> <span class="ot">=</span> <span class="st">"blue"</span>, <span class="st">"VKOSPI200"</span> <span class="ot">=</span> <span class="st">"red"</span>),</span>
<span id="cb7-1530"><a href="#cb7-1530" aria-hidden="true" tabindex="-1"></a>                     <span class="at">guide =</span> <span class="fu">guide_legend</span>(<span class="at">direction =</span> <span class="st">"horizontal"</span>)) <span class="sc">+</span></span>
<span id="cb7-1531"><a href="#cb7-1531" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Kospi200 &amp; V-Kospi200 indices"</span>,<span class="at">x =</span> <span class="cn">NULL</span>,<span class="at">color =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb7-1532"><a href="#cb7-1532" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb7-1533"><a href="#cb7-1533" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_date</span>(<span class="at">date_breaks =</span> <span class="st">"3 days"</span>, <span class="at">date_labels =</span> <span class="st">"%m-%d"</span>) <span class="sc">+</span></span>
<span id="cb7-1534"><a href="#cb7-1534" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>),</span>
<span id="cb7-1535"><a href="#cb7-1535" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">0.95</span>))</span>
<span id="cb7-1536"><a href="#cb7-1536" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>